(()=>{var Ro=Object.defineProperty;var ve=(t,e)=>()=>(t&&(e=t(t=0)),e);var De=(t,e)=>{for(var o in e)Ro(t,o,{get:e[o],enumerable:!0})};var pe,Ce,Fo,qo,Uo,ut,_,D,eo,to,pt,Dn,_o,zo,Vo,Ho,mt,On,oo,no,ft,jn,X=ve(()=>{(function(t){t.Unimplemented="UNIMPLEMENTED",t.Unavailable="UNAVAILABLE"})(pe||(pe={}));Ce=class extends Error{constructor(e,o,n){super(e),this.message=e,this.code=o,this.data=n}},Fo=t=>{var e,o;return t?.androidBridge?"android":!((o=(e=t?.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||o===void 0)&&o.bridge?"ios":"web"},qo=t=>{let e=t.CapacitorCustomPlatform||null,o=t.Capacitor||{},n=o.Plugins=o.Plugins||{},a=()=>e!==null?e.name:Fo(t),i=()=>a()!=="web",r=u=>{let l=d.get(u);return!!(l?.platforms.has(a())||s(u))},s=u=>{var l;return(l=o.PluginHeaders)===null||l===void 0?void 0:l.find(m=>m.name===u)},c=u=>t.console.error(u),d=new Map,b=(u,l={})=>{let m=d.get(u);if(m)return console.warn(`Capacitor plugin "${u}" already registered. Cannot register plugins twice.`),m.proxy;let h=a(),g=s(u),p,v=async()=>(!p&&h in l?p=typeof l[h]=="function"?p=await l[h]():p=l[h]:e!==null&&!p&&"web"in l&&(p=typeof l.web=="function"?p=await l.web():p=l.web),p),k=(w,M)=>{var R,j;if(g){let K=g?.methods.find(F=>M===F.name);if(K)return K.rtype==="promise"?F=>o.nativePromise(u,M.toString(),F):(F,ne)=>o.nativeCallback(u,M.toString(),F,ne);if(w)return(R=w[M])===null||R===void 0?void 0:R.bind(w)}else{if(w)return(j=w[M])===null||j===void 0?void 0:j.bind(w);throw new Ce(`"${u}" plugin is not implemented on ${h}`,pe.Unimplemented)}},Z=w=>{let M,R=(...j)=>{let K=v().then(F=>{let ne=k(F,w);if(ne){let Re=ne(...j);return M=Re?.remove,Re}else throw new Ce(`"${u}.${w}()" is not implemented on ${h}`,pe.Unimplemented)});return w==="addListener"&&(K.remove=async()=>M()),K};return R.toString=()=>`${w.toString()}() { [capacitor code] }`,Object.defineProperty(R,"name",{value:w,writable:!1,configurable:!1}),R},be=Z("addListener"),N=Z("removeListener"),Ne=(w,M)=>{let R=be({eventName:w},M),j=async()=>{let F=await R;N({eventName:w,callbackId:F},M)},K=new Promise(F=>R.then(()=>F({remove:j})));return K.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await j()},K},oe=new Proxy({},{get(w,M){switch(M){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return g?Ne:be;case"removeListener":return N;default:return Z(M)}}});return n[u]=oe,d.set(u,{name:u,proxy:oe,platforms:new Set([...Object.keys(l),...g?[h]:[]])}),oe};return o.convertFileSrc||(o.convertFileSrc=u=>u),o.getPlatform=a,o.handleError=c,o.isNativePlatform=i,o.isPluginAvailable=r,o.registerPlugin=b,o.Exception=Ce,o.DEBUG=!!o.DEBUG,o.isLoggingEnabled=!!o.isLoggingEnabled,o},Uo=t=>t.Capacitor=qo(t),ut=Uo(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),_=ut.registerPlugin,D=class{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,o){let n=!1;this.listeners[e]||(this.listeners[e]=[],n=!0),this.listeners[e].push(o);let i=this.windowListeners[e];i&&!i.registered&&this.addWindowListener(i),n&&this.sendRetainedArgumentsForEvent(e);let r=async()=>this.removeListener(e,o);return Promise.resolve({remove:r})}async removeAllListeners(){this.listeners={};for(let e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,o,n){let a=this.listeners[e];if(!a){if(n){let i=this.retainedEventArguments[e];i||(i=[]),i.push(o),this.retainedEventArguments[e]=i}return}a.forEach(i=>i(o))}hasListeners(e){var o;return!!(!((o=this.listeners[e])===null||o===void 0)&&o.length)}registerWindowListener(e,o){this.windowListeners[o]={registered:!1,windowEventName:e,pluginEventName:o,handler:n=>{this.notifyListeners(o,n)}}}unimplemented(e="not implemented"){return new ut.Exception(e,pe.Unimplemented)}unavailable(e="not available"){return new ut.Exception(e,pe.Unavailable)}async removeListener(e,o){let n=this.listeners[e];if(!n)return;let a=n.indexOf(o);this.listeners[e].splice(a,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){let o=this.retainedEventArguments[e];o&&(delete this.retainedEventArguments[e],o.forEach(n=>{this.notifyListeners(e,n)}))}},eo=t=>encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),to=t=>t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),pt=class extends D{async getCookies(){let e=document.cookie,o={};return e.split(";").forEach(n=>{if(n.length<=0)return;let[a,i]=n.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");a=to(a).trim(),i=to(i).trim(),o[a]=i}),o}async setCookie(e){try{let o=eo(e.key),n=eo(e.value),a=`; expires=${(e.expires||"").replace("expires=","")}`,i=(e.path||"/").replace("path=",""),r=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${o}=${n||""}${a}; path=${i}; ${r};`}catch(o){return Promise.reject(o)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(o){return Promise.reject(o)}}async clearCookies(){try{let e=document.cookie.split(";")||[];for(let o of e)document.cookie=o.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}},Dn=_("CapacitorCookies",{web:()=>new pt}),_o=async t=>new Promise((e,o)=>{let n=new FileReader;n.onload=()=>{let a=n.result;e(a.indexOf(",")>=0?a.split(",")[1]:a)},n.onerror=a=>o(a),n.readAsDataURL(t)}),zo=(t={})=>{let e=Object.keys(t);return Object.keys(t).map(a=>a.toLocaleLowerCase()).reduce((a,i,r)=>(a[i]=t[e[r]],a),{})},Vo=(t,e=!0)=>t?Object.entries(t).reduce((n,a)=>{let[i,r]=a,s,c;return Array.isArray(r)?(c="",r.forEach(d=>{s=e?encodeURIComponent(d):d,c+=`${i}=${s}&`}),c.slice(0,-1)):(s=e?encodeURIComponent(r):r,c=`${i}=${s}`),`${n}&${c}`},"").substr(1):null,Ho=(t,e={})=>{let o=Object.assign({method:t.method||"GET",headers:t.headers},e),a=zo(t.headers)["content-type"]||"";if(typeof t.data=="string")o.body=t.data;else if(a.includes("application/x-www-form-urlencoded")){let i=new URLSearchParams;for(let[r,s]of Object.entries(t.data||{}))i.set(r,s);o.body=i.toString()}else if(a.includes("multipart/form-data")||t.data instanceof FormData){let i=new FormData;if(t.data instanceof FormData)t.data.forEach((s,c)=>{i.append(c,s)});else for(let s of Object.keys(t.data))i.append(s,t.data[s]);o.body=i;let r=new Headers(o.headers);r.delete("content-type"),o.headers=r}else(a.includes("application/json")||typeof t.data=="object")&&(o.body=JSON.stringify(t.data));return o},mt=class extends D{async request(e){let o=Ho(e,e.webFetchExtra),n=Vo(e.params,e.shouldEncodeUrlParams),a=n?`${e.url}?${n}`:e.url,i=await fetch(a,o),r=i.headers.get("content-type")||"",{responseType:s="text"}=i.ok?e:{};r.includes("application/json")&&(s="json");let c,d;switch(s){case"arraybuffer":case"blob":d=await i.blob(),c=await _o(d);break;case"json":c=await i.json();break;default:c=await i.text()}let b={};return i.headers.forEach((u,l)=>{b[l]=u}),{data:c,headers:b,status:i.status,url:i.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}},On=_("CapacitorHttp",{web:()=>new mt});(function(t){t.Dark="DARK",t.Light="LIGHT",t.Default="DEFAULT"})(oo||(oo={}));(function(t){t.StatusBar="StatusBar",t.NavigationBar="NavigationBar"})(no||(no={}));ft=class extends D{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}},jn=_("SystemBars",{web:()=>new ft})});var ao={};De(ao,{KeepAwakeWeb:()=>gt});var gt,io=ve(()=>{X();gt=class extends D{constructor(){super(...arguments),this.wakeLock=null,this._isSupported=typeof navigator<"u"&&"wakeLock"in navigator,this.handleVisibilityChange=()=>{document.visibilityState==="visible"&&this.keepAwake()}}async keepAwake(){this._isSupported||this.throwUnsupportedError(),this.wakeLock&&await this.allowSleep(),this.wakeLock=await navigator.wakeLock.request("screen"),document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange)}async allowSleep(){var e;this._isSupported||this.throwUnsupportedError(),(e=this.wakeLock)===null||e===void 0||e.release(),this.wakeLock=null,document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange)}async isSupported(){return{isSupported:this._isSupported}}async isKeptAwake(){return this._isSupported||this.throwUnsupportedError(),{isKeptAwake:!!this.wakeLock}}throwUnsupportedError(){throw this.unavailable("Screen Wake Lock API not available in this browser.")}}});var so={};De(so,{Geolocation:()=>Ko,GeolocationWeb:()=>He});var He,Ko,co=ve(()=>{X();He=class extends D{async getCurrentPosition(e){return new Promise((o,n)=>{navigator.geolocation.getCurrentPosition(a=>{o(a)},a=>{n(a)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0},e))})}async watchPosition(e,o){return`${navigator.geolocation.watchPosition(a=>{o(a)},a=>{o(null,a)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0,minimumUpdateInterval:5e3},e))}`}async clearWatch(e){navigator.geolocation.clearWatch(parseInt(e.id,10))}async checkPermissions(){if(typeof navigator>"u"||!navigator.permissions)throw this.unavailable("Permissions API not available in this browser");let e=await navigator.permissions.query({name:"geolocation"});return{location:e.state,coarseLocation:e.state}}async requestPermissions(){throw this.unimplemented("Not implemented on web.")}},Ko=new He});var uo={};De(uo,{LocalNotificationsWeb:()=>vt});var vt,po=ve(()=>{X();vt=class extends D{constructor(){super(...arguments),this.pending=[],this.deliveredNotifications=[],this.hasNotificationSupport=()=>{if(!("Notification"in window)||!Notification.requestPermission)return!1;if(Notification.permission!=="granted")try{new Notification("")}catch(e){if(e instanceof Error&&e.name==="TypeError")return!1}return!0}}async getDeliveredNotifications(){let e=[];for(let o of this.deliveredNotifications){let n={title:o.title,id:parseInt(o.tag),body:o.body};e.push(n)}return{notifications:e}}async removeDeliveredNotifications(e){for(let o of e.notifications){let n=this.deliveredNotifications.find(a=>a.tag===String(o.id));n?.close(),this.deliveredNotifications=this.deliveredNotifications.filter(()=>!n)}}async removeAllDeliveredNotifications(){for(let e of this.deliveredNotifications)e.close();this.deliveredNotifications=[]}async createChannel(){throw this.unimplemented("Not implemented on web.")}async deleteChannel(){throw this.unimplemented("Not implemented on web.")}async listChannels(){throw this.unimplemented("Not implemented on web.")}async schedule(e){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");for(let o of e.notifications)this.sendNotification(o);return{notifications:e.notifications.map(o=>({id:o.id}))}}async getPending(){return{notifications:this.pending}}async registerActionTypes(){throw this.unimplemented("Not implemented on web.")}async cancel(e){this.pending=this.pending.filter(o=>!e.notifications.find(n=>n.id===o.id))}async areEnabled(){let{display:e}=await this.checkPermissions();return{value:e==="granted"}}async changeExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async checkExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async requestPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(await Notification.requestPermission())}}async checkPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(Notification.permission)}}transformNotificationPermission(e){switch(e){case"granted":return"granted";case"denied":return"denied";default:return"prompt"}}sendPending(){var e;let o=[],n=new Date().getTime();for(let a of this.pending)!((e=a.schedule)===null||e===void 0)&&e.at&&a.schedule.at.getTime()<=n&&(this.buildNotification(a),o.push(a));this.pending=this.pending.filter(a=>!o.find(i=>i===a))}sendNotification(e){var o;if(!((o=e.schedule)===null||o===void 0)&&o.at){let n=e.schedule.at.getTime()-new Date().getTime();this.pending.push(e),setTimeout(()=>{this.sendPending()},n);return}this.buildNotification(e)}buildNotification(e){let o=new Notification(e.title,{body:e.body,tag:String(e.id)});return o.addEventListener("click",this.onClick.bind(this,e),!1),o.addEventListener("show",this.onShow.bind(this,e),!1),o.addEventListener("close",()=>{this.deliveredNotifications=this.deliveredNotifications.filter(()=>!this)},!1),this.deliveredNotifications.push(o),o}onClick(e){let o={actionId:"tap",notification:e};this.notifyListeners("localNotificationActionPerformed",o)}onShow(e){this.notifyListeners("localNotificationReceived",e)}}});var mo={};De(mo,{DialogWeb:()=>Lt});var Lt,fo=ve(()=>{X();Lt=class extends D{async alert(e){window.alert(e.message)}async prompt(e){let o=window.prompt(e.message,e.inputText||"");return{value:o!==null?o:"",cancelled:o===null}}async confirm(e){return{value:window.confirm(e.message)}}}});var H=null,Le=null,ye=null,S=null,f=null,je=null,Q=new Map;function _t(){return f=L.map("map",{zoomControl:!1}).setView([19.83,-90.528],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(f),L.control.zoom({position:"bottomright"}).addTo(f),S=L.layerGroup().addTo(f),je=L.layerGroup().addTo(f),f}var Oe=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-14]}),nt=L.divIcon({className:"icono-mapa-transbordo",html:'<i class="ri-arrow-left-right-line"></i>',iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-16]}),Ee=L.divIcon({className:"custom-div-icon",html:'<i class="ri-map-pin-fill unselectable icono-mapa-destino"></i>',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),Do=t=>L.divIcon({className:"bus-vivo-icono",html:`<span>${(t||"??").replace("koox-","")}</span>`,iconSize:[30,30],iconAnchor:[15,15]});function le(t){if(ye)return ye.setLatLng(t),ye;let e=L.divIcon({className:"user-gps-marker",iconSize:[20,20],iconAnchor:[10,10]});return ye=L.marker(t,{icon:e,zIndexOffset:1e3}).addTo(f),ye}function U(t,e=null){let o=t.properties.nombre||t.properties.Name,n=t.properties.originalIndex,a=(t.properties.rutas||[]).join(", "),i=`<div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">${o}</div>`;if(e){let r="#333";(e.includes("Subir")||e.includes("Inicio"))&&(r="#007bff"),e.includes("Transbordo")&&(r="#E69500"),(e.includes("Destino")||e.includes("Bajar"))&&(r="#dc3545"),i=`
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${r};">${e}</div>
            <div style="font-size: 1.0em; font-weight: bold; margin-bottom: 5px;">${o}</div>`}return`
        ${i}
        <strong style="font-size: 0.9em;">Rutas:</strong>
        <p style="font-size: 0.9em; margin: 4px 0;">${a||"N/A"}</p>
        <button class="btn-popup btn-ver-rutas-paradero" data-paradero-id="${n}">
            Ver detalles
        </button>
    `}function Fe(t){let e=[];if(t.forEach(n=>{n.filter(i=>i.tipo==="bus").forEach(i=>{e.push(i.ruta)})}),e.length===0)return;let o=turf.featureCollection(e);H=L.geoJSON(o,{style:n=>{let a="#"+Math.floor(Math.random()*16777215).toString(16);return t.length===1&&(a="#0052FF"),{color:a,weight:5,opacity:.7}}}).addTo(f),H.getBounds().isValid()&&f.fitBounds(H.getBounds().pad(.1))}function de(){H&&(f.removeLayer(H),H=null),Le&&(f.hasLayer(Le)&&f.removeLayer(Le),Le=null)}function zt(t,e){de(),S.clearLayers();let o=e.geometry.coordinates,n=[o[1],o[0]],a;switch(t.tipo){case"caminar":let i=t.paradero.geometry.coordinates,r=[i[1],i[0]];Le=L.polyline([n,r],{color:"#666",dashArray:"5, 10",weight:4}).addTo(f),L.marker(r,{icon:Oe}).addTo(S).bindPopup(U(t.paradero,"Dir\xEDgete aqu\xED")),a=L.latLngBounds(n,r);break;case"bus":H=L.geoJSON(t.ruta,{style:{color:"#0052FF",weight:6}}).addTo(f);let s=[t.paraderoInicio.geometry.coordinates[1],t.paraderoInicio.geometry.coordinates[0]],c=[t.paraderoFin.geometry.coordinates[1],t.paraderoFin.geometry.coordinates[0]];L.marker(s,{icon:Oe}).addTo(S).bindPopup(U(t.paraderoInicio,"Subir aqu\xED")),L.marker(c,{icon:Ee}).addTo(S).bindPopup(U(t.paraderoFin,"Bajar aqu\xED")),a=H.getBounds();break;case"transbordo":let d=[t.paradero.geometry.coordinates[1],t.paradero.geometry.coordinates[0]];L.marker(d,{icon:nt}).addTo(S).bindPopup(U(t.paradero,"Transbordo Aqu\xED")).openPopup(),f.setView(d,17);break;case"fin":let b=[t.paradero.geometry.coordinates[1],t.paradero.geometry.coordinates[0]];L.marker(b,{icon:Ee}).addTo(S).bindPopup(U(t.paradero,"\xA1Destino!")).openPopup(),f.setView(b,17);break}return a}function Vt(t,e){if(de(),S.clearLayers(),at(),!t)return;H=L.geoJSON(t,{style:{color:"#FF0000",weight:6,opacity:.8}}).addTo(f);let o=e.map(a=>{let i=a.geometry.coordinates,r=[i[1],i[0]],s=U(a),c=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-10]});return L.marker(r,{icon:c}).bindPopup(s)});o.forEach(a=>a.addTo(S));let n=L.featureGroup([H,...o]);n.getBounds().isValid()&&f.fitBounds(n.getBounds().pad(.1))}function Ht(t,e,o){if(!o||o.length<2||!f)return;let n=Do(e),a=`<b>Unidad ${t}</b><br>Ruta ${e}`,i={icon:n,zIndexOffset:1e3,rutaId:e};if(Q.has(t)){let r=Q.get(t);r.setLatLng(o),r.setIcon(n),r.getPopup().setContent(a),r.options.rutaId=e}else{let r=L.marker(o,i).addTo(je).bindPopup(a);Q.set(t,r)}}function Gt(t){Q.has(t)&&(je.removeLayer(Q.get(t)),Q.delete(t))}function at(){Q.forEach(t=>je.removeLayer(t)),Q.clear()}function qe(t,e){let o={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};return navigator.geolocation.watchPosition(t,e,o)}function we(t){t&&navigator.geolocation.clearWatch(t)}function Jt(t,e){let o=new Map;return t.forEach(n=>{o.set(n.properties.id,new Set)}),e.forEach(n=>{n.properties.rutas.forEach(a=>{o.has(a)&&o.get(a).add(n)})}),o}function ue(t,e,o,n,a){console.log(`Buscando rutas \xF3ptimas desde "${t.properties.nombre}" hasta "${e.properties.nombre}"`);let i=[],r=new Map,s=[],c=1/0,d=4,b=new Map;o.forEach(g=>{b.set(g.properties.originalIndex,g.properties.rutas)});let u=[{tipo:"caminar",paradero:t,texto:`Dir\xEDgete a ${t.properties.nombre}`}];for(r.set(t.properties.nombre,0),i.push(u);i.length>0;){let g=i.shift(),p=g[g.length-1],v=p.tipo==="caminar"?p.paradero:p.paraderoFin,k=g.filter(N=>N.tipo==="bus").length;if(k>=c||k>=d)continue;let Z=b.get(v.properties.originalIndex)||[],be=new Set(g.filter(N=>N.tipo==="bus").map(N=>N.ruta.properties.id));for(let N of Z){if(be.has(N))continue;let Ne=a.get(N),oe=n.find(w=>w.properties.id===N);if(!(!Ne||!oe))for(let w of Ne){if(w.properties.nombre===v.properties.nombre)continue;let M=k+1,R=r.get(w.properties.nombre);if(R&&R<M)continue;r.set(w.properties.nombre,M);let j={tipo:"bus",ruta:oe,paraderoInicio:v,paraderoFin:w,texto:`Toma ${oe.properties.id} y baja en ${w.properties.nombre}`};w.properties.nombre===e.properties.nombre?(j.texto+=" (Destino)",s.push([...g,j]),c=M):(b.get(w.properties.originalIndex)||[]).some(ne=>!be.has(ne)&&ne!==N)&&i.push([...g,j])}}}console.log(`B\xFAsqueda finalizada. Se encontraron ${s.length} soluciones (antes de filtrar).`);let l=s.filter(g=>g.filter(p=>p.tipo==="bus").length===c),m=new Map;l.forEach(g=>{let p=g.filter(v=>v.tipo==="bus").map(v=>v.ruta.properties.id).join("->");m.has(p)||m.set(p,g)});let h=Array.from(m.values());return console.log(`Se encontraron ${h.length} rutas \xF3ptimas \xFAnicas.`),h}function Kt(t,e){t.forEach(n=>{n.properties.rutas=[],e.forEach(a=>{if(a.geometry)try{let i=a;turf.nearestPointOnLine(i,n).properties.dist*1e3<25&&n.properties.rutas.push(a.properties.id)}catch(i){console.warn(`Advertencia Turf: Error al proyectar ${n.properties.nombre} en la ruta ${a.properties.id}.`,i)}})})}function it(){if(!window.driver||!window.driver.js)return;let t=window.driver.js.driver,e=document.getElementById("panel-control"),o=document.getElementById("panel-navegacion");e&&(e.classList.remove("oculto"),e.style.cssText=""),o&&o.classList.add("oculto");let n=document.getElementById("tour-phantom-anchor");n||(n=document.createElement("div"),n.id="tour-phantom-anchor",n.style.cssText=`
            position: absolute;  /* Usamos absolute para anclarlo al inicio de la p\xE1gina */
            top: 0;
            left: 0;
            width: 100%;
            height: 120px;       /* Altura reducida: Solo cubre el encabezado */
            z-index: 5001;  
            pointer-events: none;
            background: rgba(0,0,0,0); /* Transparente pero "existe" para el navegador */
        `,document.body.appendChild(n)),t({showProgress:!0,animate:!0,overlayOpacity:0,allowClose:!0,overlayClickNext:!1,doneBtnText:"\xA1A explorar!",nextBtnText:"Siguiente",prevBtnText:"Atr\xE1s",onDestroyed:()=>{let i=document.getElementById("tour-phantom-anchor");i&&i.remove()},steps:[{popover:{title:"\u{1F44B} \xA1Hola!",description:"Bienvenido a Rutas Koox. Sigue estos pasos.",side:"center",align:"center"}},{element:".choices__inner-search",popover:{title:"Tu Panel de Control",description:"Aqu\xED arriba escribes tu destino y buscas rutas.",side:"center",align:"center"}},{element:".bottom-nav",popover:{title:"Men\xFA Inferior",description:"Cambia entre Viaje, Explorar y Reportar aqu\xED abajo.",side:"top",align:"center"}}]}).drive()}function Wt(){setTimeout(()=>{localStorage.getItem("tour_visto_posicion_v4")||(it(),localStorage.setItem("tour_visto_posicion_v4","true"))},1e3)}var W=JSON.parse(localStorage.getItem("kooxSettings"))||{darkMode:!1,largeText:!1,highContrast:!1,vibration:!0},ae,ie,re,Ie;function Xt(){let t=document.body;W.darkMode?(t.classList.add("dark-mode"),ae&&(ae.checked=!0)):(t.classList.remove("dark-mode"),ae&&(ae.checked=!1)),W.largeText?(t.classList.add("large-text"),ie&&(ie.checked=!0)):(t.classList.remove("large-text"),ie&&(ie.checked=!1)),W.highContrast?(t.classList.add("high-contrast"),re&&(re.checked=!0)):(t.classList.remove("high-contrast"),re&&(re.checked=!1)),Ie&&(Ie.checked=W.vibration)}function Ue(t,e){W[t]=e,localStorage.setItem("kooxSettings",JSON.stringify(W)),Xt()}function Yt(){let t=document.getElementById("btnAjustes"),e=document.getElementById("settings-modal"),o=document.getElementById("btnCloseSettings"),n=document.getElementById("btnIniciarRecorrido");ae=document.getElementById("checkDarkMode"),ie=document.getElementById("checkLargeText"),re=document.getElementById("checkHighContrast"),Ie=document.getElementById("checkVibration"),t&&e&&t.addEventListener("click",()=>e.classList.remove("oculto")),o&&e&&o.addEventListener("click",()=>e.classList.add("oculto")),n&&n.addEventListener("click",()=>{e&&e.classList.add("oculto"),it()}),ae&&ae.addEventListener("change",a=>Ue("darkMode",a.target.checked)),ie&&ie.addEventListener("change",a=>Ue("largeText",a.target.checked)),re&&re.addEventListener("change",a=>Ue("highContrast",a.target.checked)),Ie&&Ie.addEventListener("change",a=>Ue("vibration",a.target.checked)),Xt()}var Ve=null,rt=0,_e=0,ze=!1,xe=null,Pe=null,st=0,ct=null,Se=!1,Oo=1,jo=3;function Zt(t){Ve=t,rt=0,_e=0,ze=!1,xe=Date.now(),Pe=Ve,ct=Date.now(),st=0,Se=!1,console.log("NavigationService: Iniciado.")}function lt(){Ve=null,xe=null,Pe=null,ct=null,Se=!1,console.log("NavigationService: Detenido.")}function dt(){console.log("NavigationService: Modo Transbordo ACTIVADO."),Se=!0}function Qt(t,e){if(!Ve||!xe||!Pe)return null;let o=Date.now(),n=(o-xe)/1e3,a=turf.distance(Pe,t,{units:"meters"});a>1&&(rt+=a),st=Math.floor((o-ct)/1e3);let i=!1;return e!=null?e>Oo&&(i=!0):a>jo&&(i=!0),i?(ze=!0,_e=0):(ze=!1,Se||(_e+=n)),Pe=t,xe=o,{distanciaRecorrida:rt,tiempoDetenido:Math.round(_e),enMovimiento:ze,tiempoTotalViaje:st,enModoTransbordo:Se}}X();var ht=_("KeepAwake",{web:()=>Promise.resolve().then(()=>(io(),ao)).then(t=>new t.KeepAwakeWeb)});X();function Go(t){t.CapacitorUtils.Synapse=new Proxy({},{get(e,o){return new Proxy({},{get(n,a){return(i,r,s)=>{let c=t.Capacitor.Plugins[o];if(c===void 0){s(new Error(`Capacitor plugin ${o} not found`));return}if(typeof c[a]!="function"){s(new Error(`Method ${a} not found in Capacitor plugin ${o}`));return}(async()=>{try{let d=await c[a](i);r(d)}catch(d){s(d)}})()}}})}})}function Jo(t){t.CapacitorUtils.Synapse=new Proxy({},{get(e,o){return t.cordova.plugins[o]}})}function ro(t=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},window.Capacitor!==void 0&&!t?Go(window):window.cordova!==void 0&&Jo(window))}var bt=_("Geolocation",{web:()=>Promise.resolve().then(()=>(co(),so)).then(t=>new t.GeolocationWeb)});ro();X();var lo;(function(t){t[t.Sunday=1]="Sunday",t[t.Monday=2]="Monday",t[t.Tuesday=3]="Tuesday",t[t.Wednesday=4]="Wednesday",t[t.Thursday=5]="Thursday",t[t.Friday=6]="Friday",t[t.Saturday=7]="Saturday"})(lo||(lo={}));var yt=_("LocalNotifications",{web:()=>Promise.resolve().then(()=>(po(),uo)).then(t=>new t.LocalNotificationsWeb)});X();var Et=_("Dialog",{web:()=>Promise.resolve().then(()=>(fo(),mo)).then(t=>new t.DialogWeb)});var ee={norte:20,sur:19.7,oeste:-90.75,este:-90.35},go=`${ee.oeste},${ee.norte},${ee.este},${ee.sur}`;function ho(t,e){let o=parseFloat(t),n=parseFloat(e);return o<=ee.norte&&o>=ee.sur&&n>=ee.oeste&&n<=ee.este}function Wo(t){let e=t.toLowerCase().trim(),o={sams:"Sam's Club","sam's":"Sam's Club","sams club":"Sam's Club",walmart:"Walmart",aurrera:"Bodega Aurrera",chedraui:"Chedraui",soriana:"Soriana",imss:"IMSS",issste:"ISSSTE",ado:"Terminal ADO",aeropuerto:"Aeropuerto",areopuerto:"Aeropuerto","mercado municipal":"Mercado Municipal Campeche",cetmar:"Calle Sixto Perez Cuevas","CETMAR 02":"Calle Sixto Perez Cuevas","cetmar 2":"Calle Sixto Perez Cuevas",tec:"Tecnologico",Tec:"Tecnologico",TEC:"Tecnologico",UAC:"Monumento Universidad Aut\xF3noma de Campeche",uac:"Monumento Universidad Aut\xF3noma de Campeche","universidad autonoma de campeche":"monumento Universidad Aut\xF3noma de Campeche","universidad aut\xF3noma de campeche":"Monumento Universidad Aut\xF3noma de Campeche","tec lerma":"Tecnol\xF3gico de Lerma","tec campeche":"Tecnol\xF3gico de Campeche",prevo:"Escuela Secundaria T\xE9cnica No. 1",PREVO:"Escuela Secundaria T\xE9cnica No. 1",SUR:"Terminal de Segunda Clase SUR",sur:"Terminal de Segunda Clase SUR","papa luchon":"\xC1ngel Maya",Fiscalia:"Avenida Jos\xE9 L\xF3pez Portillo",fiscal\u00EDa:"Avenida Jos\xE9 L\xF3pez Portillo","Bola de queso":"Monumentoa los 150 a\xF1os de la Emancipaci\xF3n de Campeche","bola de queso":"Monumentoa los 150 a\xF1os de la Emancipaci\xF3n de Campeche","Naach K'inil":"Monumentoa los 150 a\xF1os de la Emancipaci\xF3n de Campeche"};return o[e]?o[e]:(Object.keys(o).forEach(n=>{let a=new RegExp(`\\b${n}\\b`,"gi");a.test(e)&&(e=e.replace(a,o[n]))}),e)}async function wt(t,e=8){let o=Wo(t);console.log(`\u{1F9E0} Autocorrector: "${t}" -> "${o}"`);let a="&format=json&limit=40&addressdetails=1&countrycodes=mx",i=o;/campeche|lerma|china|chinÃ¡/i.test(i)||(i+=", Campeche");let r=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(i)}${a}&viewbox=${go}&bounded=1`;try{let s=await fetch(r),c=await s.json(),d=c.filter(u=>ho(u.lat,u.lon));if(d.length>0)return bo(d.slice(0,e));console.warn(`\u26A0\uFE0F Intento 1 sin resultados. Probando abierto con: "${o}"`);let b=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(o)}${a}&viewbox=${go}`;return s=await fetch(b),c=await s.json(),d=c.filter(u=>ho(u.lat,u.lon)),d.length>0?bo(d.slice(0,e)):[]}catch(s){return console.error("Error buscando lugar:",s),[]}}function bo(t){return t.map(e=>({nombre:e.display_name.split(",")[0],direccion:e.display_name,lat:parseFloat(e.lat),lng:parseFloat(e.lon),tipo:e.type}))}var It=[{nombre:"Catedral de Campeche",query:"Catedral de Campeche",icono:"ri-church-line"},{nombre:"Baluarte de San Francisco",query:"Baluarte de San Francisco",icono:"ri-ancient-gate-line"},{nombre:"Malec\xF3n de Campeche",query:"Malec\xF3n de Campeche",icono:"ri-road-map-line"},{nombre:"Fuerte de San Miguel",query:"Fuerte de San Miguel Campeche",icono:"ri-flag-line"},{nombre:"Parque Principal",query:"Parque Principal Campeche",icono:"ri-tree-line"},{nombre:"Mercado Pedro Sainz",query:"Mercado Pedro Sainz de Baranda",icono:"ri-store-2-line"}],vo=[{label:"Salud",query:"Hospital",icono:"ri-hospital-line"},{label:"Escuelas",query:"Escuela",icono:"ri-school-line"},{label:"Super",query:"Supermercado",icono:"ri-shopping-cart-2-line"},{label:"Farmacias",query:"Farmacia",icono:"ri-capsule-line"},{label:"Bancos",query:"Banco",icono:"ri-bank-line"}];function yo(t,e){if(!e||e.length===0)return[];let o=t.toLowerCase().trim();return e.filter(a=>{let i=a.properties,r=(i.nombre||"").toLowerCase(),s=(i.NOMVIAL||"").toLowerCase(),c=(i.NOM_COL||"").toLowerCase();return r.includes(o)||s.includes(o)||c.includes(o)}).slice(0,15).map(a=>({nombre:a.properties.nombre,lat:a.geometry.coordinates[1],lng:a.geometry.coordinates[0],id:a.properties.originalIndex,tipo:"local"}))}async function Xo(){try{await ht.keepAwake(),console.log("Modo KeepAwake activado: La pantalla no se apagar\xE1.")}catch(t){console.error("Error al activar KeepAwake:",t)}}function Yo(t,e){let o;return function(...n){let a=this;clearTimeout(o),o=setTimeout(()=>t.apply(a,n),e)}}async function Zo(){try{if((await bt.checkPermissions()).location!=="granted"){let{value:o}=await Et.confirm({title:"Permiso de Ubicaci\xF3n",message:"Para mostrarte tu posici\xF3n en el mapa y avisarte cuando llegues a tu parada, Rutas Koox necesita acceder a tu ubicaci\xF3n. \xBFNos das permiso?",okButtonTitle:"Claro, activar",cancelButtonTitle:"Ahora no"});o&&(await bt.requestPermissions()).location!=="granted"&&console.warn("El usuario deneg\xF3 el GPS.")}if((await yt.checkPermissions()).display!=="granted"){let{value:o}=await Et.confirm({title:"Alertas de Viaje",message:"\xBFTe gustar\xEDa que te avisemos cuando est\xE9s cerca de bajar del autob\xFAs? Activa las notificaciones para no perder tu parada.",okButtonTitle:"Activar Alertas",cancelButtonTitle:"No gracias"});o&&await yt.requestPermissions()}await ht.keepAwake(),console.log("Modo viaje activo: Pantalla encendida.")}catch(t){console.error("Error al solicitar permisos:",t)}}var Qo={apiKey:"AIzaSyDozEdN4_g7u-D6XcJdysuns8-iLbfMS5I",authDomain:"rutaskoox-alertas.firebaseapp.com",databaseURL:"https://rutaskoox-alertas-default-rtdb.firebaseio.com/",projectId:"rutaskoox-alertas",storageBucket:"rutaskoox-alertas.firebasestorage.app",messagingSenderId:"332778953247",appId:"1:332778953247:web:4460fef290b88fb1b1932a",measurementId:"G-XH7ZKS825M"};firebase.initializeApp(Qo);var en=firebase.firestore(),Co=firebase.database(),tn=()=>{let t=document.getElementById("pantalla-mantenimiento");t&&Co.ref("config/mantenimiento_activo").on("value",e=>{e.val()===!0?(console.warn("\u26A0\uFE0F MODO MANTENIMIENTO ACTIVADO"),t.classList.remove("oculto"),t.style.display="flex"):(console.log("\u2705 Sistema operativo"),t.classList.add("oculto"),t.style.display="none")})};tn();var C=[],$=[],To=null,se=new Map,V=[],y=[],T=0,ke=!1,ge=null,ce=!0,I=null,E=null,P=null,x=null,fe=0,St,q,Ge,J=null,Lo,xt=null;var on,Ct,Je=null,Tt=null,Mt=null,Eo=null,Ke=null,Te=null,Y=null,Pt=!1,We,A,B,Ae,Ze,z,O,Dt,kt,Me,At,$t,Bt,Nt,$e,wo,Io,me,xo,Xe,te,G;function nn(t){let e=$.find(o=>o.properties.id===t);return e?`${e.properties.id} (${e.properties.nombre})`:t}function Po(t){t?(Je.textContent=t,Je.classList.remove("oculto")):Je.classList.add("oculto")}function et(){if(!Tt)return;let t=Tt.val(),e=Ao(),o=Date.now();if(e&&t&&t[e]){let n=t[e],a=nn(e);if(o<n.expiraEn){Po(`\u26A0\uFE0F ALERTA: ${n.mensaje} en ${a}`);return}}Po(null)}document.addEventListener("DOMContentLoaded",async()=>{let t=document.getElementById("btnTestSimulador");t&&t.addEventListener("click",()=>{typeof window.simularBus=="function"?window.simularBus():alert("\u26A0\uFE0F Error: La funci\xF3n simularBus no se ha cargado. Revisa el final de tu archivo app.js")});let e=document.getElementById("btnBuscarLugar"),o=document.getElementById("info-lugar-buscado"),n=document.getElementById("contenedor-chips"),a=document.getElementById("btnModoTurista"),i=document.getElementById("btnMinimizarPanel"),r=document.getElementById("btnMinimizarNav");We=document.getElementById("selectDestino"),A=document.getElementById("inputInicio"),B=document.getElementById("panel-instrucciones"),Ae=document.getElementById("btnIniciarRuta"),Ze=document.getElementById("btnLimpiar"),z=document.getElementById("panel-control"),O=document.getElementById("panel-navegacion"),Dt=document.getElementById("instruccion-actual"),kt=document.getElementById("btnAnterior"),Me=document.getElementById("btnSiguiente"),At=document.getElementById("btnFinalizar"),St=document.getElementById("distancia-restante"),q=document.getElementById("tiempo-espera"),$t=document.getElementById("panel-viaje"),Bt=document.getElementById("panel-explorar"),Nt=document.getElementById("selectRuta"),$e=document.getElementById("instrucciones-explorar"),wo=document.getElementById("btnLimpiarExplorar"),Io=document.getElementById("btnInfo"),me=document.getElementById("info-modal"),xo=document.getElementById("btnCloseModal"),Ge=document.getElementById("tiempo-viaje"),Lo=document.getElementById("btnParaderosCercanos"),Je=document.getElementById("alert-indicator"),on=document.getElementById("btnModoReporte"),Ct=document.getElementById("panel-reporte"),Zo(),Yt();let s=document.querySelectorAll(".nav-item"),c=document.getElementById("pantalla-saldo"),d=document.getElementById("pantalla-recargas");s.forEach(l=>{l.addEventListener("click",m=>{let h=m.currentTarget,g=h.dataset.target;if(h.classList.contains("activo")&&(g==="viaje"||g==="explorar"||g==="reporte")){u();return}s.forEach(v=>v.classList.remove("activo")),h.classList.add("activo"),ln(g)})}),Xo(),xt=document.getElementById("offline-indicator");let b=()=>{navigator.onLine?xt.classList.add("oculto"):xt.classList.remove("oculto")};window.addEventListener("offline",b),window.addEventListener("online",b),b();try{Co.ref("alertas").on("value",m=>{Tt=m,et()})}catch(l){console.error("No se pudo conectar a Firebase Realtime Database",l)}Pn(),Xe=document.getElementById("selectInicioManual"),te=document.getElementById("control-input-inicio"),G=document.getElementById("control-select-inicio"),Lo.addEventListener("click",wn),Ze.addEventListener("click",Rt),Ae.addEventListener("click",ko),Me.addEventListener("click",Qe),kt.addEventListener("click",hn),At.addEventListener("click",mn),wo.addEventListener("click",Rt),document.querySelectorAll(".btn-reporte").forEach(l=>{l.addEventListener("click",m=>{let h=m.target.dataset.tipo;xn(h)})}),Io.addEventListener("click",()=>me.classList.remove("oculto")),xo.addEventListener("click",()=>me.classList.add("oculto")),me.addEventListener("click",l=>{l.target===me&&me.classList.add("oculto")}),z.classList.add("oculto"),O.classList.add("oculto"),G&&(G.style.display="none"),_t(),n&&vo.forEach(l=>{let m=document.createElement("button");m.className="chip",m.innerHTML=`<i class="${l.icono}"></i> ${l.label}`,m.addEventListener("click",()=>{No(`${l.query} en Campeche`)}),n.appendChild(m)}),e&&e.addEventListener("click",()=>{if(x){x.showDropdown();let l=x.input.value;l&&l.length>2&&x.input.element.dispatchEvent(new Event("input",{bubbles:!0}))}}),a&&a.addEventListener("click",()=>{Cn()});function u(){z.classList.add("oculto"),O.classList.add("oculto"),document.querySelectorAll(".nav-item").forEach(l=>l.classList.remove("activo"))}i&&i.addEventListener("click",u),r&&r.addEventListener("click",u),f.on("click",()=>{u()}),f.on("popupopen",l=>{let h=l.popup.getElement().querySelector(".btn-ver-rutas-paradero");h&&h.addEventListener("click",In)}),f.on("contextmenu",l=>{if(l.originalEvent.preventDefault(),!E){alert("Por favor, selecciona un punto de inicio o espera a que tu GPS se active antes de fijar un destino.");return}console.log("Clic largo detectado. Buscando paradero m\xE1s cercano...");let m=turf.point([l.latlng.lng,l.latlng.lat]),h=ot(m);if(!h){alert("No se encontraron paraderos cercanos a ese punto.");return}P=h,x.setChoiceByValue(h.properties.originalIndex),console.log(`Destino fijado en: ${P.properties.nombre}`),V=ue(E,P,C,$,se),Be(V),he()});try{let[l,m]=await Promise.all([fetch("data/paraderos.geojson"),fetch("data/rutas.geojson")]),h=await l.json(),g=await m.json();C=h.features.map((p,v)=>(p.properties.originalIndex=v,p)).filter(p=>!p||!p.geometry||!p.geometry.coordinates||p.geometry.coordinates.length<2||typeof p.geometry.coordinates[0]!="number"||typeof p.geometry.coordinates[1]!="number"?(console.warn(`Paradero inv\xE1lido/sin coordenadas en \xEDndice ${p.properties.originalIndex} (${p.properties.name}). Omitiendo.`),!1):!0),C.forEach(p=>{let v=p.properties;p.properties.nombre=v.nombre||v.Name||v.Paradero||v.NOMVIAL||"Paradero sin nombre"}),C.sort((p,v)=>p.properties.nombre.localeCompare(v.properties.nombre)),$=g.features,$.forEach(p=>{let v=p.properties,k=v.name||v.Name||v.Ruta||"Ruta desconocida";p.properties.id=k.split(" ").slice(0,2).join("-").toLowerCase(),p.properties.nombre=k.split(" ").slice(2).join(" ")}),console.log("Enlazando paraderos a rutas..."),Kt(C,$),console.log("Creando mapa de b\xFAsqueda de rutas..."),se=Jt($,C),console.log("\xA1Enlace completado!"),To=turf.featureCollection(C),sn(),cn(),dn(),Te=qe(Mo,tt),jt()}catch(l){console.error("Error cargando o procesando los datos GeoJSON:",l)}Wt()});function Mo(t){let e=t.coords.latitude,o=t.coords.longitude;if(e===0&&o===0){console.error("Posici\xF3n GPS inv\xE1lida (0,0) detectada."),Pt||(tt({code:0,message:"Posici\xF3n GPS inv\xE1lida (0,0)"}),A.value="Error de GPS (0,0)");return}I=turf.point([o,e]),E=ot(I),A.value=`Cerca de "${E.properties.nombre}"`,A.style.fontStyle="normal",A.style.color="black",A.style.fontWeight="normal",Pt||(Pt=!0,f.setView([e,o],16),le([e,o]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup())}function tt(t){console.warn(`ERROR DE UBICACI\xD3N (${t.code}): ${t.message}`),A.value="Ubicaci\xF3n bloqueada",A.style.color="red",A.style.fontWeight="bold";let e="GPS bloqueado o desactivado",o="Parece que tu navegador (como el de Facebook) bloquea la geolocalizaci\xF3n o el permiso fue denegado.";t.code===2?(e="GPS no disponible",o="No pudimos obtener una se\xF1al de GPS. Revisa que tu ubicaci\xF3n est\xE9 encendida."):(t.code===0||t.message==="Posici\xF3n GPS inv\xE1lida (0,0)")&&(e="Error de GPS",o="Tu GPS report\xF3 una ubicaci\xF3n inv\xE1lida (0,0). Intenta moverte a un \xE1rea con mejor se\xF1al."),B.innerHTML=`
        <div class="alerta-manual">
            <h5 style="margin-top:0;">${e}</h5>
            <p>${o}</p>
            <p><strong>Soluciones:</strong></p>
            <div class="alerta-manual-botones">
                <button id="btnModoManual" class="btn-alerta btn-primario">
                    \u{1F4CD} Usar Modo Manual
                </button>
                <button id="btnCopiarLink" class="btn-alerta btn-secundario">
                    \u{1F4CB} Copiar Link
                </button>
            </div>
            <small style="display: block; margin-top: 10px; text-align: center;">
                (Puedes copiar el link y pegarlo en Chrome o Safari)
            </small>
        </div>
    `,document.getElementById("btnModoManual").addEventListener("click",an),document.getElementById("btnCopiarLink").addEventListener("click",rn)}function an(){console.log("Activando modo manual"),te&&(te.style.display="none"),G&&(G.style.display="block"),B.innerHTML=`
        <p>Has activado el modo manual.</p>
        <p>1. Selecciona tu <strong>paradero de inicio</strong>.</p>
        <p>2. Selecciona tu <strong>paradero de destino</strong>.</p>
    `,E=null,I=null}function rn(){try{navigator.clipboard.writeText(window.location.href),alert(`\xA1Link copiado al portapapeles!

P\xE9galo en un navegador como Chrome, Safari o Firefox para un mejor funcionamiento.`)}catch(t){console.error("Error al copiar link:",t),alert("No se pudo copiar el link. Por favor, hazlo manualmente desde la barra de direcciones.")}}function sn(){x&&x.destroy(),x=new Choices(We,{choices:[],itemSelectText:"Ir aqu\xED",searchPlaceholderValue:"Escribe un lugar (ej. Walmart, Centro)...",shouldSort:!1,searchResultLimit:20,noResultsText:"Escribe para buscar...",loadingText:"Cargando..."}),window.choicesDestino=x;let t="",e=document.getElementById("loader-busqueda"),o=Yo(async n=>{let a=n.detail.value;if(!a||a.length<2)return;let i=navigator.onLine,r=document.getElementById("loader-busqueda");r&&r.classList.remove("oculto");try{let s=[];if(i){console.log(`\u{1F310} Buscando online: '${a}'`);let c=await wt(a);c&&c.length>0&&(s=c.map((d,b)=>({value:`ext_${d.lat}_${d.lng}_${b}`,label:`\u{1F4CD} ${d.nombre}`,customProperties:{fullData:d}})))}else{console.log(`\u{1F4F4} Buscando offline en paraderos: '${a}'`);let c=yo(a,C);c.length>0&&(s=c.map(d=>({value:d.id.toString(),label:`\u{1F68F} ${d.nombre}`,customProperties:{esLocal:!0}}))),s.push({value:"tip_offline",label:"\u{1F4A1} Tip: Sin internet, mant\xE9n presionado el mapa para elegir destino",disabled:!0,customProperties:{tipo:"aviso"}})}(s.length===0||s.length===1&&s[0].value==="tip_offline")&&s.unshift({value:"no_found",label:i?`\u{1F6AB} Nada encontrado para "${a}"`:`\u{1F6AB} Ning\xFAn paradero llamado "${a}"`,disabled:!0}),x.setChoices(s,"value","label",!0)}catch(s){console.error("Error buscando:",s)}finally{r&&r.classList.add("oculto")}},500);We.addEventListener("search",o),We.addEventListener("change",n=>{let a=n.detail.value;if(a.startsWith("ext_")){let i=x._store.choices.find(r=>r.value===a);i&&i.customProperties.fullData&&Ut(i.customProperties.fullData)}else{let i=parseInt(a);if(!isNaN(i)){let r=C.find(s=>s.properties.originalIndex===i);if(r)if(console.log("Seleccionado paradero offline:",r.properties.nombre),P=r,E)V=ue(E,P,C,$,se),Be(V),he();else{let s=P.geometry.coordinates;f.setView([s[1],s[0]],16),L.marker([s[1],s[0]],{icon:Ee}).addTo(S).bindPopup(`<b>${P.properties.nombre}</b><br>Destino seleccionado`).openPopup(),B.innerHTML="<p>Destino fijado. Esperando ubicaci\xF3n o selecciona inicio manual.</p>"}}}})}function cn(){if(!Xe)return;let t=C.map(e=>{let o=e.properties,n=o.NOMVIAL||o.calle_cercana||"",a=o.NOM_COL||o.colonia_cercana||"";return{value:o.originalIndex,label:o.nombre,customProperties:{calle:n,colonia:a}}});Y=new Choices(Xe,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe paradero, calle o colonia...",shouldSort:!1,removeItemButton:!0,searchFields:["label","customProperties.calle","customProperties.colonia"],callbackOnCreateTemplates:function(e){return{item:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return e(`<div class="${o.item} ${n.highlighted?o.highlightedState:o.itemSelectable}" data-item data-value="${n.value}" ${n.active?'aria-selected="true"':""} ${n.disabled?'aria-disabled="true"':""}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)},choice:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return e(`<div class="${o.item} ${o.itemChoice} ${n.disabled?o.itemDisabled:o.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${n.disabled?'data-choice-disabled aria-disabled="true"':"data-choice-selectable"}" data-id="${n.id}" data-value="${n.value}" ${n.groupId>0?'role="treeitem"':'role="option"'}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)}}}}),Xe.addEventListener("change",e=>{let o=e.detail.value;o&&(E=C.find(n=>n.properties.originalIndex==o),console.log("Inicio manual fijado:",E.properties.nombre),P&&(V=ue(E,P,C,$,se),Be(V)))})}function ln(t){console.log("Cambiando a modo:",t);let e=document.getElementById("pantalla-saldo"),o=document.getElementById("pantalla-recargas");e&&e.classList.add("oculto"),o&&o.classList.add("oculto"),$t.classList.add("oculto"),Bt.classList.add("oculto"),Ct.classList.add("oculto"),t==="saldo"?(z.classList.add("oculto"),O.classList.add("oculto"),e&&e.classList.remove("oculto")):t==="recargas"?(z.classList.add("oculto"),O.classList.add("oculto"),o&&o.classList.remove("oculto")):(ge!==null&&t==="viaje"?(z.classList.add("oculto"),O.classList.remove("oculto")):(z.classList.remove("oculto"),O&&O.classList.add("oculto")),t==="viaje"?$t.classList.remove("oculto"):t==="explorar"?Bt.classList.remove("oculto"):t==="reporte"&&Ct.classList.remove("oculto")),document.querySelectorAll(".nav-item").forEach(n=>{let a=n.querySelector("i");n.dataset.target===t?(n.classList.add("activo"),a&&a.className.includes("-line")&&(a.className=a.className.replace("-line","-fill"))):(n.classList.remove("activo"),a&&a.className.includes("-fill")&&(a.className=a.className.replace("-fill","-line")))}),et()}function dn(){$.sort((e,o)=>e.properties.id.localeCompare(o.properties.id,void 0,{numeric:!0}));let t=$.map(e=>({value:e.properties.id,label:`${e.properties.id} (${e.properties.nombre})`}));J=new Choices(Nt,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe para filtrar...",shouldSort:!1}),Nt.addEventListener("change",e=>{e.detail.value&&un(e.detail.value)})}function un(t){let e=$.find(a=>a.properties.id===t);if(!e)return;let o=se.get(t),n=o?[...o]:[];Vt(e,n),et(),$o(t,null),$e.innerHTML=`
        <p>Mostrando <strong>${e.properties.id}</strong>.</p>
        <p>Esta ruta tiene aproximadamente <strong>${n.length}</strong> paraderos.</p>
    `}function Rt(){if(Fe([]),de(),et(),S.clearLayers(),Ft(),B.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>",jt(),O.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",q.className="",lt(),we(ge),x&&(x.clearInput(),x.removeActiveItems()),G&&(G.style.display="none"),te&&(te.style.display="block"),Y&&(Y.clearInput(),Y.removeActiveItems()),x&&(x.clearInput(),x.removeActiveItems()),Y&&(Y.clearInput(),Y.removeActiveItems()),J&&(J.clearInput(),J.removeActiveItems()),G&&(G.style.display="none"),te&&(te.style.display="block"),Ae.style.display="none",Ze.style.display="none",$e.innerHTML="Selecciona una ruta para ver su trayecto y paraderos.",O.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",q.className="",lt(),we(ge),ge=null,I){E=ot(I),A.value=`Cerca de "${E.properties.nombre}"`,A.style.color="black",A.style.fontWeight="normal";let t=I.geometry.coordinates;f.setView([t[1],t[0]],16),le([t[1],t[0]]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup()}else E=null,A.value="Detectando ubicaci\xF3n...",A.style.color="black",A.style.fontWeight="normal"}function Be(t){B.innerHTML="",S.clearLayers(),de();let e=I||E;if(!e){B.innerHTML="<p><strong>Error:</strong> No se ha fijado un punto de inicio.</p>";return}let o=e.geometry.coordinates;L.marker([o[1],o[0]]).addTo(S).bindPopup(I?"<b>Est\xE1s aqu\xED</b>":`<b>Inicio (Manual):</b><br>${E.properties.nombre}`);let n=P.geometry.coordinates,a=[n[1],n[0]],i=U(P,"Destino Final");if(L.marker(a,{icon:Ee}).addTo(S).bindPopup(i),!t||t.length===0)return;let r=t[0],s=r.filter(u=>u.tipo==="bus"),c=r.find(u=>u.tipo==="caminar");if(c){let u=c.paradero,l=u.geometry.coordinates,m=[l[1],l[0]],h=U(u,"Subir aqu\xED");L.marker(m,{icon:Oe}).addTo(S).bindPopup(h)}for(let u=0;u<s.length-1;u++){let l=s[u].paraderoFin,m=l.geometry.coordinates,h=[m[1],m[0]],g=U(l,"Transbordo Aqu\xED");L.marker(h,{icon:nt}).addTo(S).bindPopup(g)}let d=document.createDocumentFragment(),b=document.createElement("p");b.innerHTML=`<strong>Se encontraron ${t.length} opciones:</strong>`,d.appendChild(b),t.forEach((u,l)=>{let m=document.createElement("div");m.className="opcion-ruta";let h=u.filter(k=>k.tipo==="bus").map(k=>k.ruta.properties.id),g=document.createElement("h4");g.innerHTML=`Opci\xF3n ${l+1} <span style="font-weight:normal; font-size: 0.8em;">(${h.join(" &rarr; ")})</span>`,m.appendChild(g);let p=document.createElement("ol");u.forEach(k=>{if(k.tipo==="caminar"||k.tipo==="bus"){let Z=document.createElement("li");Z.textContent=k.texto,p.appendChild(Z)}}),m.appendChild(p);let v=document.createElement("button");v.className="btn-seleccionar",v.innerHTML='Seleccionar <i class="ri-arrow-right-line"></i>',v.addEventListener("click",()=>{pn(l)}),m.appendChild(v),d.appendChild(m)}),B.appendChild(d),Fe(t),Ze.style.display="block",Ae.style.display="none"}var pn=t=>{y=V[t],fe=0;let e=I||E;y.forEach(a=>{let i=0;try{if(a.tipo==="caminar"){i=turf.distance(e,a.paradero,{units:"meters"}),fe+=i,e=a.paradero;let r=Math.max(1,Math.round(i/80));a.distanciaMetros=i,a.tiempoEstimadoMin=r,a.texto=`Dir\xEDgete a ${a.paradero.properties.nombre} (${i.toFixed(0)} m - ${r} min \u{1F6B6}\u200D\u2642\uFE0F)`}else if(a.tipo==="bus"){let r=a.ruta;if(a.ruta.geometry.type==="MultiLineString")try{let b=a.ruta.geometry.coordinates.flat();r=turf.lineString(b)}catch{console.warn("No se pudo aplanar la ruta MultiLineString, usando c\xE1lculo simple.")}let s=turf.nearestPointOnLine(r,a.paraderoInicio),c=turf.nearestPointOnLine(r,a.paraderoFin),d=turf.lineSlice(s,c,r);i=turf.length(d,{units:"meters"}),fe+=i,e=a.paraderoFin,a.distanciaMetros=i,a.texto=`Toma ${a.ruta.properties.id} y baja en ${a.paraderoFin.properties.nombre} (${(i/1e3).toFixed(1)} km)`}else a.tipo==="transbordo"&&(a.texto=`En ${a.paradero.properties.nombre}, espera el siguiente cami\xF3n.`)}catch(r){console.error("Error calculando distancia del paso:",a,r)}}),console.log(`Distancia total de la ruta: ${fe} metros`);let n=y.filter(a=>a.tipo==="bus").map(a=>a.ruta.properties.id).join(" \u2192 ");B.innerHTML=`
        <p><strong>Ruta seleccionada. \xA1Listo para navegar!</strong></p>
        <p>${n}</p>
        <p><strong>Distancia total:</strong> ${(fe/1e3).toFixed(2)} km</p>
        
        <div class="panel-acciones">
            <button id="btnIniciarRuta">Iniciar Ruta</button>
            <button id="btnGuardarFavorito" class="btn-secundario">\u2B50\uFE0F Guardar Favorito</button>
        </div>
    `,B.querySelector("#btnIniciarRuta").addEventListener("click",ko),B.querySelector("#btnGuardarFavorito").addEventListener("click",()=>{yn()}),Ae.style.display="none",Fe([y])};function ot(t){return turf.nearestPoint(t,To)}function ko(){if(!(!y||y.length===0)){try{let t=y.filter(o=>o.tipo==="bus").map(o=>o.ruta.properties.id).join(" \u2192 "),e={inicioId:E.properties.originalIndex,inicioNombre:E.properties.nombre,finId:P.properties.originalIndex,finNombre:P.properties.nombre,rutaResumen:t,fecha:new Date().toISOString()};vn(e)}catch(t){console.error("Error al guardar en el historial:",t)}T=0,ke=!1,z.classList.add("oculto"),O.classList.remove("oculto"),I?(console.log("Iniciando modo de navegaci\xF3n GPS (Activo)..."),we(Te),document.getElementById("nav-estado").style.display="flex",le(I.geometry.coordinates.slice().reverse()),Zt(I),ge=qe(fn,tt),f.on("dragstart",()=>{ce=!1})):(console.log("Iniciando modo de navegaci\xF3n MANUAL (Pasivo)..."),document.getElementById("nav-estado").style.display="none",ge=null,ce=!0),qt(T),Ot(T)}}function mn(){console.log("Finalizando navegaci\xF3n."),O.classList.add("oculto"),z.classList.remove("oculto"),f.off("dragstart"),Te&&we(Te),Te=qe(Mo,tt),Rt()}function fn(t){let e=t.coords.latitude,o=t.coords.longitude,n=t.coords.speed,a=[e,o];I=turf.point([o,e]),le(a),ce&&f.panTo(a);let i=Qt(I,n);if(i){if(y&&T<y.length){let r=y[T];if(r.tipo==="caminar"||r.tipo==="transbordo"){let s=y[T+1];if(s&&s.tipo==="bus"){let c=s.ruta.properties.id,d=[];f.eachLayer(m=>{m.options&&m.options.rutaId===c&&d.push(m)});let b=null,u=1/0;if(d.forEach(m=>{let h=m.getLatLng(),g=turf.point([h.lng,h.lat]),p=turf.distance(I,g,{units:"meters"})*1e3;p<u&&(u=p,b=m)}),b&&u<20){console.log(`DETECCI\xD3N A BORDO: Distancia ${u.toFixed(2)}m. Asumiendo subida.`),dt(!1),Qe();return}}}}bn(i),gn(i)}}function gn(t){if(!y||y.length===0||T>=y.length)return;let e=y[T],o=40;if(!I)return;let n=null,a=null;if(e.tipo==="caminar"?n=e.paradero:e.tipo==="bus"&&(n=e.paraderoFin,a=e.ruta),e.tipo==="caminar"&&turf.distance(I,n,{units:"meters"})<25){console.log("Llegaste al paradero de subida, avanzando..."),Qe();return}if(e.tipo==="bus"){turf.distance(I,n,{units:"meters"})<300&&!ke&&(console.log("\xA1Alerta! Bajas pronto."),ke=!0,W.vibration&&navigator.vibrate&&navigator.vibrate([200,100,200]),Dt.textContent=`\xA1BAJA PRONTO! (${n.properties.nombre})`);try{let r=turf.nearestPointOnLine(a,I),s=turf.nearestPointOnLine(a,n),c=r.properties.location,d=s.properties.location;if((c-d)*1e3>o){console.log("Detecci\xF3n de Avance: El usuario pas\xF3 el punto de bajada. Avanzando..."),T===y.length-1||(console.log("Activando contador de transbordo..."),dt(),W.vibration&&navigator.vibrate&&navigator.vibrate([200,100,200,100,200])),Qe();return}}catch(r){console.error("Error en l\xF3gica de proyecci\xF3n Turf:",r)}}}function Qe(){T<y.length-1&&(T++,ce=!0,ke=!1,Ot(T),qt(T))}function hn(){T>0&&(T--,ce=!0,ke=!1,Ot(T),qt(T))}function Ot(t){let e=y[t];Dt.textContent=e.texto,kt.disabled=t===0;let o=t===y.length-1;Me.disabled=o,At.style.display="block",o?Me.style.display="none":Me.style.display="block";let a=zt(e,I||E);ce&&a&&a.isValid()?f.fitBounds(a.pad(.2)):ce&&!a&&f.setView(f.getCenter(),17)}function bn(t){let e=Math.max(0,fe-t.distanciaRecorrida);e>1e3?St.textContent=`Faltan: ${(e/1e3).toFixed(2)} km`:St.textContent=`Faltan: ${e.toFixed(0)} m`;let o=5400;if(q.className="",t.enModoTransbordo&&!t.enMovimiento){let r=o-t.tiempoTotalViaje;if(r>0){let s=Math.floor(r/60),c=r%60;q.textContent=`Transbordo: ${s}:${c<10?"0":""}${c}`,q.classList.add("transbordo-timer")}else q.textContent="Tiempo Agotado",q.classList.add("advertencia")}else if(t.enMovimiento)q.textContent="En movimiento",q.classList.add("en-movimiento");else{let r=Math.floor(t.tiempoDetenido/60),s=t.tiempoDetenido%60;q.textContent=`Esperando: ${r}:${s<10?"0":""}${s}`,q.classList.add("advertencia")}let n=7200,a=Math.floor(t.tiempoTotalViaje/60),i=t.tiempoTotalViaje%60;Ge.textContent=`Viaje: ${a}:${i<10?"0":""}${i}`,t.tiempoTotalViaje>n?Ge.classList.add("advertencia"):Ge.classList.remove("advertencia")}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(t=>{console.log("Service Worker: Registrado exitosamente",t.scope)}).catch(t=>{console.log("Service Worker: Fall\xF3 el registro",t)})});function vn(t){let o=JSON.parse(localStorage.getItem("historialRutas"))||[];o=o.filter(a=>!(a.inicioId===t.inicioId&&a.finId===t.finId)),o.unshift(t);let n=o.slice(0,5);localStorage.setItem("historialRutas",JSON.stringify(n))}function jt(){let t=JSON.parse(localStorage.getItem("historialRutas"))||[],e=JSON.parse(localStorage.getItem("favoritasRutas"))||[],o="";if(e.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px;">\u2B50\uFE0F Tus Favoritos:</p>',o+=e.map(n=>`
                <div class="opcion-ruta favorito-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir: ${n.inicioNombre} \u2192 ${n.finNombre}">
                    
                    <span class="delete-favorito" data-nombre="${n.nombre}" title="Borrar favorito">&times;</span>
                    
                    <h4 style="margin-bottom: 5px;">${n.nombre}</h4>
                    <small style="color: #555;">${n.inicioNombre} \u2192 ${n.finNombre}</small>
                </div>
            `).join("")),t.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px; margin-top: 20px;">Tu historial reciente:</p>',o+=t.map(n=>`
                <div class="opcion-ruta historial-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir esta b\xFAsqueda">
                    <h4 style="margin-bottom: 5px;">${n.inicioNombre} \u2192 ${n.finNombre}</h4>
                    <small style="color: #555;">${n.rutaResumen||"Ruta de caminata"}</small>
                </div>
            `).join("")),o===""){B.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>";return}B.innerHTML=o,document.querySelectorAll(".historial-item").forEach(n=>{n.addEventListener("click",So)}),document.querySelectorAll(".favorito-item").forEach(n=>{n.addEventListener("click",So)}),document.querySelectorAll(".delete-favorito").forEach(n=>{n.addEventListener("click",En)})}async function So(t){let e=t.currentTarget,o=e.dataset.inicioId,n=e.dataset.finId;if(!o||!n)return;console.log(`Cargando historial: Inicio ${o}, Fin ${n}`);let a=C.find(r=>r.properties.originalIndex==o);if(P=C.find(r=>r.properties.originalIndex==n),!a||!P){alert("Error: Datos de ruta no encontrados.");return}E=a,I=null,te.style.display="none",G.style.display="block",Y&&Y.setChoiceByValue(o.toString());let i={value:n.toString(),label:P.properties.nombre,selected:!0};x.setChoices([i],"value","label",!0),V=ue(E,P,C,$,se),Be(V)}function yn(){let t=prompt("Dale un nombre a esta ruta (ej. Casa a Oficina):","");if(!(!t||t.trim()===""))try{let e={inicioId:E.properties.originalIndex,inicioNombre:E.properties.nombre,finId:P.properties.originalIndex,finNombre:P.properties.nombre,nombre:t.trim()};Ln(e)}catch(e){console.error("Error al guardar en favoritos:",e),alert("Error: No se pudo guardar el favorito.")}}function Ln(t){let e=JSON.parse(localStorage.getItem("favoritasRutas"))||[];e=e.filter(o=>o.nombre!==t.nombre),e.unshift(t),localStorage.setItem("favoritasRutas",JSON.stringify(e)),alert(`\xA1Ruta "${t.nombre}" guardada como favorita!`)}function En(t){t.stopPropagation();let e=t.currentTarget.dataset.nombre;if(e&&confirm(`\xBFSeguro que quieres borrar el favorito "${e}"?`)){let o=JSON.parse(localStorage.getItem("favoritasRutas"))||[];o=o.filter(n=>n.nombre!==e),localStorage.setItem("favoritasRutas",JSON.stringify(o)),jt()}}function wn(){if(!I){alert("No se ha podido detectar tu ubicaci\xF3n GPS. Mu\xE9vete a un lugar con mejor se\xF1al o reinicia la app.");return}console.log("Buscando paraderos cercanos..."),de(),S.clearLayers(),J&&(J.clearInput(),J.removeActiveItems());let e=C.map(r=>{let s=turf.distance(I,r,{units:"meters"});return{paradero:r,distancia:s}}).sort((r,s)=>r.distancia-s.distancia).slice(0,5),o=[],n='<p><strong>Paraderos m\xE1s cercanos a ti:</strong></p><ol style="padding-left: 20px;">';e.forEach(r=>{let s=r.paradero.geometry.coordinates,c=[s[1],s[0]],d=r.paradero.properties.nombre,b=r.distancia.toFixed(0);n+=`<li style="margin-bottom: 5px;">${d} (aprox. ${b} m)</li>`;let u=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[24,24],iconAnchor:[12,12],popupAnchor:[0,-12]}),l=U(r.paradero),m=L.marker(c,{icon:u}).bindPopup(l);m.addTo(S),o.push(m)}),n+="</ol>",$e.innerHTML=n;let a=le(I.geometry.coordinates.slice().reverse()),i=L.featureGroup([a,...o]);i.getBounds().isValid()&&f.fitBounds(i.getBounds().pad(.2)),he()}function In(t){let e=t.target.dataset.paraderoId;if(!e)return;let o=C.find(r=>r.properties.originalIndex==e);if(!o)return;let a=(o.properties.rutas||[]).map(r=>$.find(s=>s.properties.id===r)).filter(Boolean),i=`<p>Mostrando rutas para:</p>
                <h4 style="margin-top:0;">${o.properties.nombre}</h4>`;a.length>0?(i+='<ul style="padding-left: 20px; margin-top: 10px;">',a.forEach(r=>{i+=`<li style="margin-bottom: 5px;">
                        <strong>${r.properties.id}</strong>
                        <small>(${r.properties.nombre})</small>
                    </li>`}),i+="</ul>"):i+="<p>No hay rutas registradas para este paradero.</p>",$e.innerHTML=i,f.closePopup(),he()}function he(){z.classList.contains("oculto")&&z.classList.remove("oculto")}function Ao(){if(y&&y.length>0&&T<y.length){let t=y[T];if(t.tipo==="bus")return t.ruta.properties.id}if(J&&J.getValue(!0))return J.getValue(!0);if(E&&O.classList.contains("oculto")){let t=E.properties.rutas||[];if(t.length>0)return t[0]}return null}async function xn(t){let e=Ao();if(!e){alert("Por favor, inicia una navegaci\xF3n o selecciona una ruta en 'Explorar' para poder reportar un incidente sobre ella.");return}console.log(`Enviando reporte a Firebase: ${t} en ${e}`);try{await en.collection("reportes_pendientes").add({tipo:t,rutaId:e,timestamp:firebase.firestore.FieldValue.serverTimestamp()}),alert(`\xA1Gracias! Tu reporte para la ruta ${e} ha sido enviado.`)}catch(o){console.error("Error al enviar reporte a Firebase:",o),alert("No se pudo enviar el reporte. Revisa tu conexi\xF3n a internet.")}}function Ft(){Ke&&(Ke(),Ke=null,console.log("Escucha de buses en vivo DETENIDA.")),at(),Ye(null)}function Ye(t){let e=document.getElementById("eta-info");if(!e)return;if(!t){e.style.display="none",e.innerHTML="";return}let o=`<strong>Pr\xF3ximo bus (Unidad ${t.id}):</strong>`;t.etaMinutos?o+=`<p>Llega a tu parada en aprox. <strong>${t.etaMinutos} min</strong>.</p>`:o+=`<p>Est\xE1 a <strong>${t.distanciaMetros.toFixed(0)} m</strong> de tu parada.</p>`,e.innerHTML=o,e.style.display="block"}function $o(t,e){if(!Mt){console.error("Firebase (Gesti\xF3n) no est\xE1 inicializado.");return}Ft();let o=Mt.collection("live_locations");t?(o=o.where("routeId","==",t),console.log(`Iniciando escucha de buses SOLO para la ruta: ${t}`)):console.log("Iniciando escucha de TODOS los buses (modo global)"),Ke=o.onSnapshot(n=>{let a=[],i=$.find(r=>r.properties.id===t);if(n.docChanges().forEach(r=>{let s=r.doc.id,c=r.doc.data();if(r.type==="added"||r.type==="modified"){if(!c.lat||!c.lng||!c.routeId)return;if(Ht(s,c.routeId,[c.lat,c.lng]),e&&i)try{let d=turf.point([c.lng,c.lat]),b=turf.nearestPointOnLine(i,d),u=turf.nearestPointOnLine(i,e.geometry.coordinates),l=b.properties.location;if(u.properties.location-l>.01){let g=turf.lineSlice(b,u,i),p=turf.length(g,{units:"meters"});a.push({id:s,distanciaMetros:p,speed:c.speed||0})}}catch(d){console.error("Error calculando ETA con Turf:",d)}}else r.type==="removed"&&Gt(s)}),a.length>0){a.sort((c,d)=>c.distanciaMetros-d.distanciaMetros);let r=a[0],s=null;r.speed>1&&(s=Math.round(r.distanciaMetros/r.speed/60)),Ye({id:r.id,etaMinutos:s,distanciaMetros:r.distanciaMetros})}else e?(Ye({id:"N/A",etaMinutos:null,distanciaMetros:999999}),document.getElementById("eta-info").innerHTML="<p>No hay buses de esta ruta aproxim\xE1ndose a tu parada.</p>"):Ye(null)},n=>{console.error("Error en escucha de Firestore:",n)})}function qt(t){Ft();let e=y[t];if(e&&(e.tipo==="caminar"||e.tipo==="transbordo")){let o=y[t+1];if(o&&o.tipo==="bus"){let n=o.ruta.properties.id,a=o.paraderoInicio;console.log(`Buscando ETA para ${n} en ${a.properties.nombre}`),$o(n,a)}}}function Pn(){let t={apiKey:"AIzaSyDcaVTGa3j1YZjbd1D52wNNc1qk7VnrorY",authDomain:"rutaskoox-gestion.firebaseapp.com",projectId:"rutaskoox-gestion",storageBucket:"rutaskoox-gestion.firebasestorage.app",messagingSenderId:"2555756265",appId:"1:2555756265:web:c6f7487ced40a4f6f87538",measurementId:"G-81656MC0ZC"};try{Eo=firebase.initializeApp(t,"gestionApp"),Mt=Eo.firestore(),console.log("Servicio de Gesti\xF3n Firebase inicializado.")}catch(e){console.error("Error inicializando Firebase Gesti\xF3n",e)}}var Bo=[];async function No(t){let e=document.getElementById("btnBuscarLugar");if(e){var o=e.innerHTML;e.innerHTML='<i class="ri-loader-4-line ri-spin"></i>',e.disabled=!0}try{let n=await wt(t,100);n&&n.length>0?n.length===1?Ut(n[0]):Sn(n):alert("No encontramos lugares con ese nombre en Campeche.")}catch(n){console.error(n),alert("Error de conexi\xF3n al buscar.")}finally{e&&(e.innerHTML=o,e.disabled=!1)}}function Sn(t){let e=document.getElementById("panel-instrucciones");Bo=t;let o=`
        <div class="info-seccion">
            <p style="margin-bottom:10px;">Encontramos <strong>${t.length}</strong> opciones:</p>
            <div class="lista-resultados" style="max-height: 60vh; overflow-y: auto; padding-bottom: 20px;">
    `;t.forEach((n,a)=>{o+=`
            <div class="opcion-ruta" onclick="window.app.seleccionarResultado(${a})" style="cursor:pointer; padding: 15px; margin-bottom: 10px;">
                <h4 style="margin:0 0 5px 0; font-size: 1em; color: var(--primary-color);">
                    <i class="ri-map-pin-line"></i> ${n.nombre}
                </h4>
                <small style="color: var(--text-color); opacity: 0.8; line-height: 1.2; display:block;">
                    ${n.direccion}
                </small>
            </div>
        `}),o+="</div></div>",e.innerHTML=o,he()}window.app=window.app||{};window.app.seleccionarResultado=t=>{let e=Bo[t];e&&Ut(e)};function Ut(t){let e=document.getElementById("info-lugar-buscado");console.log("Procesando lugar:",t);let o=turf.point([t.lng,t.lat]),n=ot(o);if(n){if(P=n,x&&x.setChoiceByValue(n.properties.originalIndex.toString()),E)console.log("\u{1F4CD} Inicio detectado, calculando ruta autom\xE1tica..."),B.innerHTML="",V=ue(E,P,C,$,se),Be(V);else{let i=document.getElementById("panel-instrucciones");i.innerHTML=`
                <div class="alerta-verde" style="text-align:left; margin-top:0;">
                    <strong>\u2705 Destino: ${t.nombre}</strong><br>
                    <small>Paradero m\xE1s cercano: ${n.properties.nombre}</small>
                </div>
                <div style="background:#fff3e0; color:#e65100; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #ffe0b2; text-align:center;">
                    \u{1F4CD} <strong>Falta tu ubicaci\xF3n</strong><br>
                    Espera al GPS o selecciona un "Inicio Manual" arriba.
                </div>
            `}he();let a=L.marker([t.lat,t.lng],{icon:L.divIcon({className:"icono-destino-especial",html:'<i class="ri-map-pin-star-fill" style="color:#E91E63; font-size:30px; text-shadow: 0 2px 5px rgba(0,0,0,0.3);"></i>',iconSize:[30,30],iconAnchor:[15,30]})}).addTo(f).bindPopup(`<b>${t.nombre}</b>`).openPopup();f.setView([t.lat,t.lng],16),setTimeout(()=>f.removeLayer(a),5e3)}else alert("El lugar existe, pero est\xE1 muy lejos de cualquier ruta de transporte.")}function Cn(){if(!x)return;let t=It.map(n=>({value:"turismo_"+n.query,label:`\u{1F4F8} ${n.nombre}`,customProperties:{calle:"Sitio Tur\xEDstico",colonia:"Recomendado"}})),e='<div class="info-seccion"><h5>Sitios de Inter\xE9s</h5><div class="chips-scroll" style="flex-wrap:wrap;">';It.forEach(n=>{e+=`<button class="chip" onclick="window.app.buscarTurismo('${n.query}')">
            <i class="${n.icono}"></i> ${n.nombre}
        </button>`}),e+="</div></div>";let o=document.getElementById("panel-instrucciones");o.innerHTML=e}window.app=window.app||{};window.app.buscarTurismo=t=>{No(t)};window.simularBus=function(){if(!y||y.length===0){alert("\u26A0\uFE0F Primero inicia una ruta de navegaci\xF3n (Pon inicio y destino).");return}let t=y.find(d=>d.tipo==="bus");if(!t){alert("\u{1F6B6} Tu ruta es solo de caminata. Elige un destino m\xE1s lejos para usar bus.");return}let e=t.ruta.properties.id;console.log(`\u{1F68C} Iniciando simulaci\xF3n para: ${e}`);let o=t.paraderoInicio.geometry.coordinates,n=o[1]-.006,a=o[0]-.006,i=L.divIcon({className:"bus-simulado",html:`
            <div style="
                background: #d32f2f; 
                border: 2px solid white; 
                color: white; 
                width: 44px; height: 44px; 
                border-radius: 50%; 
                display: flex; align-items: center; justify-content: center; 
                font-weight: bold; font-size: 10px;
                box-shadow: 0 4px 15px rgba(211, 47, 47, 0.5);
                animation: palpitar 1s infinite;
            ">
                TEST
            </div>
            <style>@keyframes palpitar { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }</style>
        `,iconSize:[44,44]}),r=L.marker([n,a],{icon:i}).addTo(f),s=3e3;alert(`\u{1F440} \xA1Mira el mapa! Un bus de prueba (${e}) se acerca a tu paradero.`);let c=setInterval(()=>{n+=15e-5,a+=15e-5,s-=50,r.setLatLng([n,a]);let d=document.getElementById("eta-info");d&&(d.style.display="block",d.innerHTML=`
                <div style="background:#e3f2fd; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #90caf9; display:flex; align-items:center; gap:10px;">
                    <div style="font-size:20px;">\u{1F68D}</div>
                    <div>
                        <strong style="color:#1565c0;">BUS DE PRUEBA</strong>
                        <div style="font-size:1.1em; font-weight:bold;">${Math.max(1,Math.ceil(s/500))} min</div>
                        <small style="color:#555;">A ${s} metros</small>
                    </div>
                </div>
            `),s<=100&&(clearInterval(c),alert("\u2705 \xA1El bus simulado lleg\xF3 al paradero!"),f.removeLayer(r),d&&(d.style.display="none"))},800)};})();
/*! Bundled license information:

@capacitor/core/dist/index.js:
  (*! Capacitor: https://capacitorjs.com/ - MIT License *)
*/
