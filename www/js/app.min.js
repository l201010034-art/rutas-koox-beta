(()=>{var yo=Object.defineProperty;var pe=(t,e)=>()=>(t&&(e=t(t=0)),e);var Ce=(t,e)=>{for(var o in e)yo(t,o,{get:e[o],enumerable:!0})};var se,ve,Po,Io,xo,rt,U,R,_t,Gt,st,pn,So,Co,$o,ko,ct,mn,Ht,Kt,lt,fn,W=pe(()=>{(function(t){t.Unimplemented="UNIMPLEMENTED",t.Unavailable="UNAVAILABLE"})(se||(se={}));ve=class extends Error{constructor(e,o,n){super(e),this.message=e,this.code=o,this.data=n}},Po=t=>{var e,o;return t?.androidBridge?"android":!((o=(e=t?.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||o===void 0)&&o.bridge?"ios":"web"},Io=t=>{let e=t.CapacitorCustomPlatform||null,o=t.Capacitor||{},n=o.Plugins=o.Plugins||{},i=()=>e!==null?e.name:Po(t),a=()=>i()!=="web",r=l=>{let u=d.get(l);return!!(u?.platforms.has(i())||s(l))},s=l=>{var u;return(u=o.PluginHeaders)===null||u===void 0?void 0:u.find(g=>g.name===l)},c=l=>t.console.error(l),d=new Map,p=(l,u={})=>{let g=d.get(l);if(g)return console.warn(`Capacitor plugin "${l}" already registered. Cannot register plugins twice.`),g.proxy;let w=i(),m=s(l),b,k=async()=>(!b&&w in u?b=typeof u[w]=="function"?b=await u[w]():b=u[w]:e!==null&&!b&&"web"in u&&(b=typeof u.web=="function"?b=await u.web():b=u.web),b),T=(h,I)=>{var B,N;if(m){let K=m?.methods.find(D=>I===D.name);if(K)return K.rtype==="promise"?D=>o.nativePromise(l,I.toString(),D):(D,oe)=>o.nativeCallback(l,I.toString(),D,oe);if(h)return(B=h[I])===null||B===void 0?void 0:B.bind(h)}else{if(h)return(N=h[I])===null||N===void 0?void 0:N.bind(h);throw new ve(`"${l}" plugin is not implemented on ${w}`,se.Unimplemented)}},Y=h=>{let I,B=(...N)=>{let K=k().then(D=>{let oe=T(D,h);if(oe){let Se=oe(...N);return I=Se?.remove,Se}else throw new ve(`"${l}.${h}()" is not implemented on ${w}`,se.Unimplemented)});return h==="addListener"&&(K.remove=async()=>I()),K};return B.toString=()=>`${h.toString()}() { [capacitor code] }`,Object.defineProperty(B,"name",{value:h,writable:!1,configurable:!1}),B},ue=Y("addListener"),A=Y("removeListener"),xe=(h,I)=>{let B=ue({eventName:h},I),N=async()=>{let D=await B;A({eventName:h,callbackId:D},I)},K=new Promise(D=>B.then(()=>D({remove:N})));return K.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await N()},K},te=new Proxy({},{get(h,I){switch(I){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return m?xe:ue;case"removeListener":return A;default:return Y(I)}}});return n[l]=te,d.set(l,{name:l,proxy:te,platforms:new Set([...Object.keys(u),...m?[w]:[]])}),te};return o.convertFileSrc||(o.convertFileSrc=l=>l),o.getPlatform=i,o.handleError=c,o.isNativePlatform=a,o.isPluginAvailable=r,o.registerPlugin=p,o.Exception=ve,o.DEBUG=!!o.DEBUG,o.isLoggingEnabled=!!o.isLoggingEnabled,o},xo=t=>t.Capacitor=Io(t),rt=xo(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),U=rt.registerPlugin,R=class{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,o){let n=!1;this.listeners[e]||(this.listeners[e]=[],n=!0),this.listeners[e].push(o);let a=this.windowListeners[e];a&&!a.registered&&this.addWindowListener(a),n&&this.sendRetainedArgumentsForEvent(e);let r=async()=>this.removeListener(e,o);return Promise.resolve({remove:r})}async removeAllListeners(){this.listeners={};for(let e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,o,n){let i=this.listeners[e];if(!i){if(n){let a=this.retainedEventArguments[e];a||(a=[]),a.push(o),this.retainedEventArguments[e]=a}return}i.forEach(a=>a(o))}hasListeners(e){var o;return!!(!((o=this.listeners[e])===null||o===void 0)&&o.length)}registerWindowListener(e,o){this.windowListeners[o]={registered:!1,windowEventName:e,pluginEventName:o,handler:n=>{this.notifyListeners(o,n)}}}unimplemented(e="not implemented"){return new rt.Exception(e,se.Unimplemented)}unavailable(e="not available"){return new rt.Exception(e,se.Unavailable)}async removeListener(e,o){let n=this.listeners[e];if(!n)return;let i=n.indexOf(o);this.listeners[e].splice(i,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){let o=this.retainedEventArguments[e];o&&(delete this.retainedEventArguments[e],o.forEach(n=>{this.notifyListeners(e,n)}))}},_t=t=>encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Gt=t=>t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),st=class extends R{async getCookies(){let e=document.cookie,o={};return e.split(";").forEach(n=>{if(n.length<=0)return;let[i,a]=n.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");i=Gt(i).trim(),a=Gt(a).trim(),o[i]=a}),o}async setCookie(e){try{let o=_t(e.key),n=_t(e.value),i=`; expires=${(e.expires||"").replace("expires=","")}`,a=(e.path||"/").replace("path=",""),r=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${o}=${n||""}${i}; path=${a}; ${r};`}catch(o){return Promise.reject(o)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(o){return Promise.reject(o)}}async clearCookies(){try{let e=document.cookie.split(";")||[];for(let o of e)document.cookie=o.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}},pn=U("CapacitorCookies",{web:()=>new st}),So=async t=>new Promise((e,o)=>{let n=new FileReader;n.onload=()=>{let i=n.result;e(i.indexOf(",")>=0?i.split(",")[1]:i)},n.onerror=i=>o(i),n.readAsDataURL(t)}),Co=(t={})=>{let e=Object.keys(t);return Object.keys(t).map(i=>i.toLocaleLowerCase()).reduce((i,a,r)=>(i[a]=t[e[r]],i),{})},$o=(t,e=!0)=>t?Object.entries(t).reduce((n,i)=>{let[a,r]=i,s,c;return Array.isArray(r)?(c="",r.forEach(d=>{s=e?encodeURIComponent(d):d,c+=`${a}=${s}&`}),c.slice(0,-1)):(s=e?encodeURIComponent(r):r,c=`${a}=${s}`),`${n}&${c}`},"").substr(1):null,ko=(t,e={})=>{let o=Object.assign({method:t.method||"GET",headers:t.headers},e),i=Co(t.headers)["content-type"]||"";if(typeof t.data=="string")o.body=t.data;else if(i.includes("application/x-www-form-urlencoded")){let a=new URLSearchParams;for(let[r,s]of Object.entries(t.data||{}))a.set(r,s);o.body=a.toString()}else if(i.includes("multipart/form-data")||t.data instanceof FormData){let a=new FormData;if(t.data instanceof FormData)t.data.forEach((s,c)=>{a.append(c,s)});else for(let s of Object.keys(t.data))a.append(s,t.data[s]);o.body=a;let r=new Headers(o.headers);r.delete("content-type"),o.headers=r}else(i.includes("application/json")||typeof t.data=="object")&&(o.body=JSON.stringify(t.data));return o},ct=class extends R{async request(e){let o=ko(e,e.webFetchExtra),n=$o(e.params,e.shouldEncodeUrlParams),i=n?`${e.url}?${n}`:e.url,a=await fetch(i,o),r=a.headers.get("content-type")||"",{responseType:s="text"}=a.ok?e:{};r.includes("application/json")&&(s="json");let c,d;switch(s){case"arraybuffer":case"blob":d=await a.blob(),c=await So(d);break;case"json":c=await a.json();break;default:c=await a.text()}let p={};return a.headers.forEach((l,u)=>{p[u]=l}),{data:c,headers:p,status:a.status,url:a.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}},mn=U("CapacitorHttp",{web:()=>new ct});(function(t){t.Dark="DARK",t.Light="LIGHT",t.Default="DEFAULT"})(Ht||(Ht={}));(function(t){t.StatusBar="StatusBar",t.NavigationBar="NavigationBar"})(Kt||(Kt={}));lt=class extends R{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}},fn=U("SystemBars",{web:()=>new lt})});var Jt={};Ce(Jt,{KeepAwakeWeb:()=>dt});var dt,Wt=pe(()=>{W();dt=class extends R{constructor(){super(...arguments),this.wakeLock=null,this._isSupported=typeof navigator<"u"&&"wakeLock"in navigator,this.handleVisibilityChange=()=>{document.visibilityState==="visible"&&this.keepAwake()}}async keepAwake(){this._isSupported||this.throwUnsupportedError(),this.wakeLock&&await this.allowSleep(),this.wakeLock=await navigator.wakeLock.request("screen"),document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange)}async allowSleep(){var e;this._isSupported||this.throwUnsupportedError(),(e=this.wakeLock)===null||e===void 0||e.release(),this.wakeLock=null,document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange)}async isSupported(){return{isSupported:this._isSupported}}async isKeptAwake(){return this._isSupported||this.throwUnsupportedError(),{isKeptAwake:!!this.wakeLock}}throwUnsupportedError(){throw this.unavailable("Screen Wake Lock API not available in this browser.")}}});var Yt={};Ce(Yt,{Geolocation:()=>Ao,GeolocationWeb:()=>Oe});var Oe,Ao,Zt=pe(()=>{W();Oe=class extends R{async getCurrentPosition(e){return new Promise((o,n)=>{navigator.geolocation.getCurrentPosition(i=>{o(i)},i=>{n(i)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0},e))})}async watchPosition(e,o){return`${navigator.geolocation.watchPosition(i=>{o(i)},i=>{o(null,i)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0,minimumUpdateInterval:5e3},e))}`}async clearWatch(e){navigator.geolocation.clearWatch(parseInt(e.id,10))}async checkPermissions(){if(typeof navigator>"u"||!navigator.permissions)throw this.unavailable("Permissions API not available in this browser");let e=await navigator.permissions.query({name:"geolocation"});return{location:e.state,coarseLocation:e.state}}async requestPermissions(){throw this.unimplemented("Not implemented on web.")}},Ao=new Oe});var eo={};Ce(eo,{LocalNotificationsWeb:()=>mt});var mt,to=pe(()=>{W();mt=class extends R{constructor(){super(...arguments),this.pending=[],this.deliveredNotifications=[],this.hasNotificationSupport=()=>{if(!("Notification"in window)||!Notification.requestPermission)return!1;if(Notification.permission!=="granted")try{new Notification("")}catch(e){if(e instanceof Error&&e.name==="TypeError")return!1}return!0}}async getDeliveredNotifications(){let e=[];for(let o of this.deliveredNotifications){let n={title:o.title,id:parseInt(o.tag),body:o.body};e.push(n)}return{notifications:e}}async removeDeliveredNotifications(e){for(let o of e.notifications){let n=this.deliveredNotifications.find(i=>i.tag===String(o.id));n?.close(),this.deliveredNotifications=this.deliveredNotifications.filter(()=>!n)}}async removeAllDeliveredNotifications(){for(let e of this.deliveredNotifications)e.close();this.deliveredNotifications=[]}async createChannel(){throw this.unimplemented("Not implemented on web.")}async deleteChannel(){throw this.unimplemented("Not implemented on web.")}async listChannels(){throw this.unimplemented("Not implemented on web.")}async schedule(e){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");for(let o of e.notifications)this.sendNotification(o);return{notifications:e.notifications.map(o=>({id:o.id}))}}async getPending(){return{notifications:this.pending}}async registerActionTypes(){throw this.unimplemented("Not implemented on web.")}async cancel(e){this.pending=this.pending.filter(o=>!e.notifications.find(n=>n.id===o.id))}async areEnabled(){let{display:e}=await this.checkPermissions();return{value:e==="granted"}}async changeExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async checkExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async requestPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(await Notification.requestPermission())}}async checkPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(Notification.permission)}}transformNotificationPermission(e){switch(e){case"granted":return"granted";case"denied":return"denied";default:return"prompt"}}sendPending(){var e;let o=[],n=new Date().getTime();for(let i of this.pending)!((e=i.schedule)===null||e===void 0)&&e.at&&i.schedule.at.getTime()<=n&&(this.buildNotification(i),o.push(i));this.pending=this.pending.filter(i=>!o.find(a=>a===i))}sendNotification(e){var o;if(!((o=e.schedule)===null||o===void 0)&&o.at){let n=e.schedule.at.getTime()-new Date().getTime();this.pending.push(e),setTimeout(()=>{this.sendPending()},n);return}this.buildNotification(e)}buildNotification(e){let o=new Notification(e.title,{body:e.body,tag:String(e.id)});return o.addEventListener("click",this.onClick.bind(this,e),!1),o.addEventListener("show",this.onShow.bind(this,e),!1),o.addEventListener("close",()=>{this.deliveredNotifications=this.deliveredNotifications.filter(()=>!this)},!1),this.deliveredNotifications.push(o),o}onClick(e){let o={actionId:"tap",notification:e};this.notifyListeners("localNotificationActionPerformed",o)}onShow(e){this.notifyListeners("localNotificationReceived",e)}}});var oo={};Ce(oo,{DialogWeb:()=>gt});var gt,no=pe(()=>{W();gt=class extends R{async alert(e){window.alert(e.message)}async prompt(e){let o=window.prompt(e.message,e.inputText||"");return{value:o!==null?o:"",cancelled:o===null}}async confirm(e){return{value:window.confirm(e.message)}}}});var _=null,me=null,$e=null,x=null,f=null,Te=null,J=new Map;function Nt(){return f=L.map("map",{zoomControl:!1}).setView([19.83,-90.528],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(f),L.control.zoom({position:"bottomright"}).addTo(f),x=L.layerGroup().addTo(f),Te=L.layerGroup().addTo(f),f}function ie(t){return $e?$e.setLatLng(t):$e=L.marker(t,{icon:L.divIcon({className:"user-marker",html:'<div style="background-color: #007bff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',iconSize:[20,20]})}).addTo(f),$e}function Ae(t){let e=[];if(t.forEach(n=>{n.filter(a=>a.tipo==="bus").forEach(a=>{e.push(a.ruta)})}),e.length===0)return;let o=turf.featureCollection(e);_=L.geoJSON(o,{style:n=>{let i="#"+Math.floor(Math.random()*16777215).toString(16);if(t.length===1){let a=t[0],r=a.find(p=>p.tipo==="bus"),s=a.filter(p=>p.tipo==="bus")[1],c=a.filter(p=>p.tipo==="bus")[2],d=a.filter(p=>p.tipo==="bus")[3];r&&n.properties.id===r.ruta.properties.id&&(i="#FF0000"),s&&n.properties.id===s.ruta.properties.id&&(i="#0052FF"),c&&n.properties.id===c.ruta.properties.id&&(i="#00A86B"),d&&n.properties.id===d.ruta.properties.id&&(i="#FF8C00")}return{color:i,weight:5,opacity:.7}}}).addTo(f),_.getBounds().isValid()&&f.fitBounds(_.getBounds().pad(.1))}function ae(){_&&(f.removeLayer(_),_=null),me&&(f.hasLayer(me)&&f.removeLayer(me),me=null)}var ke=L.divIcon({className:"paradero-icono-koox",iconSize:[16,16]}),Qe=L.divIcon({className:"paradero-icono-transbordo",iconSize:[16,16]}),Me=L.divIcon({className:"paradero-icono-destino",iconSize:[16,16]});function q(t,e=null){let o=t.properties.nombre||t.properties.Name,n=t.properties.originalIndex,i=(t.properties.rutas||[]).join(", "),a=`<div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">${o}</div>`;if(e){let r="#333";(e.includes("Subir")||e.includes("Inicio"))&&(r="#007bff"),e.includes("Transbordo")&&(r="#E69500"),(e.includes("Destino")||e.includes("Bajar"))&&(r="#dc3545"),a=`
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${r};">${e}</div>
            <div style="font-size: 1.0em; font-weight: bold; margin-bottom: 5px;">${o}</div>`}return`
        ${a}
        <strong style="font-size: 0.9em;">Rutas:</strong>
        <p style="font-size: 0.9em; margin: 4px 0;">${i||"N/A"}</p>
        <button class="btn-popup btn-ver-rutas-paradero" data-paradero-id="${n}">
            Ver detalles
        </button>
    `}function Dt(t,e){ae(),x.clearLayers();let o=e.geometry.coordinates,n=[o[1],o[0]],i;switch(t.tipo){case"caminar":let a=t.paradero.geometry.coordinates,r=[a[1],a[0]];me=L.polyline([n,r],{}).addTo(f),L.marker(r,{icon:ke}).addTo(x).bindPopup(q(t.paradero,"Dir\xEDgete aqu\xED")),i=L.latLngBounds(n,r);break;case"bus":_=L.geoJSON(t.ruta,{}).addTo(f);let s=[t.paraderoInicio.geometry.coordinates[1],t.paraderoInicio.geometry.coordinates[0]],c=[t.paraderoFin.geometry.coordinates[1],t.paraderoFin.geometry.coordinates[0]];L.marker(s,{icon:ke}).addTo(x).bindPopup(q(t.paraderoInicio,"Subir aqu\xED")),L.marker(c,{icon:Me}).addTo(x).bindPopup(q(t.paraderoFin,"Bajar aqu\xED")),i=_.getBounds();break;case"transbordo":let d=[t.paradero.geometry.coordinates[1],t.paradero.geometry.coordinates[0]];L.marker(d,{icon:Qe}).addTo(x).bindPopup(q(t.paradero,"Transbordo Aqu\xED")).openPopup(),f.setView(d,17);break;case"fin":let p=[t.paradero.geometry.coordinates[1],t.paradero.geometry.coordinates[0]];L.marker(p,{icon:Me}).addTo(x).bindPopup(q(t.paradero,"\xA1Destino!")).openPopup(),f.setView(p,17);break}return i}function Ot(t,e){if(ae(),x.clearLayers(),et(),!t)return;_=L.geoJSON(t,{style:{color:"#FF0000",weight:6,opacity:.8}}).addTo(f);let o=e.map(i=>{let a=i.geometry.coordinates,r=[a[1],a[0]],s=i.properties.nombre||i.properties.Name,c=i.properties.originalIndex,d=L.divIcon({className:"paradero-icono-koox",iconSize:[16,16]}),p=q(i);return L.marker(r,{icon:d}).bindPopup(p)});o.forEach(i=>i.addTo(x));let n=L.featureGroup([_,...o]);n.getBounds().isValid()&&f.fitBounds(n.getBounds().pad(.1))}var Lo=t=>L.divIcon({className:"bus-vivo-icono",html:`<span>${(t||"??").replace("koox-","")}</span>`,iconSize:[30,30],iconAnchor:[15,15]});function jt(t,e,o){if(!o||o.length<2||!f)return;let n=Lo(e),i=`<b>Unidad ${t}</b><br>Ruta ${e}`,a={icon:n,zIndexOffset:1e3,rutaId:e};if(J.has(t))J.get(t).setLatLng(o).setIcon(n).getPopup().setContent(i),J.get(t).options.rutaId=e;else{let r=L.marker(o,a).addTo(Te).bindPopup(i);J.set(t,r)}}function Ft(t){J.has(t)&&(Te.removeLayer(J.get(t)),J.delete(t))}function et(){J.forEach(t=>Te.removeLayer(t)),J.clear()}function Be(t,e){let o={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};return navigator.geolocation.watchPosition(t,e,o)}function fe(t){t&&navigator.geolocation.clearWatch(t)}function Ut(t,e){let o=new Map;return t.forEach(n=>{o.set(n.properties.id,new Set)}),e.forEach(n=>{n.properties.rutas.forEach(i=>{o.has(i)&&o.get(i).add(n)})}),o}function ge(t,e,o,n,i){console.log(`Buscando rutas \xF3ptimas desde "${t.properties.nombre}" hasta "${e.properties.nombre}"`);let a=[],r=new Map,s=[],c=1/0,d=4,p=new Map;o.forEach(m=>{p.set(m.properties.originalIndex,m.properties.rutas)});let l=[{tipo:"caminar",paradero:t,texto:`Dir\xEDgete a ${t.properties.nombre}`}];for(r.set(t.properties.nombre,0),a.push(l);a.length>0;){let m=a.shift(),b=m[m.length-1],k=b.tipo==="caminar"?b.paradero:b.paraderoFin,T=m.filter(A=>A.tipo==="bus").length;if(T>=c||T>=d)continue;let Y=p.get(k.properties.originalIndex)||[],ue=new Set(m.filter(A=>A.tipo==="bus").map(A=>A.ruta.properties.id));for(let A of Y){if(ue.has(A))continue;let xe=i.get(A),te=n.find(h=>h.properties.id===A);if(!(!xe||!te))for(let h of xe){if(h.properties.nombre===k.properties.nombre)continue;let I=T+1,B=r.get(h.properties.nombre);if(B&&B<I)continue;r.set(h.properties.nombre,I);let N={tipo:"bus",ruta:te,paraderoInicio:k,paraderoFin:h,texto:`Toma ${te.properties.id} y baja en ${h.properties.nombre}`};h.properties.nombre===e.properties.nombre?(N.texto+=" (Destino)",s.push([...m,N]),c=I):(p.get(h.properties.originalIndex)||[]).some(oe=>!ue.has(oe)&&oe!==A)&&a.push([...m,N])}}}console.log(`B\xFAsqueda finalizada. Se encontraron ${s.length} soluciones (antes de filtrar).`);let u=s.filter(m=>m.filter(b=>b.tipo==="bus").length===c),g=new Map;u.forEach(m=>{let b=m.filter(k=>k.tipo==="bus").map(k=>k.ruta.properties.id).join("->");g.has(b)||g.set(b,m)});let w=Array.from(g.values());return console.log(`Se encontraron ${w.length} rutas \xF3ptimas \xFAnicas.`),w}function Vt(t,e){t.forEach(n=>{n.properties.rutas=[],e.forEach(i=>{if(i.geometry)try{let a=i;turf.nearestPointOnLine(a,n).properties.dist*1e3<25&&n.properties.rutas.push(i.properties.id)}catch(a){console.warn(`Advertencia Turf: Error al proyectar ${n.properties.nombre} en la ruta ${i.properties.id}.`,a)}})})}var De=null,tt=0,Re=0,Ne=!1,be=null,he=null,ot=0,nt=null,re=!1,Eo=1,wo=3;function zt(t){De=t,tt=0,Re=0,Ne=!1,be=Date.now(),he=De,nt=Date.now(),ot=0,re=!1,console.log("NavigationService: Iniciado.")}function it(){De=null,be=null,he=null,nt=null,re=!1,console.log("NavigationService: Detenido.")}function at(){console.log("NavigationService: Modo Transbordo ACTIVADO."),re=!0}function qt(t,e){if(!De||!be||!he)return null;let o=Date.now(),n=(o-be)/1e3,i=turf.distance(he,t,{units:"meters"});i>1&&(tt+=i),ot=Math.floor((o-nt)/1e3);let a=!1;return e!=null?e>Eo&&(a=!0):i>wo&&(a=!0),a?(Ne=!0,Re=0,re=!1):(Ne=!1,re||(Re+=n)),he=t,be=o,{distanciaRecorrida:tt,tiempoDetenido:Math.round(Re),enMovimiento:Ne,tiempoTotalViaje:ot,enModoTransbordo:re}}W();var ut=U("KeepAwake",{web:()=>Promise.resolve().then(()=>(Wt(),Jt)).then(t=>new t.KeepAwakeWeb)});W();function Mo(t){t.CapacitorUtils.Synapse=new Proxy({},{get(e,o){return new Proxy({},{get(n,i){return(a,r,s)=>{let c=t.Capacitor.Plugins[o];if(c===void 0){s(new Error(`Capacitor plugin ${o} not found`));return}if(typeof c[i]!="function"){s(new Error(`Method ${i} not found in Capacitor plugin ${o}`));return}(async()=>{try{let d=await c[i](a);r(d)}catch(d){s(d)}})()}}})}})}function To(t){t.CapacitorUtils.Synapse=new Proxy({},{get(e,o){return t.cordova.plugins[o]}})}function Xt(t=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},window.Capacitor!==void 0&&!t?Mo(window):window.cordova!==void 0&&To(window))}var pt=U("Geolocation",{web:()=>Promise.resolve().then(()=>(Zt(),Yt)).then(t=>new t.GeolocationWeb)});Xt();W();var Qt;(function(t){t[t.Sunday=1]="Sunday",t[t.Monday=2]="Monday",t[t.Tuesday=3]="Tuesday",t[t.Wednesday=4]="Wednesday",t[t.Thursday=5]="Thursday",t[t.Friday=6]="Friday",t[t.Saturday=7]="Saturday"})(Qt||(Qt={}));var ft=U("LocalNotifications",{web:()=>Promise.resolve().then(()=>(to(),eo)).then(t=>new t.LocalNotificationsWeb)});W();var bt=U("Dialog",{web:()=>Promise.resolve().then(()=>(no(),oo)).then(t=>new t.DialogWeb)});async function Bo(){try{await ut.keepAwake(),console.log("Modo KeepAwake activado: La pantalla no se apagar\xE1.")}catch(t){console.error("Error al activar KeepAwake:",t)}}async function Ro(){try{if((await pt.checkPermissions()).location!=="granted"){let{value:o}=await bt.confirm({title:"Permiso de Ubicaci\xF3n",message:"Para mostrarte tu posici\xF3n en el mapa y avisarte cuando llegues a tu parada, Rutas Koox necesita acceder a tu ubicaci\xF3n. \xBFNos das permiso?",okButtonTitle:"Claro, activar",cancelButtonTitle:"Ahora no"});o&&(await pt.requestPermissions()).location!=="granted"&&console.warn("El usuario deneg\xF3 el GPS.")}if((await ft.checkPermissions()).display!=="granted"){let{value:o}=await bt.confirm({title:"Alertas de Viaje",message:"\xBFTe gustar\xEDa que te avisemos cuando est\xE9s cerca de bajar del autob\xFAs? Activa las notificaciones para no perder tu parada.",okButtonTitle:"Activar Alertas",cancelButtonTitle:"No gracias"});o&&await ft.requestPermissions()}await ut.keepAwake(),console.log("Modo viaje activo: Pantalla encendida.")}catch(t){console.error("Error al solicitar permisos:",t)}}var No={apiKey:"AIzaSyDozEdN4_g7u-D6XcJdysuns8-iLbfMS5I",authDomain:"rutaskoox-alertas.firebaseapp.com",databaseURL:"https://rutaskoox-alertas-default-rtdb.firebaseio.com/",projectId:"rutaskoox-alertas",storageBucket:"rutaskoox-alertas.firebasestorage.app",messagingSenderId:"332778953247",appId:"1:332778953247:web:4460fef290b88fb1b1932a",measurementId:"G-XH7ZKS825M"};firebase.initializeApp(No);var Do=firebase.firestore(),Oo=firebase.database(),S=[],M=[],fo=null,de=new Map,X=[],v=[],P=0,Ee=!1,ee=null,ne=!0,E=null,y=null,C=null,V=null,le=0,yt,O,Fe,H=null,io,ht=null,ao,_e,Lt,Ue=null,Et=null,wt=null,ro=null,Ve=null,ye=null,Z=null,vt=!1,Pt,$,j,we,Ge,F,z,kt,It,Le,xt,so,He,Ke,St,Ct,$t,Ie,co,lo,ce,uo,ze,Q,G;function jo(t){let e=M.find(o=>o.properties.id===t);return e?`${e.properties.id} (${e.properties.nombre})`:t}function po(t){t?(Ue.textContent=t,Ue.classList.remove("oculto")):Ue.classList.add("oculto")}function Xe(){if(!Et)return;let t=Et.val(),e=ho(),o=Date.now();if(e&&t&&t[e]){let n=t[e],i=jo(e);if(o<n.expiraEn){po(`\u26A0\uFE0F ALERTA: ${n.mensaje} en ${i}`);return}}po(null)}document.addEventListener("DOMContentLoaded",async()=>{Pt=document.getElementById("selectDestino"),$=document.getElementById("inputInicio"),j=document.getElementById("panel-instrucciones"),we=document.getElementById("btnIniciarRuta"),Ge=document.getElementById("btnLimpiar"),F=document.getElementById("panel-control"),z=document.getElementById("panel-navegacion"),kt=document.getElementById("instruccion-actual"),It=document.getElementById("btnAnterior"),Le=document.getElementById("btnSiguiente"),xt=document.getElementById("btnFinalizar"),so=document.getElementById("panel-toggle"),yt=document.getElementById("distancia-restante"),O=document.getElementById("tiempo-espera"),He=document.getElementById("btnModoViaje"),Ke=document.getElementById("btnModoExplorar"),St=document.getElementById("panel-viaje"),Ct=document.getElementById("panel-explorar"),$t=document.getElementById("selectRuta"),Ie=document.getElementById("instrucciones-explorar"),co=document.getElementById("btnLimpiarExplorar"),lo=document.getElementById("btnInfo"),ce=document.getElementById("info-modal"),uo=document.getElementById("btnCloseModal"),Fe=document.getElementById("tiempo-viaje"),io=document.getElementById("btnParaderosCercanos"),ao=document.getElementById("btn-fab-reporte"),Ue=document.getElementById("alert-indicator"),_e=document.getElementById("btnModoReporte"),Lt=document.getElementById("panel-reporte"),Ro(),Bo(),ht=document.getElementById("offline-indicator");let t=()=>{navigator.onLine?ht.classList.add("oculto"):ht.classList.remove("oculto")};window.addEventListener("offline",t),window.addEventListener("online",t),t();try{Oo.ref("alertas").on("value",o=>{Et=o,Xe()})}catch(e){console.error("No se pudo conectar a Firebase Realtime Database",e)}rn(),ze=document.getElementById("selectInicioManual"),Q=document.getElementById("control-input-inicio"),G=document.getElementById("control-select-inicio"),io.addEventListener("click",on),so.addEventListener("click",Go),Ge.addEventListener("click",Pe),we.addEventListener("click",bo),Le.addEventListener("click",Je),It.addEventListener("click",Xo),xt.addEventListener("click",Ko),He.addEventListener("click",()=>je("viaje")),Ke.addEventListener("click",()=>je("explorar")),co.addEventListener("click",Pe),_e.addEventListener("click",()=>je("reporte")),document.querySelectorAll(".btn-reporte").forEach(e=>{e.addEventListener("click",o=>{let n=o.target.dataset.tipo;an(n)})}),ao.addEventListener("click",()=>{ee!==null?(z.classList.add("oculto"),F.classList.remove("oculto")):We(),je("reporte")}),lo.addEventListener("click",()=>ce.classList.remove("oculto")),uo.addEventListener("click",()=>ce.classList.add("oculto")),ce.addEventListener("click",e=>{e.target===ce&&ce.classList.add("oculto")}),F.classList.add("oculto"),z.classList.add("oculto"),G&&(G.style.display="none"),Nt(),f.on("popupopen",e=>{let n=e.popup.getElement().querySelector(".btn-ver-rutas-paradero");n&&n.addEventListener("click",nn)}),f.on("contextmenu",e=>{if(e.originalEvent.preventDefault(),!y){alert("Por favor, selecciona un punto de inicio o espera a que tu GPS se active antes de fijar un destino.");return}console.log("Clic largo detectado. Buscando paradero m\xE1s cercano...");let o=turf.point([e.latlng.lng,e.latlng.lat]),n=Mt(o);if(!n){alert("No se encontraron paraderos cercanos a ese punto.");return}C=n,V.setChoiceByValue(n.properties.originalIndex),console.log(`Destino fijado en: ${C.properties.nombre}`),X=ge(y,C,S,M,de),Ze(X),We()});try{let[e,o]=await Promise.all([fetch("data/paraderos.geojson"),fetch("data/rutas.geojson")]),n=await e.json(),i=await o.json();S=n.features.map((a,r)=>(a.properties.originalIndex=r,a)).filter(a=>!a||!a.geometry||!a.geometry.coordinates||a.geometry.coordinates.length<2||typeof a.geometry.coordinates[0]!="number"||typeof a.geometry.coordinates[1]!="number"?(console.warn(`Paradero inv\xE1lido/sin coordenadas en \xEDndice ${a.properties.originalIndex} (${a.properties.name}). Omitiendo.`),!1):!0),S.forEach(a=>{let r=a.properties;a.properties.nombre=r.nombre||r.Name||r.Paradero||r.NOMVIAL||"Paradero sin nombre"}),S.sort((a,r)=>a.properties.nombre.localeCompare(r.properties.nombre)),M=i.features,M.forEach(a=>{let r=a.properties,s=r.name||r.Name||r.Ruta||"Ruta desconocida";a.properties.id=s.split(" ").slice(0,2).join("-").toLowerCase(),a.properties.nombre=s.split(" ").slice(2).join(" ")}),console.log("Enlazando paraderos a rutas..."),Vt(S,M),console.log("Creando mapa de b\xFAsqueda de rutas..."),de=Ut(M,S),console.log("\xA1Enlace completado!"),fo=turf.featureCollection(S),Vo(),zo(),qo(),ye=Be(go,Ye),At()}catch(e){console.error("Error cargando o procesando los datos GeoJSON:",e)}});function go(t){let e=t.coords.latitude,o=t.coords.longitude;if(e===0&&o===0){console.error("Posici\xF3n GPS inv\xE1lida (0,0) detectada."),vt||(Ye({code:0,message:"Posici\xF3n GPS inv\xE1lida (0,0)"}),$.value="Error de GPS (0,0)");return}E=turf.point([o,e]),y=Mt(E),$.value=`Cerca de "${y.properties.nombre}"`,$.style.fontStyle="normal",$.style.color="black",$.style.fontWeight="normal",vt||(vt=!0,f.setView([e,o],16),ie([e,o]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup())}function Ye(t){console.warn(`ERROR DE UBICACI\xD3N (${t.code}): ${t.message}`),$.value="Ubicaci\xF3n bloqueada",$.style.color="red",$.style.fontWeight="bold";let e="GPS bloqueado o desactivado",o="Parece que tu navegador (como el de Facebook) bloquea la geolocalizaci\xF3n o el permiso fue denegado.";t.code===2?(e="GPS no disponible",o="No pudimos obtener una se\xF1al de GPS. Revisa que tu ubicaci\xF3n est\xE9 encendida."):(t.code===0||t.message==="Posici\xF3n GPS inv\xE1lida (0,0)")&&(e="Error de GPS",o="Tu GPS report\xF3 una ubicaci\xF3n inv\xE1lida (0,0). Intenta moverte a un \xE1rea con mejor se\xF1al."),j.innerHTML=`
        <div class="alerta-manual">
            <h5 style="margin-top:0;">${e}</h5>
            <p>${o}</p>
            <p><strong>Soluciones:</strong></p>
            <div class="alerta-manual-botones">
                <button id="btnModoManual" class="btn-alerta btn-primario">
                    \u{1F4CD} Usar Modo Manual
                </button>
                <button id="btnCopiarLink" class="btn-alerta btn-secundario">
                    \u{1F4CB} Copiar Link
                </button>
            </div>
            <small style="display: block; margin-top: 10px; text-align: center;">
                (Puedes copiar el link y pegarlo en Chrome o Safari)
            </small>
        </div>
    `,document.getElementById("btnModoManual").addEventListener("click",Fo),document.getElementById("btnCopiarLink").addEventListener("click",Uo)}function Fo(){console.log("Activando modo manual"),Q&&(Q.style.display="none"),G&&(G.style.display="block"),j.innerHTML=`
        <p>Has activado el modo manual.</p>
        <p>1. Selecciona tu <strong>paradero de inicio</strong>.</p>
        <p>2. Selecciona tu <strong>paradero de destino</strong>.</p>
    `,y=null,E=null}function Uo(){try{navigator.clipboard.writeText(window.location.href),alert(`\xA1Link copiado al portapapeles!

P\xE9galo en un navegador como Chrome, Safari o Firefox para un mejor funcionamiento.`)}catch(t){console.error("Error al copiar link:",t),alert("No se pudo copiar el link. Por favor, hazlo manualmente desde la barra de direcciones.")}}function Vo(){let t=S.map(e=>{let o=e.properties,n=o.NOMVIAL||o.calle_cercana||"",i=o.NOM_COL||o.colonia_cercana||"";return{value:o.originalIndex,label:o.nombre,customProperties:{calle:n,colonia:i}}});V=new Choices(Pt,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe paradero, calle o colonia...",shouldSort:!1,removeItemButton:!0,searchFields:["label","customProperties.calle","customProperties.colonia"],callbackOnCreateTemplates:function(e){return{item:({classNames:o},n)=>{let i=n.customProperties||{},a=i.calle||i.colonia||"";return e(`<div class="${o.item} ${n.highlighted?o.highlightedState:o.itemSelectable}" data-item data-value="${n.value}" ${n.active?'aria-selected="true"':""} ${n.disabled?'aria-disabled="true"':""}>
                            <span>${n.label}</span>
                            <small>${a}</small> </div>`)},choice:({classNames:o},n)=>{let i=n.customProperties||{},a=i.calle||i.colonia||"";return e(`<div class="${o.item} ${o.itemChoice} ${n.disabled?o.itemDisabled:o.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${n.disabled?'data-choice-disabled aria-disabled="true"':"data-choice-selectable"}" data-id="${n.id}" data-value="${n.value}" ${n.groupId>0?'role="treeitem"':'role="option"'}>
                            <span>${n.label}</span>
                            <small>${a}</small> </div>`)}}}}),Pt.addEventListener("change",e=>{if(!y){alert("Espera a que se detecte tu ubicaci\xF3n o selecciona un inicio manual."),V.clearInput(),V.removeActiveItems();return}let o=e.detail.value;o&&(C=S.find(i=>i.properties.originalIndex==o),X=ge(y,C,S,M,de),Ze(X))})}function zo(){if(!ze)return;let t=S.map(e=>{let o=e.properties,n=o.NOMVIAL||o.calle_cercana||"",i=o.NOM_COL||o.colonia_cercana||"";return{value:o.originalIndex,label:o.nombre,customProperties:{calle:n,colonia:i}}});Z=new Choices(ze,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe paradero, calle o colonia...",shouldSort:!1,removeItemButton:!0,searchFields:["label","customProperties.calle","customProperties.colonia"],callbackOnCreateTemplates:function(e){return{item:({classNames:o},n)=>{let i=n.customProperties||{},a=i.calle||i.colonia||"";return e(`<div class="${o.item} ${n.highlighted?o.highlightedState:o.itemSelectable}" data-item data-value="${n.value}" ${n.active?'aria-selected="true"':""} ${n.disabled?'aria-disabled="true"':""}>
                            <span>${n.label}</span>
                            <small>${a}</small> </div>`)},choice:({classNames:o},n)=>{let i=n.customProperties||{},a=i.calle||i.colonia||"";return e(`<div class="${o.item} ${o.itemChoice} ${n.disabled?o.itemDisabled:o.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${n.disabled?'data-choice-disabled aria-disabled="true"':"data-choice-selectable"}" data-id="${n.id}" data-value="${n.value}" ${n.groupId>0?'role="treeitem"':'role="option"'}>
                            <span>${n.label}</span>
                            <small>${a}</small> </div>`)}}}}),ze.addEventListener("change",e=>{let o=e.detail.value;o&&(y=S.find(n=>n.properties.originalIndex==o),console.log("Inicio manual fijado:",y.properties.nombre),C&&(X=ge(y,C,S,M,de),Ze(X)))})}function je(t){St.classList.add("oculto"),Ct.classList.add("oculto"),Lt.classList.add("oculto"),He.classList.remove("activo"),Ke.classList.remove("activo"),_e.classList.remove("activo");let e=ee!==null;t==="viaje"?e?(F.classList.add("oculto"),z.classList.remove("oculto")):(St.classList.remove("oculto"),He.classList.add("activo"),Pe()):t==="explorar"?e?(F.classList.add("oculto"),z.classList.remove("oculto")):(Ct.classList.remove("oculto"),Ke.classList.add("activo"),Pe()):t==="reporte"&&(Lt.classList.remove("oculto"),_e.classList.add("activo")),Xe()}function qo(){M.sort((e,o)=>e.properties.id.localeCompare(o.properties.id,void 0,{numeric:!0}));let t=M.map(e=>({value:e.properties.id,label:`${e.properties.id} (${e.properties.nombre})`}));H=new Choices($t,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe para filtrar...",shouldSort:!1}),$t.addEventListener("change",e=>{e.detail.value&&_o(e.detail.value)})}function _o(t){let e=M.find(i=>i.properties.id===t);if(!e)return;let o=de.get(t),n=o?[...o]:[];Ot(e,n),Xe(),vo(t,null),Ie.innerHTML=`
        <p>Mostrando <strong>${e.properties.id}</strong>.</p>
        <p>Esta ruta tiene aproximadamente <strong>${n.length}</strong> paraderos.</p>
    `}function Pe(){if(Ae([]),ae(),Xe(),x.clearLayers(),Bt(),j.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>",At(),z.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",O.className="",it(),fe(ee),V&&(V.clearInput(),V.removeActiveItems()),G&&(G.style.display="none"),Q&&(Q.style.display="block"),Z&&(Z.clearInput(),Z.removeActiveItems()),V&&(V.clearInput(),V.removeActiveItems()),Z&&(Z.clearInput(),Z.removeActiveItems()),H&&(H.clearInput(),H.removeActiveItems()),G&&(G.style.display="none"),Q&&(Q.style.display="block"),we.style.display="none",Ge.style.display="none",Ie.innerHTML="Selecciona una ruta para ver su trayecto y paraderos.",z.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",O.className="",it(),fe(ee),ee=null,E){y=Mt(E),$.value=`Cerca de "${y.properties.nombre}"`,$.style.color="black",$.style.fontWeight="normal";let t=E.geometry.coordinates;f.setView([t[1],t[0]],16),ie([t[1],t[0]]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup()}else y=null,$.value="Detectando ubicaci\xF3n...",$.style.color="black",$.style.fontWeight="normal"}function Go(){ee!==null?(z.classList.toggle("oculto"),F.classList.contains("oculto")||F.classList.add("oculto")):F.classList.toggle("oculto")}function Ze(t){j.innerHTML="",x.clearLayers(),ae();let e=E||y;if(!e){j.innerHTML="<p><strong>Error:</strong> No se ha fijado un punto de inicio.</p>";return}let o=e.geometry.coordinates;L.marker([o[1],o[0]]).addTo(x).bindPopup(E?"<b>Est\xE1s aqu\xED</b>":`<b>Inicio (Manual):</b><br>${y.properties.nombre}`);let n=C.geometry.coordinates,i=[n[1],n[0]],a=q(C,"Destino Final");if(L.marker(i,{icon:Me}).addTo(x).bindPopup(a),!t||t.length===0)return;let r=t[0],s=r.filter(l=>l.tipo==="bus"),c=r.find(l=>l.tipo==="caminar");if(c){let l=c.paradero,u=l.geometry.coordinates,g=[u[1],u[0]],w=q(l,"Subir aqu\xED");L.marker(g,{icon:ke}).addTo(x).bindPopup(w)}for(let l=0;l<s.length-1;l++){let u=s[l].paraderoFin,g=u.geometry.coordinates,w=[g[1],g[0]],m=q(u,"Transbordo Aqu\xED");L.marker(w,{icon:Qe}).addTo(x).bindPopup(m)}let d=document.createDocumentFragment(),p=document.createElement("p");p.innerHTML=`<strong>Se encontraron ${t.length} opciones:</strong>`,d.appendChild(p),t.forEach((l,u)=>{let g=document.createElement("div");g.className="opcion-ruta";let w=l.filter(T=>T.tipo==="bus").map(T=>T.ruta.properties.id),m=document.createElement("h4");m.innerHTML=`Opci\xF3n ${u+1} <span style="font-weight:normal; font-size: 0.8em;">(${w.join(" &rarr; ")})</span>`,g.appendChild(m);let b=document.createElement("ol");l.forEach(T=>{if(T.tipo==="caminar"||T.tipo==="bus"){let Y=document.createElement("li");Y.textContent=T.texto,b.appendChild(Y)}}),g.appendChild(b);let k=document.createElement("button");k.className="btn-seleccionar",k.textContent="Seleccionar esta ruta",k.addEventListener("click",()=>{Ho(u)}),g.appendChild(k),d.appendChild(g)}),j.appendChild(d),Ae(t),Ge.style.display="block",we.style.display="none"}var Ho=t=>{v=X[t],le=0;let e=E||y;v.forEach(i=>{let a=0;try{if(i.tipo==="caminar"){a=turf.distance(e,i.paradero,{units:"meters"}),le+=a,e=i.paradero;let r=Math.max(1,Math.round(a/80));i.distanciaMetros=a,i.tiempoEstimadoMin=r,i.texto=`Dir\xEDgete a ${i.paradero.properties.nombre} (${a.toFixed(0)} m - ${r} min \u{1F6B6}\u200D\u2642\uFE0F)`}else if(i.tipo==="bus"){let r=turf.nearestPointOnLine(i.ruta,i.paraderoInicio),s=turf.nearestPointOnLine(i.ruta,i.paraderoFin),c=turf.lineSlice(r,s,i.ruta);a=turf.length(c,{units:"meters"}),le+=a,e=i.paraderoFin,i.distanciaMetros=a,i.texto=`Toma ${i.ruta.properties.id} y baja en ${i.paraderoFin.properties.nombre} (${(a/1e3).toFixed(1)} km)`}else i.tipo==="transbordo"&&(i.texto=`En ${i.paradero.properties.nombre}, espera el siguiente cami\xF3n.`)}catch(r){console.error("Error calculando distancia del paso:",i,r)}}),console.log(`Distancia total de la ruta: ${le} metros`);let n=v.filter(i=>i.tipo==="bus").map(i=>i.ruta.properties.id).join(" \u2192 ");j.innerHTML=`
        <p><strong>Ruta seleccionada. \xA1Listo para navegar!</strong></p>
        <p>${n}</p>
        <p><strong>Distancia total:</strong> ${(le/1e3).toFixed(2)} km</p>
        
        <div class="panel-acciones">
            <button id="btnIniciarRuta">Iniciar Ruta</button>
            <button id="btnGuardarFavorito" class="btn-secundario">\u2B50\uFE0F Guardar Favorito</button>
        </div>
    `,j.querySelector("#btnIniciarRuta").addEventListener("click",bo),j.querySelector("#btnGuardarFavorito").addEventListener("click",()=>{Qo()}),we.style.display="none",Ae([v])};function Mt(t){return turf.nearestPoint(t,fo)}function bo(){if(!(!v||v.length===0)){try{let t=v.filter(o=>o.tipo==="bus").map(o=>o.ruta.properties.id).join(" \u2192 "),e={inicioId:y.properties.originalIndex,inicioNombre:y.properties.nombre,finId:C.properties.originalIndex,finNombre:C.properties.nombre,rutaResumen:t,fecha:new Date().toISOString()};Zo(e)}catch(t){console.error("Error al guardar en el historial:",t)}P=0,Ee=!1,F.classList.add("oculto"),z.classList.remove("oculto"),E?(console.log("Iniciando modo de navegaci\xF3n GPS (Activo)..."),fe(ye),document.getElementById("nav-estado").style.display="flex",ie(E.geometry.coordinates.slice().reverse()),zt(E),ee=Be(Jo,Ye),f.on("dragstart",()=>{ne=!1})):(console.log("Iniciando modo de navegaci\xF3n MANUAL (Pasivo)..."),document.getElementById("nav-estado").style.display="none",ee=null,ne=!0),Rt(P),Tt(P)}}function Ko(){console.log("Finalizando navegaci\xF3n."),z.classList.add("oculto"),F.classList.remove("oculto"),f.off("dragstart"),ye&&fe(ye),ye=Be(go,Ye),Pe()}function Jo(t){let e=t.coords.latitude,o=t.coords.longitude,n=t.coords.speed,i=[e,o];E=turf.point([o,e]),ie(i),ne&&f.panTo(i);let a=qt(E,n);if(a){if(v&&P<v.length){let r=v[P];if(r.tipo==="caminar"||r.tipo==="transbordo"){let s=v[P+1];if(s&&s.tipo==="bus"){let c=s.ruta.properties.id,d=[];f.eachLayer(g=>{g.options&&g.options.rutaId===c&&d.push(g)});let p=null,l=1/0;if(d.forEach(g=>{let w=g.getLatLng(),m=turf.point([w.lng,w.lat]),b=turf.distance(E,m,{units:"meters"})*1e3;b<l&&(l=b,p=g)}),p&&l<20){console.log(`DETECCI\xD3N A BORDO: Distancia ${l.toFixed(2)}m. Asumiendo subida.`),at(!1),Je();return}}}}Yo(a),Wo(a)}}function Wo(t){if(!v||v.length===0||P>=v.length)return;let e=v[P],o=40;if(!E)return;let n=null,i=null;if(e.tipo==="caminar"?n=e.paradero:e.tipo==="bus"&&(n=e.paraderoFin,i=e.ruta),e.tipo==="caminar"&&turf.distance(E,n,{units:"meters"})<25){console.log("Llegaste al paradero de subida, avanzando..."),Je();return}if(e.tipo==="bus"){turf.distance(E,n,{units:"meters"})<300&&!Ee&&(console.log("\xA1Alerta! Bajas pronto."),Ee=!0,navigator.vibrate&&navigator.vibrate([200,100,200]),kt.textContent=`\xA1BAJA PRONTO! (${n.properties.nombre})`);try{let r=turf.nearestPointOnLine(i,E),s=turf.nearestPointOnLine(i,n),c=r.properties.location,d=s.properties.location;if((c-d)*1e3>o){console.log("Detecci\xF3n de Avance: El usuario pas\xF3 el punto de bajada. Avanzando..."),P===v.length-1||(console.log("Activando contador de transbordo..."),at(),navigator.vibrate&&navigator.vibrate([200,100,200,100,200])),Je();return}}catch(r){console.error("Error en l\xF3gica de proyecci\xF3n Turf:",r)}}}function Je(){P<v.length-1&&(P++,ne=!0,Ee=!1,Tt(P),Rt(P))}function Xo(){P>0&&(P--,ne=!0,Ee=!1,Tt(P),Rt(P))}function Tt(t){let e=v[t];kt.textContent=e.texto,It.disabled=t===0;let o=t===v.length-1;Le.disabled=o,xt.style.display="block",o?Le.style.display="none":Le.style.display="block";let i=Dt(e,E||y);ne&&i&&i.isValid()?f.fitBounds(i.pad(.2)):ne&&!i&&f.setView(f.getCenter(),17)}function Yo(t){let e=Math.max(0,le-t.distanciaRecorrida);e>1e3?yt.textContent=`Faltan: ${(e/1e3).toFixed(2)} km`:yt.textContent=`Faltan: ${e.toFixed(0)} m`;let o=7200;if(O.className="",t.enModoTransbordo&&!t.enMovimiento){let r=o-t.tiempoTotalViaje;if(r>0){let s=Math.floor(r/60),c=r%60;O.textContent=`Transbordo: ${s}:${c<10?"0":""}${c}`,O.classList.add("transbordo-timer")}else O.textContent="Tiempo Agotado",O.classList.add("advertencia")}else if(t.enMovimiento)O.textContent="En movimiento",O.classList.add("en-movimiento");else{let r=Math.floor(t.tiempoDetenido/60),s=t.tiempoDetenido%60;O.textContent=`Esperando: ${r}:${s<10?"0":""}${s}`,O.classList.add("advertencia")}let n=7200,i=Math.floor(t.tiempoTotalViaje/60),a=t.tiempoTotalViaje%60;Fe.textContent=`Viaje: ${i}:${a<10?"0":""}${a}`,t.tiempoTotalViaje>n?Fe.classList.add("advertencia"):Fe.classList.remove("advertencia")}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(t=>{console.log("Service Worker: Registrado exitosamente",t.scope)}).catch(t=>{console.log("Service Worker: Fall\xF3 el registro",t)})});function Zo(t){let o=JSON.parse(localStorage.getItem("historialRutas"))||[];o=o.filter(i=>!(i.inicioId===t.inicioId&&i.finId===t.finId)),o.unshift(t);let n=o.slice(0,5);localStorage.setItem("historialRutas",JSON.stringify(n))}function At(){let t=JSON.parse(localStorage.getItem("historialRutas"))||[],e=JSON.parse(localStorage.getItem("favoritasRutas"))||[],o="";if(e.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px;">\u2B50\uFE0F Tus Favoritos:</p>',o+=e.map(n=>`
                <div class="opcion-ruta favorito-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir: ${n.inicioNombre} \u2192 ${n.finNombre}">
                    
                    <span class="delete-favorito" data-nombre="${n.nombre}" title="Borrar favorito">&times;</span>
                    
                    <h4 style="margin-bottom: 5px;">${n.nombre}</h4>
                    <small style="color: #555;">${n.inicioNombre} \u2192 ${n.finNombre}</small>
                </div>
            `).join("")),t.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px; margin-top: 20px;">Tu historial reciente:</p>',o+=t.map(n=>`
                <div class="opcion-ruta historial-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir esta b\xFAsqueda">
                    <h4 style="margin-bottom: 5px;">${n.inicioNombre} \u2192 ${n.finNombre}</h4>
                    <small style="color: #555;">${n.rutaResumen||"Ruta de caminata"}</small>
                </div>
            `).join("")),o===""){j.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>";return}j.innerHTML=o,document.querySelectorAll(".historial-item").forEach(n=>{n.addEventListener("click",mo)}),document.querySelectorAll(".favorito-item").forEach(n=>{n.addEventListener("click",mo)}),document.querySelectorAll(".delete-favorito").forEach(n=>{n.addEventListener("click",tn)})}async function mo(t){let e=t.currentTarget,o=e.dataset.inicioId,n=e.dataset.finId;if(!o||!n)return;console.log(`Cargando historial: Inicio ${o}, Fin ${n}`);let i=S.find(a=>a.properties.originalIndex==o);if(C=S.find(a=>a.properties.originalIndex==n),!i||!C){alert("Error: No se pudieron encontrar los paraderos de esta ruta guardada.");return}y=i,E=null,Q.style.display="none",G.style.display="block",Z.setChoiceByValue(o.toString()),V.setChoiceByValue(n.toString()),X=ge(y,C,S,M,de),Ze(X)}function Qo(){let t=prompt("Dale un nombre a esta ruta (ej. Casa a Oficina):","");if(!(!t||t.trim()===""))try{let e={inicioId:y.properties.originalIndex,inicioNombre:y.properties.nombre,finId:C.properties.originalIndex,finNombre:C.properties.nombre,nombre:t.trim()};en(e)}catch(e){console.error("Error al guardar en favoritos:",e),alert("Error: No se pudo guardar el favorito.")}}function en(t){let e=JSON.parse(localStorage.getItem("favoritasRutas"))||[];e=e.filter(o=>o.nombre!==t.nombre),e.unshift(t),localStorage.setItem("favoritasRutas",JSON.stringify(e)),alert(`\xA1Ruta "${t.nombre}" guardada como favorita!`)}function tn(t){t.stopPropagation();let e=t.currentTarget.dataset.nombre;if(e&&confirm(`\xBFSeguro que quieres borrar el favorito "${e}"?`)){let o=JSON.parse(localStorage.getItem("favoritasRutas"))||[];o=o.filter(n=>n.nombre!==e),localStorage.setItem("favoritasRutas",JSON.stringify(o)),At()}}function on(){if(!E){alert("No se ha podido detectar tu ubicaci\xF3n GPS. Mu\xE9vete a un lugar con mejor se\xF1al o reinicia la app.");return}console.log("Buscando paraderos cercanos..."),ae(),x.clearLayers(),H&&(H.clearInput(),H.removeActiveItems());let e=S.map(r=>{let s=turf.distance(E,r,{units:"meters"});return{paradero:r,distancia:s}}).sort((r,s)=>r.distancia-s.distancia).slice(0,5),o=[],n='<p><strong>Paraderos m\xE1s cercanos a ti:</strong></p><ol style="padding-left: 20px;">';e.forEach(r=>{let s=r.paradero.geometry.coordinates,c=[s[1],s[0]],d=r.paradero.properties.nombre,p=r.distancia.toFixed(0);n+=`<li style="margin-bottom: 5px;">${d} (aprox. ${p} m)</li>`;let l=r.paradero.properties.originalIndex,u=L.divIcon({className:"paradero-icono-koox",iconSize:[16,16]}),g=(r.paradero.properties.rutas||[]).join(", "),w=`
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">${d}</div>
            <p style="font-size: 0.9em; margin: 4px 0;">Aprox. ${p} m</p>
            <strong style="font-size: 0.9em;">Rutas:</strong>
            <p style="font-size: 0.9em; margin: 4px 0;">${g||"N/A"}</p>
            <button class="btn-popup btn-ver-rutas-paradero" data-paradero-id="${l}">
                Ver detalles
            </button>
        `,m=L.marker(c,{icon:u}).bindPopup(w);m.addTo(x),o.push(m)}),n+="</ol>",Ie.innerHTML=n;let i=ie(E.geometry.coordinates.slice().reverse()),a=L.featureGroup([i,...o]);a.getBounds().isValid()&&f.fitBounds(a.getBounds().pad(.2)),We()}function nn(t){let e=t.target.dataset.paraderoId;if(!e)return;let o=S.find(r=>r.properties.originalIndex==e);if(!o)return;let i=(o.properties.rutas||[]).map(r=>M.find(s=>s.properties.id===r)).filter(Boolean),a=`<p>Mostrando rutas para:</p>
                <h4 style="margin-top:0;">${o.properties.nombre}</h4>`;i.length>0?(a+='<ul style="padding-left: 20px; margin-top: 10px;">',i.forEach(r=>{a+=`<li style="margin-bottom: 5px;">
                        <strong>${r.properties.id}</strong>
                        <small>(${r.properties.nombre})</small>
                    </li>`}),a+="</ul>"):a+="<p>No hay rutas registradas para este paradero.</p>",Ie.innerHTML=a,f.closePopup(),We()}function We(){F.classList.contains("oculto")&&F.classList.remove("oculto")}function ho(){if(v&&v.length>0&&P<v.length){let t=v[P];if(t.tipo==="bus")return t.ruta.properties.id}if(H&&H.getValue(!0))return H.getValue(!0);if(y&&z.classList.contains("oculto")){let t=y.properties.rutas||[];if(t.length>0)return t[0]}return null}async function an(t){let e=ho();if(!e){alert("Por favor, inicia una navegaci\xF3n o selecciona una ruta en 'Explorar' para poder reportar un incidente sobre ella.");return}console.log(`Enviando reporte a Firebase: ${t} en ${e}`);try{await Do.collection("reportes_pendientes").add({tipo:t,rutaId:e,timestamp:firebase.firestore.FieldValue.serverTimestamp()}),alert(`\xA1Gracias! Tu reporte para la ruta ${e} ha sido enviado.`)}catch(o){console.error("Error al enviar reporte a Firebase:",o),alert("No se pudo enviar el reporte. Revisa tu conexi\xF3n a internet.")}}function Bt(){Ve&&(Ve(),Ve=null,console.log("Escucha de buses en vivo DETENIDA.")),et(),qe(null)}function qe(t){let e=document.getElementById("eta-info");if(!e)return;if(!t){e.style.display="none",e.innerHTML="";return}let o=`<strong>Pr\xF3ximo bus (Unidad ${t.id}):</strong>`;t.etaMinutos?o+=`<p>Llega a tu parada en aprox. <strong>${t.etaMinutos} min</strong>.</p>`:o+=`<p>Est\xE1 a <strong>${t.distanciaMetros.toFixed(0)} m</strong> de tu parada.</p>`,e.innerHTML=o,e.style.display="block"}function vo(t,e){if(!wt){console.error("Firebase (Gesti\xF3n) no est\xE1 inicializado.");return}Bt();let o=wt.collection("live_locations");t?(o=o.where("routeId","==",t),console.log(`Iniciando escucha de buses SOLO para la ruta: ${t}`)):console.log("Iniciando escucha de TODOS los buses (modo global)"),Ve=o.onSnapshot(n=>{let i=[],a=M.find(r=>r.properties.id===t);if(n.docChanges().forEach(r=>{let s=r.doc.id,c=r.doc.data();if(r.type==="added"||r.type==="modified"){if(!c.lat||!c.lng||!c.routeId)return;if(jt(s,c.routeId,[c.lat,c.lng]),e&&a)try{let d=turf.point([c.lng,c.lat]),p=turf.nearestPointOnLine(a,d),l=turf.nearestPointOnLine(a,e.geometry.coordinates),u=p.properties.location;if(l.properties.location-u>.01){let m=turf.lineSlice(p,l,a),b=turf.length(m,{units:"meters"});i.push({id:s,distanciaMetros:b,speed:c.speed||0})}}catch(d){console.error("Error calculando ETA con Turf:",d)}}else r.type==="removed"&&Ft(s)}),i.length>0){i.sort((c,d)=>c.distanciaMetros-d.distanciaMetros);let r=i[0],s=null;r.speed>1&&(s=Math.round(r.distanciaMetros/r.speed/60)),qe({id:r.id,etaMinutos:s,distanciaMetros:r.distanciaMetros})}else e?(qe({id:"N/A",etaMinutos:null,distanciaMetros:999999}),document.getElementById("eta-info").innerHTML="<p>No hay buses de esta ruta aproxim\xE1ndose a tu parada.</p>"):qe(null)},n=>{console.error("Error en escucha de Firestore:",n)})}function Rt(t){Bt();let e=v[t];if(e&&(e.tipo==="caminar"||e.tipo==="transbordo")){let o=v[t+1];if(o&&o.tipo==="bus"){let n=o.ruta.properties.id,i=o.paraderoInicio;console.log(`Buscando ETA para ${n} en ${i.properties.nombre}`),vo(n,i)}}}function rn(){let t={apiKey:"AIzaSyDcaVTGa3j1YZjbd1D52wNNc1qk7VnrorY",authDomain:"rutaskoox-gestion.firebaseapp.com",projectId:"rutaskoox-gestion",storageBucket:"rutaskoox-gestion.firebasestorage.app",messagingSenderId:"2555756265",appId:"1:2555756265:web:c6f7487ced40a4f6f87538",measurementId:"G-81656MC0ZC"};try{ro=firebase.initializeApp(t,"gestionApp"),wt=ro.firestore(),console.log("Servicio de Gesti\xF3n Firebase inicializado.")}catch(e){console.error("Error inicializando Firebase Gesti\xF3n",e)}}})();
/*! Bundled license information:

@capacitor/core/dist/index.js:
  (*! Capacitor: https://capacitorjs.com/ - MIT License *)
*/
