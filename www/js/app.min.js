(()=>{var bn=Object.defineProperty;var Pe=(e,t)=>()=>(e&&(t=e(e=0)),t);var Je=(e,t)=>{for(var o in t)bn(e,o,{get:t[o],enumerable:!0})};var ve,$e,vn,yn,En,Lt,W,V,xo,Lo,wt,Pa,xn,Ln,wn,In,It,Sa,wo,Io,Pt,ka,ae=Pe(()=>{(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(ve||(ve={}));$e=class extends Error{constructor(t,o,n){super(t),this.message=t,this.code=o,this.data=n}},vn=e=>{var t,o;return e?.androidBridge?"android":!((o=(t=e?.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||o===void 0)&&o.bridge?"ios":"web"},yn=e=>{let t=e.CapacitorCustomPlatform||null,o=e.Capacitor||{},n=o.Plugins=o.Plugins||{},a=()=>t!==null?t.name:vn(e),i=()=>a()!=="web",r=d=>{let l=u.get(d);return!!(l?.platforms.has(a())||s(d))},s=d=>{var l;return(l=o.PluginHeaders)===null||l===void 0?void 0:l.find(m=>m.name===d)},c=d=>e.console.error(d),u=new Map,p=(d,l={})=>{let m=u.get(d);if(m)return console.warn(`Capacitor plugin "${d}" already registered. Cannot register plugins twice.`),m.proxy;let h=a(),g=s(d),f,b=async()=>(!f&&h in l?f=typeof l[h]=="function"?f=await l[h]():f=l[h]:t!==null&&!f&&"web"in l&&(f=typeof l.web=="function"?f=await l.web():f=l.web),f),P=(y,I)=>{var B,j;if(g){let ne=g?.methods.find(_=>I===_.name);if(ne)return ne.rtype==="promise"?_=>o.nativePromise(d,I.toString(),_):(_,ce)=>o.nativeCallback(d,I.toString(),_,ce);if(y)return(B=y[I])===null||B===void 0?void 0:B.bind(y)}else{if(y)return(j=y[I])===null||j===void 0?void 0:j.bind(y);throw new $e(`"${d}" plugin is not implemented on ${h}`,ve.Unimplemented)}},R=y=>{let I,B=(...j)=>{let ne=b().then(_=>{let ce=P(_,y);if(ce){let Ke=ce(...j);return I=Ke?.remove,Ke}else throw new $e(`"${d}.${y}()" is not implemented on ${h}`,ve.Unimplemented)});return y==="addListener"&&(ne.remove=async()=>I()),ne};return B.toString=()=>`${y.toString()}() { [capacitor code] }`,Object.defineProperty(B,"name",{value:y,writable:!1,configurable:!1}),B},G=R("addListener"),O=R("removeListener"),Ie=(y,I)=>{let B=G({eventName:y},I),j=async()=>{let _=await B;O({eventName:y,callbackId:_},I)},ne=new Promise(_=>B.then(()=>_({remove:j})));return ne.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await j()},ne},K=new Proxy({},{get(y,I){switch(I){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return g?Ie:G;case"removeListener":return O;default:return R(I)}}});return n[d]=K,u.set(d,{name:d,proxy:K,platforms:new Set([...Object.keys(l),...g?[h]:[]])}),K};return o.convertFileSrc||(o.convertFileSrc=d=>d),o.getPlatform=a,o.handleError=c,o.isNativePlatform=i,o.isPluginAvailable=r,o.registerPlugin=p,o.Exception=$e,o.DEBUG=!!o.DEBUG,o.isLoggingEnabled=!!o.isLoggingEnabled,o},En=e=>e.Capacitor=yn(e),Lt=En(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),W=Lt.registerPlugin,V=class{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(t,o){let n=!1;this.listeners[t]||(this.listeners[t]=[],n=!0),this.listeners[t].push(o);let i=this.windowListeners[t];i&&!i.registered&&this.addWindowListener(i),n&&this.sendRetainedArgumentsForEvent(t);let r=async()=>this.removeListener(t,o);return Promise.resolve({remove:r})}async removeAllListeners(){this.listeners={};for(let t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,o,n){let a=this.listeners[t];if(!a){if(n){let i=this.retainedEventArguments[t];i||(i=[]),i.push(o),this.retainedEventArguments[t]=i}return}a.forEach(i=>i(o))}hasListeners(t){var o;return!!(!((o=this.listeners[t])===null||o===void 0)&&o.length)}registerWindowListener(t,o){this.windowListeners[o]={registered:!1,windowEventName:t,pluginEventName:o,handler:n=>{this.notifyListeners(o,n)}}}unimplemented(t="not implemented"){return new Lt.Exception(t,ve.Unimplemented)}unavailable(t="not available"){return new Lt.Exception(t,ve.Unavailable)}async removeListener(t,o){let n=this.listeners[t];if(!n)return;let a=n.indexOf(o);this.listeners[t].splice(a,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){let o=this.retainedEventArguments[t];o&&(delete this.retainedEventArguments[t],o.forEach(n=>{this.notifyListeners(t,n)}))}},xo=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Lo=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),wt=class extends V{async getCookies(){let t=document.cookie,o={};return t.split(";").forEach(n=>{if(n.length<=0)return;let[a,i]=n.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");a=Lo(a).trim(),i=Lo(i).trim(),o[a]=i}),o}async setCookie(t){try{let o=xo(t.key),n=xo(t.value),a=`; expires=${(t.expires||"").replace("expires=","")}`,i=(t.path||"/").replace("path=",""),r=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${o}=${n||""}${a}; path=${i}; ${r};`}catch(o){return Promise.reject(o)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(o){return Promise.reject(o)}}async clearCookies(){try{let t=document.cookie.split(";")||[];for(let o of t)document.cookie=o.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}},Pa=W("CapacitorCookies",{web:()=>new wt}),xn=async e=>new Promise((t,o)=>{let n=new FileReader;n.onload=()=>{let a=n.result;t(a.indexOf(",")>=0?a.split(",")[1]:a)},n.onerror=a=>o(a),n.readAsDataURL(e)}),Ln=(e={})=>{let t=Object.keys(e);return Object.keys(e).map(a=>a.toLocaleLowerCase()).reduce((a,i,r)=>(a[i]=e[t[r]],a),{})},wn=(e,t=!0)=>e?Object.entries(e).reduce((n,a)=>{let[i,r]=a,s,c;return Array.isArray(r)?(c="",r.forEach(u=>{s=t?encodeURIComponent(u):u,c+=`${i}=${s}&`}),c.slice(0,-1)):(s=t?encodeURIComponent(r):r,c=`${i}=${s}`),`${n}&${c}`},"").substr(1):null,In=(e,t={})=>{let o=Object.assign({method:e.method||"GET",headers:e.headers},t),a=Ln(e.headers)["content-type"]||"";if(typeof e.data=="string")o.body=e.data;else if(a.includes("application/x-www-form-urlencoded")){let i=new URLSearchParams;for(let[r,s]of Object.entries(e.data||{}))i.set(r,s);o.body=i.toString()}else if(a.includes("multipart/form-data")||e.data instanceof FormData){let i=new FormData;if(e.data instanceof FormData)e.data.forEach((s,c)=>{i.append(c,s)});else for(let s of Object.keys(e.data))i.append(s,e.data[s]);o.body=i;let r=new Headers(o.headers);r.delete("content-type"),o.headers=r}else(a.includes("application/json")||typeof e.data=="object")&&(o.body=JSON.stringify(e.data));return o},It=class extends V{async request(t){let o=In(t,t.webFetchExtra),n=wn(t.params,t.shouldEncodeUrlParams),a=n?`${t.url}?${n}`:t.url,i=await fetch(a,o),r=i.headers.get("content-type")||"",{responseType:s="text"}=i.ok?t:{};r.includes("application/json")&&(s="json");let c,u;switch(s){case"arraybuffer":case"blob":u=await i.blob(),c=await xn(u);break;case"json":c=await i.json();break;default:c=await i.text()}let p={};return i.headers.forEach((d,l)=>{p[l]=d}),{data:c,headers:p,status:i.status,url:i.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}},Sa=W("CapacitorHttp",{web:()=>new It});(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(wo||(wo={}));(function(e){e.StatusBar="StatusBar",e.NavigationBar="NavigationBar"})(Io||(Io={}));Pt=class extends V{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}},ka=W("SystemBars",{web:()=>new Pt})});var So={};Je(So,{LocalNotificationsWeb:()=>St});var St,ko=Pe(()=>{ae();St=class extends V{constructor(){super(...arguments),this.pending=[],this.deliveredNotifications=[],this.hasNotificationSupport=()=>{if(!("Notification"in window)||!Notification.requestPermission)return!1;if(Notification.permission!=="granted")try{new Notification("")}catch(t){if(t instanceof Error&&t.name==="TypeError")return!1}return!0}}async getDeliveredNotifications(){let t=[];for(let o of this.deliveredNotifications){let n={title:o.title,id:parseInt(o.tag),body:o.body};t.push(n)}return{notifications:t}}async removeDeliveredNotifications(t){for(let o of t.notifications){let n=this.deliveredNotifications.find(a=>a.tag===String(o.id));n?.close(),this.deliveredNotifications=this.deliveredNotifications.filter(()=>!n)}}async removeAllDeliveredNotifications(){for(let t of this.deliveredNotifications)t.close();this.deliveredNotifications=[]}async createChannel(){throw this.unimplemented("Not implemented on web.")}async deleteChannel(){throw this.unimplemented("Not implemented on web.")}async listChannels(){throw this.unimplemented("Not implemented on web.")}async schedule(t){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");for(let o of t.notifications)this.sendNotification(o);return{notifications:t.notifications.map(o=>({id:o.id}))}}async getPending(){return{notifications:this.pending}}async registerActionTypes(){throw this.unimplemented("Not implemented on web.")}async cancel(t){this.pending=this.pending.filter(o=>!t.notifications.find(n=>n.id===o.id))}async areEnabled(){let{display:t}=await this.checkPermissions();return{value:t==="granted"}}async changeExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async checkExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async requestPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(await Notification.requestPermission())}}async checkPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(Notification.permission)}}transformNotificationPermission(t){switch(t){case"granted":return"granted";case"denied":return"denied";default:return"prompt"}}sendPending(){var t;let o=[],n=new Date().getTime();for(let a of this.pending)!((t=a.schedule)===null||t===void 0)&&t.at&&a.schedule.at.getTime()<=n&&(this.buildNotification(a),o.push(a));this.pending=this.pending.filter(a=>!o.find(i=>i===a))}sendNotification(t){var o;if(!((o=t.schedule)===null||o===void 0)&&o.at){let n=t.schedule.at.getTime()-new Date().getTime();this.pending.push(t),setTimeout(()=>{this.sendPending()},n);return}this.buildNotification(t)}buildNotification(t){let o=new Notification(t.title,{body:t.body,tag:String(t.id)});return o.addEventListener("click",this.onClick.bind(this,t),!1),o.addEventListener("show",this.onShow.bind(this,t),!1),o.addEventListener("close",()=>{this.deliveredNotifications=this.deliveredNotifications.filter(()=>!this)},!1),this.deliveredNotifications.push(o),o}onClick(t){let o={actionId:"tap",notification:t};this.notifyListeners("localNotificationActionPerformed",o)}onShow(t){this.notifyListeners("localNotificationReceived",t)}}});var $o={};Je($o,{KeepAwakeWeb:()=>Nt});var Nt,Bo=Pe(()=>{ae();Nt=class extends V{constructor(){super(...arguments),this.wakeLock=null,this._isSupported=typeof navigator<"u"&&"wakeLock"in navigator,this.handleVisibilityChange=()=>{document.visibilityState==="visible"&&this.keepAwake()}}async keepAwake(){this._isSupported||this.throwUnsupportedError(),this.wakeLock&&await this.allowSleep(),this.wakeLock=await navigator.wakeLock.request("screen"),document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange)}async allowSleep(){var t;this._isSupported||this.throwUnsupportedError(),(t=this.wakeLock)===null||t===void 0||t.release(),this.wakeLock=null,document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange)}async isSupported(){return{isSupported:this._isSupported}}async isKeptAwake(){return this._isSupported||this.throwUnsupportedError(),{isKeptAwake:!!this.wakeLock}}throwUnsupportedError(){throw this.unavailable("Screen Wake Lock API not available in this browser.")}}});var Do={};Je(Do,{Geolocation:()=>Nn,GeolocationWeb:()=>nt});var nt,Nn,Ro=Pe(()=>{ae();nt=class extends V{async getCurrentPosition(t){return new Promise((o,n)=>{navigator.geolocation.getCurrentPosition(a=>{o(a)},a=>{n(a)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0},t))})}async watchPosition(t,o){return`${navigator.geolocation.watchPosition(a=>{o(a)},a=>{o(null,a)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0,minimumUpdateInterval:5e3},t))}`}async clearWatch(t){navigator.geolocation.clearWatch(parseInt(t.id,10))}async checkPermissions(){if(typeof navigator>"u"||!navigator.permissions)throw this.unavailable("Permissions API not available in this browser");let t=await navigator.permissions.query({name:"geolocation"});return{location:t.state,coarseLocation:t.state}}async requestPermissions(){throw this.unimplemented("Not implemented on web.")}},Nn=new nt});var Oo={};Je(Oo,{DialogWeb:()=>Ot});var Ot,jo=Pe(()=>{ae();Ot=class extends V{async alert(t){window.alert(t.message)}async prompt(t){let o=window.prompt(t.message,t.inputText||"");return{value:o!==null?o:"",cancelled:o===null}}async confirm(t){return{value:window.confirm(t.message)}}}});var Z=null,ke=null,Se=null,C=null,v=null,Xe=null,N=new Map,po=document.createElement("style");po.innerHTML=`
    .custom-bus-icon { transition: transform 1s linear; }
    .bus-rotatorio { transition: transform 0.8s ease-out; }
    .bus-interno { transition: transform 0.8s ease-out; }
    .bloquear-animacion, .bloquear-animacion * { transition: none !important; }
`;document.head.appendChild(po);function mo(){return v=L.map("map",{zoomControl:!1}).setView([19.83,-90.528],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(v),L.control.zoom({position:"bottomright"}).addTo(v),C=L.layerGroup().addTo(v),Xe=L.layerGroup().addTo(v),v}var We=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-14]}),bt=L.divIcon({className:"icono-mapa-transbordo",html:'<i class="ri-arrow-left-right-line"></i>',iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-16]}),Ce=L.divIcon({className:"custom-div-icon",html:'<i class="ri-map-pin-fill unselectable icono-mapa-destino"></i>',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});function fe(e){if(Se)return Se.setLatLng(e),Se;let t=L.divIcon({className:"user-gps-marker",iconSize:[20,20],iconAnchor:[10,10]});return Se=L.marker(e,{icon:t,zIndexOffset:1e3}).addTo(v),Se}function J(e,t=null){let o=e.properties.nombre||e.properties.Name,n=e.properties.originalIndex,a=(e.properties.rutas||[]).join(", "),i=`<div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">${o}</div>`;if(t){let r="#333";(t.includes("Subir")||t.includes("Inicio"))&&(r="#0056b3"),t.includes("Transbordo")&&(r="#E69500"),(t.includes("Destino")||t.includes("Bajar"))&&(r="#dc3545"),i=`
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${r};">${t}</div>
            <div style="font-size: 1.0em; font-weight: bold; margin-bottom: 5px;">${o}</div>`}return`
        ${i}
        <strong style="font-size: 0.9em;">Rutas:</strong>
        <p style="font-size: 0.9em; margin: 4px 0;">${a||"N/A"}</p>
        
        <div class="eta-live-badge eta-contenedor-${n}"></div>
        
        <button class="btn-popup btn-ver-rutas-paradero" data-paradero-id="${n}" style="margin-top: 8px;">
            Ver detalles
        </button>
    `}function Ye(e){let t=[];if(e.forEach(n=>{n.filter(i=>i.tipo==="bus").forEach(i=>{t.push(i.ruta)})}),t.length===0)return;let o=turf.featureCollection(t);Z=L.geoJSON(o,{style:n=>{let a="#"+Math.floor(Math.random()*16777215).toString(16);return e.length===1&&(a="#0052FF"),{color:a,weight:5,opacity:.7}}}).addTo(v),Z.getBounds().isValid()&&v.fitBounds(Z.getBounds().pad(.1))}function ge(){Z&&(v.removeLayer(Z),Z=null),ke&&(v.hasLayer(ke)&&v.removeLayer(ke),ke=null)}function fo(e,t){ge(),C.clearLayers();let o=t.geometry.coordinates,n=[o[1],o[0]],a;switch(e.tipo){case"caminar":let i=e.paradero.geometry.coordinates,r=[i[1],i[0]];ke=L.polyline([n,r],{color:"#666",dashArray:"5, 10",weight:4}).addTo(v),L.marker(r,{icon:We}).addTo(C).bindPopup(J(e.paradero,"Dir\xEDgete aqu\xED")),a=L.latLngBounds(n,r);break;case"bus":Z=L.geoJSON(e.ruta,{style:{color:"#0052FF",weight:6}}).addTo(v);let s=[e.paraderoInicio.geometry.coordinates[1],e.paraderoInicio.geometry.coordinates[0]],c=[e.paraderoFin.geometry.coordinates[1],e.paraderoFin.geometry.coordinates[0]];L.marker(s,{icon:We}).addTo(C).bindPopup(J(e.paraderoInicio,"Subir aqu\xED")),L.marker(c,{icon:Ce}).addTo(C).bindPopup(J(e.paraderoFin,"Bajar aqu\xED")),a=Z.getBounds();break;case"transbordo":let u=[e.paradero.geometry.coordinates[1],e.paradero.geometry.coordinates[0]];L.marker(u,{icon:bt}).addTo(C).bindPopup(J(e.paradero,"Transbordo Aqu\xED")).openPopup(),v.setView(u,17);break;case"fin":let p=[e.paradero.geometry.coordinates[1],e.paradero.geometry.coordinates[0]];L.marker(p,{icon:Ce}).addTo(C).bindPopup(J(e.paradero,"\xA1Destino!")).openPopup(),v.setView(p,17);break}return a}function go(e,t){if(ge(),C.clearLayers(),Et(),!e)return;Z=L.geoJSON(e,{style:{color:"#FF0000",weight:6,opacity:.8}}).addTo(v);let o=t.map(a=>{let i=a.geometry.coordinates,r=[i[1],i[0]],s=J(a),c=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-10]});return L.marker(r,{icon:c}).bindPopup(s)});o.forEach(a=>a.addTo(C));let n=L.featureGroup([Z,...o]);n.getBounds().isValid()&&v.fitBounds(n.getBounds().pad(.1))}function vt(e,t){if(!e||!e.latlng||!v)return;let o=e.unit_id,n=parseFloat(e.latlng[0]),a=parseFloat(e.latlng[1]),i=[n,a],r=0,s=e.status===5?0:parseFloat(e.speed)||0;if(N.has(o)){let l=N.get(o),m=l.getLatLng(),h=l.options.lastUpdate||Date.now(),g=Date.now(),f=N.get(o);if(f.options.rutaId=t,typeof turf<"u"){let b=turf.point([m.lng,m.lat]),P=turf.point([a,n]),R=turf.distance(b,P,{units:"meters"}),G=(g-h)/1e3;R>3?(r=turf.bearing(b,P),s===0&&G>0&&G<60&&(s=R/G*3.6)):(r=l.options.angulo||0,s=0)}l.options.lastUpdate=g,l.options.angulo=r}e.velocidadCalculada=s;let c=(t||"??").replace("koox-",""),u=`
        <div class="bus-rotatorio" style="transform: rotate(${r}deg); width: 34px; height: 34px; position: relative;">
            <div style="position: absolute; top: -6px; left: 12px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 8px solid #E69500; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));"></div>
            <div class="bus-interno" style="position: absolute; top: 0; left: 0; background: white; color: #0056b3; width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid #0056b3; box-shadow:0 3px 5px rgba(0,0,0,0.3); transform: rotate(${-r}deg);">
                <span style="font-weight:bold; font-size:13px;">${c}</span>
            </div>
        </div>
    `,p=L.divIcon({className:"custom-bus-icon",html:u,iconSize:[34,34],iconAnchor:[17,17],popupAnchor:[0,-17]}),d=`
        <div style="text-align:center; min-width:140px; font-family:sans-serif;">
            <b style="color:#0056b3; font-size:1.1em;">Ruta ${c}</b><br>
            <span style="font-size:0.9em; color:#555;">Unidad ${e.unit_number||o}</span>
            <hr style="margin:6px 0; border:0; border-top:1px solid #eee;">
            <div style="display:flex; justify-content:space-between; font-size:0.9em;">
                <span>Velocidad:</span>
                <strong>${s.toFixed(1)} km/h</strong>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.9em; margin-top:4px;">
                <span>Estado:</span>
                <strong style="color:${s>1?"#28a745":"#dc3545"};">${s>1?"En movimiento":"Detenido"}</strong>
            </div>
        </div>
    `;if(N.has(o)){let l=N.get(o);l.setLatLng(i),l.setIcon(p),l.getPopup().setContent(d)}else{let l=L.marker(i,{icon:p,zIndexOffset:1e3,angulo:r,lastUpdate:Date.now(),rutaId:t}).addTo(Xe).bindPopup(d);N.set(o,l)}}function yt(e){N.has(e)&&(Xe.removeLayer(N.get(e)),N.delete(e))}function Et(){N.forEach(e=>Xe.removeLayer(e)),N.clear()}function Ze(e,t){let o={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};return navigator.geolocation.watchPosition(e,t,o)}function Me(e){e&&navigator.geolocation.clearWatch(e)}function ho(e,t){let o=new Map;return e.forEach(n=>{o.set(n.properties.id,new Set)}),t.forEach(n=>{n.properties.rutas.forEach(a=>{o.has(a)&&o.get(a).add(n)})}),o}function he(e,t,o,n,a){console.log(`Buscando rutas \xF3ptimas desde "${e.properties.nombre}" hasta "${t.properties.nombre}"`);let i=[],r=new Map,s=[],c=1/0,u=4,p=new Map;o.forEach(g=>{p.set(g.properties.originalIndex,g.properties.rutas)});let d=[{tipo:"caminar",paradero:e,texto:`Dir\xEDgete a ${e.properties.nombre}`}];for(r.set(e.properties.nombre,0),i.push(d);i.length>0;){let g=i.shift(),f=g[g.length-1],b=f.tipo==="caminar"?f.paradero:f.paraderoFin,P=g.filter(O=>O.tipo==="bus").length;if(P>=c||P>=u)continue;let R=p.get(b.properties.originalIndex)||[],G=new Set(g.filter(O=>O.tipo==="bus").map(O=>O.ruta.properties.id));for(let O of R){if(G.has(O))continue;let Ie=a.get(O),K=n.find(y=>y.properties.id===O);if(!(!Ie||!K))for(let y of Ie){if(y.properties.nombre===b.properties.nombre)continue;let I=P+1,B=r.get(y.properties.nombre);if(B&&B<I)continue;r.set(y.properties.nombre,I);let j={tipo:"bus",ruta:K,paraderoInicio:b,paraderoFin:y,texto:`Toma ${K.properties.id} y baja en ${y.properties.nombre}`};y.properties.nombre===t.properties.nombre?(j.texto+=" (Destino)",s.push([...g,j]),c=I):(p.get(y.properties.originalIndex)||[]).some(ce=>!G.has(ce)&&ce!==O)&&i.push([...g,j])}}}console.log(`B\xFAsqueda finalizada. Se encontraron ${s.length} soluciones (antes de filtrar).`);let l=s.filter(g=>g.filter(f=>f.tipo==="bus").length===c),m=new Map;l.forEach(g=>{let f=g.filter(b=>b.tipo==="bus").map(b=>b.ruta.properties.id).join("->");m.has(f)||m.set(f,g)});let h=Array.from(m.values());return console.log(`Se encontraron ${h.length} rutas \xF3ptimas \xFAnicas.`),h}function bo(e,t){e.forEach(n=>{n.properties.rutas=[],t.forEach(a=>{if(a.geometry)try{let i=a;turf.nearestPointOnLine(i,n).properties.dist*1e3<25&&n.properties.rutas.push(a.properties.id)}catch(i){console.warn(`Advertencia Turf: Error al proyectar ${n.properties.nombre} en la ruta ${a.properties.id}.`,i)}})})}function xt(){if(!window.driver||!window.driver.js)return;let e=window.driver.js.driver,t=document.getElementById("panel-control"),o=document.getElementById("panel-navegacion");t&&(t.classList.remove("oculto"),t.style.cssText=""),o&&o.classList.add("oculto");let n=document.getElementById("tour-phantom-anchor");n||(n=document.createElement("div"),n.id="tour-phantom-anchor",n.style.cssText=`
            position: absolute;  /* Usamos absolute para anclarlo al inicio de la p\xE1gina */
            top: 0;
            left: 0;
            width: 100%;
            height: 120px;       /* Altura reducida: Solo cubre el encabezado */
            z-index: 5001;  
            pointer-events: none;
            background: rgba(0,0,0,0); /* Transparente pero "existe" para el navegador */
        `,document.body.appendChild(n)),e({showProgress:!0,animate:!0,overlayOpacity:0,allowClose:!0,overlayClickNext:!1,doneBtnText:"\xA1A explorar!",nextBtnText:"Siguiente",prevBtnText:"Atr\xE1s",onDestroyed:()=>{let i=document.getElementById("tour-phantom-anchor");i&&i.remove()},steps:[{popover:{title:"\u{1F44B} \xA1Hola!",description:"Bienvenido a Rutas Koox. Sigue estos pasos.",side:"center",align:"center"}},{element:".choices__inner-search",popover:{title:"Tu Panel de Control",description:"Aqu\xED arriba escribes tu destino y buscas rutas.",side:"center",align:"center"}},{element:".bottom-nav",popover:{title:"Men\xFA Inferior",description:"Cambia entre Viaje, Explorar y Reportar aqu\xED abajo.",side:"top",align:"center"}}]}).drive()}function vo(){setTimeout(()=>{localStorage.getItem("tour_visto_posicion_v4")||(xt(),localStorage.setItem("tour_visto_posicion_v4","true"))},1e3)}var F=JSON.parse(localStorage.getItem("kooxSettings"))||{darkMode:!1,largeText:!1,highContrast:!1,vibration:!0,tarifaPreferencial:!1},le,de,ue,Ae,be;function yo(){let e=document.body;be&&(be.checked=F.tarifaPreferencial),F.darkMode?(e.classList.add("dark-mode"),le&&(le.checked=!0)):(e.classList.remove("dark-mode"),le&&(le.checked=!1)),F.largeText?(e.classList.add("large-text"),de&&(de.checked=!0)):(e.classList.remove("large-text"),de&&(de.checked=!1)),F.highContrast?(e.classList.add("high-contrast"),ue&&(ue.checked=!0)):(e.classList.remove("high-contrast"),ue&&(ue.checked=!1)),Ae&&(Ae.checked=F.vibration)}function Te(e,t){F[e]=t,localStorage.setItem("kooxSettings",JSON.stringify(F)),yo()}function Eo(){let e=document.getElementById("btnAjustes"),t=document.getElementById("settings-modal"),o=document.getElementById("btnCloseSettings"),n=document.getElementById("btnIniciarRecorrido");le=document.getElementById("checkDarkMode"),de=document.getElementById("checkLargeText"),ue=document.getElementById("checkHighContrast"),Ae=document.getElementById("checkVibration"),e&&t&&e.addEventListener("click",()=>t.classList.remove("oculto")),o&&t&&o.addEventListener("click",()=>t.classList.add("oculto")),n&&n.addEventListener("click",()=>{t&&t.classList.add("oculto"),xt()}),le&&le.addEventListener("change",a=>Te("darkMode",a.target.checked)),de&&de.addEventListener("change",a=>Te("largeText",a.target.checked)),ue&&ue.addEventListener("change",a=>Te("highContrast",a.target.checked)),Ae&&Ae.addEventListener("change",a=>Te("vibration",a.target.checked)),be=document.getElementById("checkTarifa"),be&&(be.checked=F.tarifaPreferencial,be.addEventListener("change",a=>Te("tarifaPreferencial",a.target.checked))),yo()}ae();var Po;(function(e){e[e.Sunday=1]="Sunday",e[e.Monday=2]="Monday",e[e.Tuesday=3]="Tuesday",e[e.Wednesday=4]="Wednesday",e[e.Thursday=5]="Thursday",e[e.Friday=6]="Friday",e[e.Saturday=7]="Saturday"})(Po||(Po={}));var Be=W("LocalNotifications",{web:()=>Promise.resolve().then(()=>(ko(),So)).then(e=>new e.LocalNotificationsWeb)});var kt={general:[12,6,0,0],preferencial:[6,3,0,0]},Pn=5400*1e3,Sn=60*1e3,A=JSON.parse(localStorage.getItem("kooxWallet"))||{saldo:0,viajesEnVentana:0,ultimoCobro:0,ultimaUnidadCobrada:null},Q={ancladoAUnidad:null,tiempoUltimaVezCaminando:Date.now()};function kn(){return A.saldo.toFixed(2)}function Cn(){localStorage.setItem("kooxWallet",JSON.stringify(A));let e=document.getElementById("ui-saldo-virtual");e&&(e.innerText=`$${kn()}`)}function Co(e){e>5?Q.tiempoUltimaVezCaminando=Date.now():Q.ancladoAUnidad&&Date.now()-Q.tiempoUltimaVezCaminando>Sn&&(console.log(`\u{1F6B7} Descenso detectado de la unidad ${Q.ancladoAUnidad}. Candado liberado.`),Q.ancladoAUnidad=null)}async function Mo(e,t){if(Q.ancladoAUnidad)return Q.ancladoAUnidad!==t,void 0;let o=Date.now(),n=F.tarifaPreferencial;o-A.ultimoCobro>Pn&&(A.viajesEnVentana=0);let a=A.ultimaUnidadCobrada===t,i=0,r=!1;if(n)if(a&&A.viajesEnVentana>0){Ct("Tarjeta Bloqueada","No puedes usar la tarifa preferencial dos veces en la misma unidad en menos de 90 min.");return}else{let c=Math.min(A.viajesEnVentana,3);i=kt.preferencial[c],r=!0}else if(a&&A.viajesEnVentana>0)i=kt.general[0],r=!1;else{let c=Math.min(A.viajesEnVentana,3);i=kt.general[c],r=!0}if(A.saldo<i){Ct("Saldo Insuficiente",`Necesitas $${i.toFixed(2)}. Saldo: $${A.saldo.toFixed(2)}`);return}A.saldo-=i,A.ultimoCobro=o,A.ultimaUnidadCobrada=t,r&&A.viajesEnVentana++,Cn(),Q.ancladoAUnidad=t,console.log(`\u{1F512} Usuario anclado f\xEDsicamente a la unidad ${t}`),Ct(`\u2705 ${i===0?"Transbordo Gratuito":"Pasaje Pagado"}`,`Unidad ${t}. Saldo restante: $${A.saldo.toFixed(2)}`)}async function Ct(e,t){console.log(`[MONEDERO] ${e}: ${t}`);try{await Be.schedule({notifications:[{title:e,body:t,id:Math.floor(Math.random()*1e4),schedule:{at:new Date(Date.now()+1e3)},sound:"beep.wav"}]})}catch{alert(`${e}
${t}`)}}var ot=null,Mt=0,et=0,tt=!1,De=null,Re=null,Tt=0,At=null,Oe=!1,Ne=0,Qe=null,Mn=1,Tn=3;function To(e){ot=e,Mt=0,et=0,tt=!1,De=Date.now(),Re=ot,At=Date.now(),Tt=0,Oe=!1,console.log("NavigationService: Iniciado.")}function $t(){ot=null,De=null,Re=null,At=null,Oe=!1,console.log("NavigationService: Detenido.")}function Bt(){console.log("NavigationService: Modo Transbordo ACTIVADO."),Oe=!0}function An(e){let t=null,o=15;return!N||N.size===0?null:(N.forEach((n,a)=>{let i=n.getLatLng(),r=turf.point([i.lng,i.lat]),s=turf.distance(e,r,{units:"meters"});s<o&&(o=s,t={unit_id:a,rutaId:n.options.rutaId||"koox-desconocida",distancia:s})}),t)}function Ao(e,t){if(!e||!e.geometry||!e.geometry.coordinates)return null;let o=(t||0)*3.6,n=e;if(Co(o),o>12&&!Q.ancladoAUnidad){let c=An(n);c?Qe===c.unit_id?(Ne+=3,Ne>=10&&(console.log(`\u{1F68C} Confirmado abordaje en ${c.unit_id}. Procesando pago...`),Mo(c.rutaId,c.unit_id),Ne=0,Qe=null)):(Qe=c.unit_id,Ne=0):(Qe=null,Ne=0)}if(!ot||!De||!Re)return null;let a=Date.now(),i=(a-De)/1e3,r=turf.distance(Re,e,{units:"meters"});r>1&&(Mt+=r),Tt=Math.floor((a-At)/1e3);let s=!1;return t!=null?t>Mn&&(s=!0):r>Tn&&(s=!0),s?(tt=!0,et=0):(tt=!1,Oe||(et+=i)),Re=e,De=a,{distanciaRecorrida:Mt,tiempoDetenido:Math.round(et),enMovimiento:tt,tiempoTotalViaje:Tt,enModoTransbordo:Oe}}ae();var Dt=W("KeepAwake",{web:()=>Promise.resolve().then(()=>(Bo(),$o)).then(e=>new e.KeepAwakeWeb)});ae();function $n(e){e.CapacitorUtils.Synapse=new Proxy({},{get(t,o){return new Proxy({},{get(n,a){return(i,r,s)=>{let c=e.Capacitor.Plugins[o];if(c===void 0){s(new Error(`Capacitor plugin ${o} not found`));return}if(typeof c[a]!="function"){s(new Error(`Method ${a} not found in Capacitor plugin ${o}`));return}(async()=>{try{let u=await c[a](i);r(u)}catch(u){s(u)}})()}}})}})}function Bn(e){e.CapacitorUtils.Synapse=new Proxy({},{get(t,o){return e.cordova.plugins[o]}})}function No(e=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},window.Capacitor!==void 0&&!e?$n(window):window.cordova!==void 0&&Bn(window))}var Rt=W("Geolocation",{web:()=>Promise.resolve().then(()=>(Ro(),Do)).then(e=>new e.GeolocationWeb)});No();ae();var jt=W("Dialog",{web:()=>Promise.resolve().then(()=>(jo(),Oo)).then(e=>new e.DialogWeb)});var je=null;async function Uo(){try{console.log("Intentando iniciar sesi\xF3n...");let e=new firebase.auth.GoogleAuthProvider;return je=(await firebase.auth().signInWithPopup(e)).user,console.log("\u2705 Usuario autenticado:",je.displayName),je}catch(e){throw console.error("\u274C Error en login:",e),alert("No se pudo iniciar sesi\xF3n. Por favor intenta de nuevo."),e}}function Fo(){return je}function Vo(e){firebase.auth().onAuthStateChanged(t=>{je=t,t?console.log("\u{1F504} Sesi\xF3n restaurada:",t.displayName):console.log("\u26AA Modo invitado (sin sesi\xF3n)"),e(t)})}var at=!1;async function zo(e){if(!e)return at=!1,Ut(!1),!1;try{console.log("\u{1F50D} Verificando suscripci\xF3n para:",e);let o=await firebase.firestore().collection("suscripciones").doc(e).get();if(o.exists){let n=o.data(),a=new Date,i=n.fechaExpiracion?n.fechaExpiracion.toDate():null;if(i&&i>a)return at=!0,console.log("\u{1F31F} USUARIO PREMIUM CONFIRMADO. Vence:",i.toLocaleDateString()),Ut(!0),!0}}catch(t){console.error("\u26A0\uFE0F Error consultando suscripci\xF3n:",t)}return console.log("\u{1F464} Usuario Gratuito"),at=!1,Ut(!1),!1}function qo(){return at}function Ut(e){let t=document.getElementById("badge-premium-menu");t&&(t.style.display=e?"inline-block":"none")}function _o(){let e=document.getElementById("info-modal");if(!e)return;let t=e.querySelector(".modal-content");t.innerHTML=`
        <div style="padding: 20px; text-align: center; position: relative;">
            <span id="btnCerrarIndieX" style="position: absolute; right: 10px; top: 10px; font-size: 24px; cursor: pointer; color:#666;">&times;</span>
            
            <div style="font-size: 50px; margin-bottom: 10px;">\u{1F468}\u200D\u{1F4BB}</div>
            <h3 style="color: var(--primary-color); margin-top: 0;">Apoya a Rutas Ko'ox</h3>
            
            <p style="text-align: left; font-size: 0.95em; color: #555; line-height: 1.5;">
                Hola, soy <strong>Alexis</strong>, desarrollador independiente de Campeche. 
                Esta app se mantiene gracias al apoyo de usuarios como t\xFA, no de grandes empresas.
            </p>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid #bbdefb;">
                <h4 style="margin: 0; color: #0d47a1; font-size: 1.1em;">Suscripci\xF3n PRO</h4>
                <div style="font-size: 2.2em; font-weight: 800; color: #1565c0; margin: 5px 0;">$29 <small style="font-size: 0.4em; color: #555;">MXN / Trimestre</small></div>
                <p style="margin:0; font-size: 0.8em; color: #0d47a1;">(Menos de 35 centavos al d\xEDa)</p>
            </div>

            <ul style="text-align: left; font-size: 0.95em; margin-bottom: 25px; list-style: none; padding: 0;">
                <li style="margin-bottom: 8px;">\u2705 <strong>Navegaci\xF3n GPS</strong> en tiempo real</li>
                <li style="margin-bottom: 8px;">\u2705 <strong>Alertas de bajada</strong> (no te duermas)</li>
                <li style="margin-bottom: 8px;">\u2764\uFE0F <strong>Apoyas</strong> el mantenimiento del servidor</li>
            </ul>

            <button id="btnIrAPagar" class="btn-primario-full" style="background-color: #00c853; font-size: 1.1em; margin-bottom: 10px;">
                \u{1F680} Apoyar y Activar Premium
            </button>
            
            <button id="btnCerrarIndie" style="background: none; border: none; color: #777; text-decoration: underline; cursor: pointer; padding: 10px;">
                No por ahora, usar versi\xF3n gratuita
            </button>
        </div>
    `,e.classList.remove("oculto"),document.getElementById("btnIrAPagar").addEventListener("click",()=>{e.classList.add("oculto"),window.app&&window.app.irASeccionRecargas?window.app.irASeccionRecargas():alert("Ve a la secci\xF3n 'Recargas' en el men\xFA inferior.")});let o=()=>{e.classList.add("oculto"),setTimeout(()=>window.location.reload(),300)};document.getElementById("btnCerrarIndie").addEventListener("click",o),document.getElementById("btnCerrarIndieX").addEventListener("click",o)}var re={norte:20,sur:19.7,oeste:-90.75,este:-90.35},Ho=`${re.oeste},${re.norte},${re.este},${re.sur}`;function Go(e,t){let o=parseFloat(e),n=parseFloat(t);return o<=re.norte&&o>=re.sur&&n>=re.oeste&&n<=re.este}function Dn(e){let t=e.toLowerCase().trim(),o={sams:"Sam's Club","sam's":"Sam's Club","sams club":"Sam's Club",walmart:"Walmart",aurrera:"Bodega Aurrera",chedraui:"Chedraui",soriana:"Soriana",imss:"IMSS",issste:"ISSSTE",ado:"Terminal ADO",aeropuerto:"Aeropuerto",areopuerto:"Aeropuerto","mercado municipal":"Mercado Municipal Campeche",cetmar:"Calle Sixto Perez Cuevas","CETMAR 02":"Calle Sixto Perez Cuevas","cetmar 2":"Calle Sixto Perez Cuevas",tec:"Tecnologico",Tec:"Tecnologico",TEC:"Tecnologico",UAC:"Monumento Universidad Aut\xF3noma de Campeche",uac:"Monumento Universidad Aut\xF3noma de Campeche","universidad autonoma de campeche":"monumento Universidad Aut\xF3noma de Campeche","universidad aut\xF3noma de campeche":"Monumento Universidad Aut\xF3noma de Campeche","tec lerma":"Tecnol\xF3gico de Lerma","tec campeche":"Tecnol\xF3gico de Campeche",prevo:"Escuela Secundaria T\xE9cnica No. 1",PREVO:"Escuela Secundaria T\xE9cnica No. 1",SUR:"Terminal de Segunda Clase SUR",sur:"Terminal de Segunda Clase SUR","papa luchon":"\xC1ngel Maya",Fiscalia:"Avenida Jos\xE9 L\xF3pez Portillo",fiscal\u00EDa:"Avenida Jos\xE9 L\xF3pez Portillo","Bola de queso":"Monumentoa los 150 a\xF1os de la Emancipaci\xF3n de Campeche","bola de queso":"Monumentoa los 150 a\xF1os de la Emancipaci\xF3n de Campeche","Naach K'inil":"Monumentoa los 150 a\xF1os de la Emancipaci\xF3n de Campeche"};return o[t]?o[t]:(Object.keys(o).forEach(n=>{let a=new RegExp(`\\b${n}\\b`,"gi");a.test(t)&&(t=t.replace(a,o[n]))}),t)}async function Ft(e,t=8){let o=Dn(e);console.log(`\u{1F9E0} Autocorrector: "${e}" -> "${o}"`);let a="&format=json&limit=40&addressdetails=1&countrycodes=mx&accept-language=es&email=contacto@rutaskoox.com",i=o;/campeche|lerma|china|chinÃ¡/i.test(i)||(i+=", Campeche");let r=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(i)}${a}&viewbox=${Ho}&bounded=1`;try{let s=await fetch(r);if(!s.ok)throw new Error(`Error HTTP: ${s.status}`);let c=await s.json(),u=c.filter(d=>Go(d.lat,d.lon));if(u.length>0)return Ko(u.slice(0,t));console.warn(`\u26A0\uFE0F Intento 1 sin resultados. Probando abierto con: "${o}"`);let p=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(o)}${a}&viewbox=${Ho}`;if(s=await fetch(p),!s.ok)throw new Error(`Error HTTP: ${s.status}`);return c=await s.json(),u=c.filter(d=>Go(d.lat,d.lon)),u.length>0?Ko(u.slice(0,t)):[]}catch(s){return console.error("Error buscando lugar en Nominatim:",s),[]}}function Ko(e){return e.map(t=>({nombre:t.display_name.split(",")[0],direccion:t.display_name,lat:parseFloat(t.lat),lng:parseFloat(t.lon),tipo:t.type}))}var Vt=[{nombre:"Catedral de Campeche",query:"Catedral de Campeche",icono:"ri-church-line"},{nombre:"Baluarte de San Francisco",query:"Baluarte de San Francisco",icono:"ri-ancient-gate-line"},{nombre:"Malec\xF3n de Campeche",query:"Malec\xF3n de Campeche",icono:"ri-road-map-line"},{nombre:"Fuerte de San Miguel",query:"Fuerte de San Miguel Campeche",icono:"ri-flag-line"},{nombre:"Parque Principal",query:"Parque Principal Campeche",icono:"ri-tree-line"},{nombre:"Mercado Pedro Sainz",query:"Mercado Pedro Sainz de Baranda",icono:"ri-store-2-line"}],Jo=[{label:"Salud",query:"Hospital",icono:"ri-hospital-line"},{label:"Escuelas",query:"Escuela",icono:"ri-school-line"},{label:"Super",query:"Supermercado",icono:"ri-shopping-cart-2-line"},{label:"Farmacias",query:"Farmacia",icono:"ri-capsule-line"},{label:"Bancos",query:"Banco",icono:"ri-bank-line"}];function Wo(e,t){if(!t||t.length===0)return[];let o=e.toLowerCase().trim();return t.filter(a=>{let i=a.properties,r=(i.nombre||"").toLowerCase(),s=(i.NOMVIAL||"").toLowerCase(),c=(i.NOM_COL||"").toLowerCase();return r.includes(o)||s.includes(o)||c.includes(o)}).slice(0,15).map(a=>({nombre:a.properties.nombre,lat:a.geometry.coordinates[1],lng:a.geometry.coordinates[0],id:a.properties.originalIndex,tipo:"local"}))}var z={};function Xo(){z={},document.querySelectorAll(".eta-live-badge").forEach(e=>e.innerHTML="")}function zt(e,t,o,n,a){if(!o||!n||n.length===0)return;let i=e.velocidadCalculada;(!i||i<5)&&(i=15);try{let s=turf.nearestPointOnLine(o,t).properties.location,c=turf.length(o,{units:"kilometers"});n.forEach(u=>{let p=u.properties.originalIndex,m=turf.nearestPointOnLine(o,u.geometry.coordinates).properties.location-s;if(m<-.05&&(m=c+m),m>.05&&m<30){let h=m*1e3,g=Math.round(h/i*.06);z[p]||(z[p]={}),(!z[p][a]||z[p][a].etaMinutos>g)&&(z[p][a]={etaMinutos:g,unidad:e.unit_number||e.unit_id,actualizado:Date.now()})}}),Rn(),On()}catch(r){console.warn("Error en el c\xE1lculo de ETA circular:",r)}}function Rn(){let e=Date.now();for(let t in z){for(let o in z[t])e-z[t][o].actualizado>15e3&&delete z[t][o];Object.keys(z[t]).length===0&&(delete z[t],document.querySelectorAll(`.eta-contenedor-${t}`).forEach(o=>o.innerHTML=""))}}function On(){for(let[e,t]of Object.entries(z)){let o=document.querySelectorAll(`.eta-contenedor-${e}`);if(o.length>0){let n="";for(let[a,i]of Object.entries(t))n+=`<div style="color: #d97706; font-size: 0.85em; font-weight: bold; margin-top: 3px; background: #fef3c7; padding: 2px 6px; border-radius: 4px; display: inline-block;">
                            <i class="ri-timer-flash-line"></i> ${a.replace("koox-","")}: Llega en ${i.etaMinutos} min <small>(U-${i.unidad})</small>
                         </div><br>`;o.forEach(a=>a.innerHTML=n)}}}function qt(e,t){if(typeof turf>"u"||!e||!t)return!0;try{return turf.pointToLineDistance(e,t,{units:"kilometers"})*1e3<=150}catch(o){return console.warn("Error en privacyService evaluando distancia. Bus marcado como visible por defecto.",o),!0}}var ye=new Map,_t=new Set,Yo=0,Ue=null;function it(e){ye.clear(),_t=new Set(Array.isArray(e)?e:[e]),Yo=Date.now(),Ue&&clearInterval(Ue),Ue=setInterval(jn,4e3),Fe({tipo:"status-ok"})}function Zo(){Ue&&clearInterval(Ue),ye.clear(),_t.clear(),Fe({tipo:"status-ok"})}function Ht(e,t,o){ye.set(e,{speed:t,rutaId:o,lastUpdate:Date.now()})}function jn(){let e=new Date,t=e.getHours(),o=e.getDay()===0||e.getDay()===6?22:23,n=e.getTime()-12e4;for(let[i,r]of ye.entries())r.lastUpdate<n&&ye.delete(i);if(t>=o||t<5){Fe({tipo:"status-critico",icon:"ri-moon-clear-line",texto:"Servicio finalizado por hoy"});return}let a={};_t.forEach(i=>a[i]=0),ye.forEach(i=>{a[i.rutaId]!==void 0&&a[i.rutaId]++});for(let[i,r]of Object.entries(a))if(!(!i||i==="undefined")&&r===0&&Date.now()-Yo>8e3){let s=String(i).replace("koox-","").toUpperCase();Fe({tipo:"status-critico",icon:"ri-alert-line",texto:`La ruta ${s} no tiene unidades activas.`});return}Fe({tipo:"status-ok"})}function Fe(e){let t=document.getElementById("banner-inteligente-koox");if(t||(t=document.createElement("div"),t.id="banner-inteligente-koox",document.getElementById("map").appendChild(t)),e.tipo==="status-ok"){t.classList.remove("visible");return}t.className=`${e.tipo} visible`,t.innerHTML=`<i class="${e.icon}" style="font-size: 1.2em;"></i> <span>${e.texto}</span>`}async function Un(){try{await Dt.keepAwake(),console.log("Modo KeepAwake activado: La pantalla no se apagar\xE1.")}catch(e){console.error("Error al activar KeepAwake:",e)}}function Fn(e,t){let o;return function(...n){let a=this;clearTimeout(o),o=setTimeout(()=>e.apply(a,n),t)}}async function Vn(){try{if((await Rt.checkPermissions()).location!=="granted"){let{value:o}=await jt.confirm({title:"Permiso de Ubicaci\xF3n",message:"Para mostrarte tu posici\xF3n en el mapa y avisarte cuando llegues a tu parada, Rutas Koox necesita acceder a tu ubicaci\xF3n. \xBFNos das permiso?",okButtonTitle:"Claro, activar",cancelButtonTitle:"Ahora no"});o&&(await Rt.requestPermissions()).location!=="granted"&&console.warn("El usuario deneg\xF3 el GPS.")}if((await Be.checkPermissions()).display!=="granted"){let{value:o}=await jt.confirm({title:"Alertas de Viaje",message:"\xBFTe gustar\xEDa que te avisemos cuando est\xE9s cerca de bajar del autob\xFAs? Activa las notificaciones para no perder tu parada.",okButtonTitle:"Activar Alertas",cancelButtonTitle:"No gracias"});o&&await Be.requestPermissions()}await Dt.keepAwake(),console.log("Modo viaje activo: Pantalla encendida.")}catch(e){console.error("Error al solicitar permisos:",e)}}var ee=null,rt=[],zn={"koox-01":"233","koox-02":"218","koox-03":"219","koox-04":"220","koox-05":"221","koox-06":"222","koox-07":"223","koox-08":"234","koox-10":"236","koox-11":"237","koox-12":"238","koox-13":"232","koox-14":"239","koox-15":"224","koox-16":"225","koox-17":"226","koox-19":"241","koox-20":"242","koox-21":"227","koox-22":"228","koox-23":"229","koox-24":"247","koox-25":"230","koox-26":"243","koox-27":"244"};function sn(e){return e&&zn[e]||null}var qn={apiKey:"AIzaSyDozEdN4_g7u-D6XcJdysuns8-iLbfMS5I",authDomain:"rutaskoox-alertas.firebaseapp.com",databaseURL:"https://rutaskoox-alertas-default-rtdb.firebaseio.com/",projectId:"rutaskoox-alertas",storageBucket:"rutaskoox-alertas.firebasestorage.app",messagingSenderId:"332778953247",appId:"1:332778953247:web:4460fef290b88fb1b1932a",measurementId:"G-XH7ZKS825M"};firebase.initializeApp(qn);var _n=firebase.firestore(),cn=firebase.database(),Hn=()=>{let e=document.getElementById("pantalla-mantenimiento");e&&cn.ref("config/mantenimiento_activo").on("value",t=>{t.val()===!0?(console.warn("\u26A0\uFE0F MODO MANTENIMIENTO ACTIVADO"),e.classList.remove("oculto"),e.style.display="flex"):(console.log("\u2705 Sistema operativo"),e.classList.add("oculto"),e.style.display="none")})};Hn();var M=[],$=[],ln=null,pe=new Map,Y=[],E=[],T=0,qe=!1,Le=null,me=!0,w=null,x=null,k=null,S=null,xe=0,Wt,H,st,oe=null,Qo,Gt=null;var Gn,Xt,ct=null,Yt=null,Kn=null,en=null,Kt=null,Ve=null,ie=null,Jt=!1,lt,D,U,_e,ut,X,q,ro,Zt,ze,Qt,eo,to,oo,He,tn,on,Ee,nn,dt,se,te;function Jn(e){let t=$.find(o=>o.properties.id===e);return t?`${t.properties.id} (${t.properties.nombre})`:e}function an(e){e?(ct.textContent=e,ct.classList.remove("oculto")):ct.classList.add("oculto")}function mt(){if(!Yt)return;let e=Yt.val(),t=pn(),o=Date.now();if(t&&e&&e[t]){let n=e[t],a=Jn(t);if(o<n.expiraEn){an(`\u26A0\uFE0F ALERTA: ${n.mensaje} en ${a}`);return}}an(null)}document.addEventListener("DOMContentLoaded",async()=>{let e=document.getElementById("btnTestSimulador");e&&e.addEventListener("click",()=>{typeof window.simularBus=="function"?window.simularBus():alert("\u26A0\uFE0F Error: La funci\xF3n simularBus no se ha cargado. Revisa el final de tu archivo app.js")});let t=document.getElementById("btnBuscarLugar"),o=document.getElementById("info-lugar-buscado"),n=document.getElementById("contenedor-chips"),a=document.getElementById("btnModoTurista"),i=document.getElementById("btnMinimizarPanel"),r=document.getElementById("btnMinimizarNav");lt=document.getElementById("selectDestino"),D=document.getElementById("inputInicio"),U=document.getElementById("panel-instrucciones"),_e=document.getElementById("btnIniciarRuta"),ut=document.getElementById("btnLimpiar"),X=document.getElementById("panel-control"),q=document.getElementById("panel-navegacion"),ro=document.getElementById("instruccion-actual"),Zt=document.getElementById("btnAnterior"),ze=document.getElementById("btnSiguiente"),Qt=document.getElementById("btnFinalizar"),Wt=document.getElementById("distancia-restante"),H=document.getElementById("tiempo-espera"),eo=document.getElementById("panel-viaje"),to=document.getElementById("panel-explorar"),oo=document.getElementById("selectRuta"),He=document.getElementById("instrucciones-explorar"),tn=document.getElementById("btnLimpiarExplorar"),on=document.getElementById("btnInfo"),Ee=document.getElementById("info-modal"),nn=document.getElementById("btnCloseModal"),st=document.getElementById("tiempo-viaje"),Qo=document.getElementById("btnParaderosCercanos"),ct=document.getElementById("alert-indicator"),Gn=document.getElementById("btnModoReporte"),Xt=document.getElementById("panel-reporte"),Vn(),Eo();let s=document.querySelectorAll(".nav-item"),c=document.getElementById("pantalla-saldo"),u=document.getElementById("pantalla-recargas");s.forEach(l=>{l.addEventListener("click",m=>{let h=m.currentTarget,g=h.dataset.target;if(h.classList.contains("activo")&&(g==="viaje"||g==="explorar"||g==="reporte")){d();return}s.forEach(b=>b.classList.remove("activo")),h.classList.add("activo"),Qn(g)})}),Un(),Gt=document.getElementById("offline-indicator");let p=()=>{navigator.onLine?Gt.classList.add("oculto"):Gt.classList.remove("oculto")};window.addEventListener("offline",p),window.addEventListener("online",p),p();try{cn.ref("alertas").on("value",m=>{Yt=m,mt()})}catch(l){console.error("No se pudo conectar a Firebase Realtime Database",l)}ga(),dt=document.getElementById("selectInicioManual"),se=document.getElementById("control-input-inicio"),te=document.getElementById("control-select-inicio"),Qo.addEventListener("click",pa),ut.addEventListener("click",no),_e.addEventListener("click",un),ze.addEventListener("click",pt),Zt.addEventListener("click",ra),Qt.addEventListener("click",na),tn.addEventListener("click",no),document.querySelectorAll(".btn-reporte").forEach(l=>{l.addEventListener("click",m=>{let h=m.target.dataset.tipo;fa(h)})}),on.addEventListener("click",()=>Ee.classList.remove("oculto")),nn.addEventListener("click",()=>Ee.classList.add("oculto")),Ee.addEventListener("click",l=>{l.target===Ee&&Ee.classList.add("oculto")}),X.classList.add("oculto"),q.classList.add("oculto"),te&&(te.style.display="none"),mo(),n&&Jo.forEach(l=>{let m=document.createElement("button");m.className="chip",m.innerHTML=`<i class="${l.icono}"></i> ${l.label}`,m.addEventListener("click",()=>{hn(`${l.query} en Campeche`)}),n.appendChild(m)}),t&&t.addEventListener("click",()=>{if(S){S.showDropdown();let l=S.input.value;l&&l.length>2&&S.input.element.dispatchEvent(new Event("input",{bubbles:!0}))}}),a&&a.addEventListener("click",()=>{ba()});function d(){X.classList.add("oculto"),q.classList.add("oculto"),document.querySelectorAll(".nav-item").forEach(l=>l.classList.remove("activo"))}i&&i.addEventListener("click",d),r&&r.addEventListener("click",d),v.on("click",()=>{d()}),Vo(async l=>{l?await zo(l.uid):console.log("App iniciada en modo invitado")}),window.app=window.app||{},window.app.irASeccionRecargas=()=>{let l=document.querySelector('.nav-item[data-target="recargas"]');l&&l.click()},v.on("popupopen",l=>{let h=l.popup.getElement().querySelector(".btn-ver-rutas-paradero");h&&h.addEventListener("click",ma)}),v.on("contextmenu",l=>{if(l.originalEvent.preventDefault(),!x){alert("Por favor, selecciona un punto de inicio o espera a que tu GPS se active antes de fijar un destino.");return}console.log("Clic largo detectado. Buscando paradero m\xE1s cercano...");let m=turf.point([l.latlng.lng,l.latlng.lat]),h=gt(m);if(!h){alert("No se encontraron paraderos cercanos a ese punto.");return}k=h,S.setChoiceByValue(h.properties.originalIndex),console.log(`Destino fijado en: ${k.properties.nombre}`),Y=he(x,k,M,$,pe),Ge(Y),we()});try{let[l,m]=await Promise.all([fetch("data/paraderos.geojson"),fetch("data/rutas.geojson")]),h=await l.json(),g=await m.json();M=h.features.map((f,b)=>(f.properties.originalIndex=b,f)).filter(f=>!f||!f.geometry||!f.geometry.coordinates||f.geometry.coordinates.length<2||typeof f.geometry.coordinates[0]!="number"||typeof f.geometry.coordinates[1]!="number"?(console.warn(`Paradero inv\xE1lido/sin coordenadas en \xEDndice ${f.properties.originalIndex} (${f.properties.name}). Omitiendo.`),!1):!0),M.forEach(f=>{let b=f.properties;f.properties.nombre=b.nombre||b.Name||b.Paradero||b.NOMVIAL||"Paradero sin nombre"}),M.sort((f,b)=>f.properties.nombre.localeCompare(b.properties.nombre)),$=g.features,$.forEach(f=>{let b=f.properties,P=b.name||b.Name||b.Ruta||"Ruta desconocida";f.properties.id=P.split(" ").slice(0,2).join("-").toLowerCase(),f.properties.nombre=P.split(" ").slice(2).join(" ")}),console.log("Enlazando paraderos a rutas..."),bo(M,$),console.log("Creando mapa de b\xFAsqueda de rutas..."),pe=ho($,M),console.log("\xA1Enlace completado!"),ln=turf.featureCollection(M),Yn(),Zn(),ea(),Ve=Ze(dn,ft),co()}catch(l){console.error("Error cargando o procesando los datos GeoJSON:",l)}vo()});function dn(e){let t=e.coords.latitude,o=e.coords.longitude;if(t===0&&o===0){console.error("Posici\xF3n GPS inv\xE1lida (0,0) detectada."),Jt||(ft({code:0,message:"Posici\xF3n GPS inv\xE1lida (0,0)"}),D.value="Error de GPS (0,0)");return}w=turf.point([o,t]),x=gt(w),D.value=`Cerca de "${x.properties.nombre}"`,D.style.fontStyle="normal",D.style.color="black",D.style.fontWeight="normal",Jt||(Jt=!0,v.setView([t,o],16),fe([t,o]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup())}function ft(e){console.warn(`ERROR DE UBICACI\xD3N (${e.code}): ${e.message}`),D.value="Ubicaci\xF3n bloqueada",D.style.color="red",D.style.fontWeight="bold";let t="GPS bloqueado o desactivado",o="Parece que tu navegador (como el de Facebook) bloquea la geolocalizaci\xF3n o el permiso fue denegado.";e.code===2?(t="GPS no disponible",o="No pudimos obtener una se\xF1al de GPS. Revisa que tu ubicaci\xF3n est\xE9 encendida."):(e.code===0||e.message==="Posici\xF3n GPS inv\xE1lida (0,0)")&&(t="Error de GPS",o="Tu GPS report\xF3 una ubicaci\xF3n inv\xE1lida (0,0). Intenta moverte a un \xE1rea con mejor se\xF1al."),U.innerHTML=`
        <div class="alerta-manual">
            <h5 style="margin-top:0;">${t}</h5>
            <p>${o}</p>
            <p><strong>Soluciones:</strong></p>
            <div class="alerta-manual-botones">
                <button id="btnModoManual" class="btn-alerta btn-primario">
                    \u{1F4CD} Usar Modo Manual
                </button>
                <button id="btnCopiarLink" class="btn-alerta btn-secundario">
                    \u{1F4CB} Copiar Link
                </button>
            </div>
            <small style="display: block; margin-top: 10px; text-align: center;">
                (Puedes copiar el link y pegarlo en Chrome o Safari)
            </small>
        </div>
    `,document.getElementById("btnModoManual").addEventListener("click",Wn),document.getElementById("btnCopiarLink").addEventListener("click",Xn)}function Wn(){console.log("Activando modo manual"),se&&(se.style.display="none"),te&&(te.style.display="block"),U.innerHTML=`
        <p>Has activado el modo manual.</p>
        <p>1. Selecciona tu <strong>paradero de inicio</strong>.</p>
        <p>2. Selecciona tu <strong>paradero de destino</strong>.</p>
    `,x=null,w=null}function Xn(){try{navigator.clipboard.writeText(window.location.href),alert(`\xA1Link copiado al portapapeles!

P\xE9galo en un navegador como Chrome, Safari o Firefox para un mejor funcionamiento.`)}catch(e){console.error("Error al copiar link:",e),alert("No se pudo copiar el link. Por favor, hazlo manualmente desde la barra de direcciones.")}}function Yn(){S&&S.destroy(),S=new Choices(lt,{choices:[],itemSelectText:"Ir aqu\xED",searchPlaceholderValue:"Escribe un lugar (ej. Walmart, Centro)...",shouldSort:!1,searchResultLimit:20,noResultsText:"Escribe para buscar...",loadingText:"Cargando..."}),window.choicesDestino=S;let e="",t=document.getElementById("loader-busqueda"),o=Fn(async n=>{let a=n.detail.value;if(!a||a.length<2)return;let i=navigator.onLine,r=document.getElementById("loader-busqueda");r&&r.classList.remove("oculto");try{let s=[];if(i){console.log(`\u{1F310} Buscando online: '${a}'`);let c=await Ft(a);c&&c.length>0&&(s=c.map((u,p)=>({value:`ext_${u.lat}_${u.lng}_${p}`,label:`\u{1F4CD} ${u.nombre}`,customProperties:{fullData:u}})))}else{console.log(`\u{1F4F4} Buscando offline en paraderos: '${a}'`);let c=Wo(a,M);c.length>0&&(s=c.map(u=>({value:u.id.toString(),label:`\u{1F68F} ${u.nombre}`,customProperties:{esLocal:!0}}))),s.push({value:"tip_offline",label:"\u{1F4A1} Tip: Sin internet, mant\xE9n presionado el mapa para elegir destino",disabled:!0,customProperties:{tipo:"aviso"}})}(s.length===0||s.length===1&&s[0].value==="tip_offline")&&s.unshift({value:"no_found",label:i?`\u{1F6AB} Nada encontrado para "${a}"`:`\u{1F6AB} Ning\xFAn paradero llamado "${a}"`,disabled:!0}),S.setChoices(s,"value","label",!0)}catch(s){console.error("Error buscando:",s)}finally{r&&r.classList.add("oculto")}},1200);lt.addEventListener("search",o),lt.addEventListener("change",n=>{let a=n.detail.value;if(a.startsWith("ext_")){let i=S._store.choices.find(r=>r.value===a);i&&i.customProperties.fullData&&uo(i.customProperties.fullData)}else{let i=parseInt(a);if(!isNaN(i)){let r=M.find(s=>s.properties.originalIndex===i);if(r)if(console.log("Seleccionado paradero offline:",r.properties.nombre),k=r,x)Y=he(x,k,M,$,pe),Ge(Y),we();else{let s=k.geometry.coordinates;v.setView([s[1],s[0]],16),L.marker([s[1],s[0]],{icon:Ce}).addTo(C).bindPopup(`<b>${k.properties.nombre}</b><br>Destino seleccionado`).openPopup(),U.innerHTML="<p>Destino fijado. Esperando ubicaci\xF3n o selecciona inicio manual.</p>"}}}})}function Zn(){if(!dt)return;let e=M.map(t=>{let o=t.properties,n=o.NOMVIAL||o.calle_cercana||"",a=o.NOM_COL||o.colonia_cercana||"";return{value:o.originalIndex,label:o.nombre,customProperties:{calle:n,colonia:a}}});ie=new Choices(dt,{choices:e,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe paradero, calle o colonia...",shouldSort:!1,removeItemButton:!0,searchFields:["label","customProperties.calle","customProperties.colonia"],callbackOnCreateTemplates:function(t){return{item:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return t(`<div class="${o.item} ${n.highlighted?o.highlightedState:o.itemSelectable}" data-item data-value="${n.value}" ${n.active?'aria-selected="true"':""} ${n.disabled?'aria-disabled="true"':""}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)},choice:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return t(`<div class="${o.item} ${o.itemChoice} ${n.disabled?o.itemDisabled:o.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${n.disabled?'data-choice-disabled aria-disabled="true"':"data-choice-selectable"}" data-id="${n.id}" data-value="${n.value}" ${n.groupId>0?'role="treeitem"':'role="option"'}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)}}}}),dt.addEventListener("change",t=>{let o=t.detail.value;o&&(x=M.find(n=>n.properties.originalIndex==o),console.log("Inicio manual fijado:",x.properties.nombre),k&&(Y=he(x,k,M,$,pe),Ge(Y)))})}function Qn(e){console.log("Cambiando a modo:",e);let t=document.getElementById("pantalla-saldo"),o=document.getElementById("pantalla-recargas");t&&t.classList.add("oculto"),o&&o.classList.add("oculto"),eo.classList.add("oculto"),to.classList.add("oculto"),Xt.classList.add("oculto"),e==="saldo"?(X.classList.add("oculto"),q.classList.add("oculto"),t&&t.classList.remove("oculto")):e==="recargas"?(X.classList.add("oculto"),q.classList.add("oculto"),o&&o.classList.remove("oculto")):(Le!==null&&e==="viaje"?(X.classList.add("oculto"),q.classList.remove("oculto")):(X.classList.remove("oculto"),q&&q.classList.add("oculto")),e==="viaje"?eo.classList.remove("oculto"):e==="explorar"?to.classList.remove("oculto"):e==="reporte"&&Xt.classList.remove("oculto")),document.querySelectorAll(".nav-item").forEach(n=>{let a=n.querySelector("i");n.dataset.target===e?(n.classList.add("activo"),a&&a.className.includes("-line")&&(a.className=a.className.replace("-line","-fill"))):(n.classList.remove("activo"),a&&a.className.includes("-fill")&&(a.className=a.className.replace("-fill","-line")))}),mt()}function ea(){$.sort((t,o)=>t.properties.id.localeCompare(o.properties.id,void 0,{numeric:!0}));let e=$.map(t=>({value:t.properties.id,label:`${t.properties.id} (${t.properties.nombre})`}));oe=new Choices(oo,{choices:e,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe para filtrar...",shouldSort:!1}),oo.addEventListener("change",t=>{t.detail.value&&ta(t.detail.value)})}function ta(e){let t=$.find(i=>i.properties.id===e);if(!t)return;let o=pe.get(e),n=o?[...o]:[];go(t,n),mt();let a=`
        <p>Mostrando ruta <strong>${t.properties.id}</strong>.</p>
        <ul style="padding-left: 20px; max-height: 40vh; overflow-y: auto; font-size: 0.95em;">
    `;n.forEach(i=>{let r=i.properties.originalIndex;a+=`<li style="margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    ${i.properties.nombre}
                    <div class="eta-live-badge eta-contenedor-${r}"></div>
                 </li>`}),a+="</ul>",He.innerHTML=a,mn(e,null,n)}function no(){if(Ye([]),ge(),mt(),C.clearLayers(),ht(),U.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>",co(),q.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",H.className="",$t(),Me(Le),S&&(S.clearInput(),S.removeActiveItems()),te&&(te.style.display="none"),se&&(se.style.display="block"),ie&&(ie.clearInput(),ie.removeActiveItems()),S&&(S.clearInput(),S.removeActiveItems()),ie&&(ie.clearInput(),ie.removeActiveItems()),oe&&(oe.clearInput(),oe.removeActiveItems()),te&&(te.style.display="none"),se&&(se.style.display="block"),_e.style.display="none",ut.style.display="none",He.innerHTML="Selecciona una ruta para ver su trayecto y paraderos.",q.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",H.className="",$t(),Me(Le),Le=null,w){x=gt(w),D.value=`Cerca de "${x.properties.nombre}"`,D.style.color="black",D.style.fontWeight="normal";let e=w.geometry.coordinates;v.setView([e[1],e[0]],16),fe([e[1],e[0]]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup()}else x=null,D.value="Detectando ubicaci\xF3n...",D.style.color="black",D.style.fontWeight="normal"}function Ge(e){U.innerHTML="",C.clearLayers(),ge();let t=w||x;if(!t){U.innerHTML="<p><strong>Error:</strong> No se ha fijado un punto de inicio.</p>";return}let o=t.geometry.coordinates;L.marker([o[1],o[0]]).addTo(C).bindPopup(w?"<b>Est\xE1s aqu\xED</b>":`<b>Inicio (Manual):</b><br>${x.properties.nombre}`);let n=k.geometry.coordinates,a=[n[1],n[0]],i=J(k,"Destino Final");if(L.marker(a,{icon:Ce}).addTo(C).bindPopup(i),!e||e.length===0)return;let r=e[0],s=r.filter(d=>d.tipo==="bus"),c=r.find(d=>d.tipo==="caminar");if(c){let d=c.paradero,l=d.geometry.coordinates,m=[l[1],l[0]],h=J(d,"Subir aqu\xED");L.marker(m,{icon:We}).addTo(C).bindPopup(h)}for(let d=0;d<s.length-1;d++){let l=s[d].paraderoFin,m=l.geometry.coordinates,h=[m[1],m[0]],g=J(l,"Transbordo Aqu\xED");L.marker(h,{icon:bt}).addTo(C).bindPopup(g)}let u=document.createDocumentFragment(),p=document.createElement("p");p.innerHTML=`<strong>Se encontraron ${e.length} opciones:</strong>`,u.appendChild(p),e.forEach((d,l)=>{let m=document.createElement("div");m.className="opcion-ruta";let h=d.filter(P=>P.tipo==="bus").map(P=>P.ruta.properties.id),g=document.createElement("h4");g.innerHTML=`Opci\xF3n ${l+1} <span style="font-weight:normal; font-size: 0.8em;">(${h.join(" &rarr; ")})</span>`,m.appendChild(g);let f=document.createElement("ol");d.forEach(P=>{if(P.tipo==="caminar"||P.tipo==="bus"){let R=document.createElement("li");R.textContent=P.texto,f.appendChild(R)}}),m.appendChild(f);let b=document.createElement("button");b.className="btn-seleccionar",b.innerHTML='Seleccionar <i class="ri-arrow-right-line"></i>',b.addEventListener("click",()=>{oa(l)}),m.appendChild(b),u.appendChild(m)}),U.appendChild(u),Ye(e),ut.style.display="block",_e.style.display="none"}var oa=e=>{E=Y[e],xe=0;let t=w||x;E.forEach(r=>{let s=0;try{if(r.tipo==="caminar"){s=turf.distance(t,r.paradero,{units:"meters"}),xe+=s,t=r.paradero;let c=Math.max(1,Math.round(s/80));r.distanciaMetros=s,r.tiempoEstimadoMin=c,r.texto=`Dir\xEDgete a ${r.paradero.properties.nombre} (${s.toFixed(0)} m - ${c} min \u{1F6B6}\u200D\u2642\uFE0F)`}else if(r.tipo==="bus"){let c=r.ruta;if(r.ruta.geometry.type==="MultiLineString")try{let l=r.ruta.geometry.coordinates.flat();c=turf.lineString(l)}catch{console.warn("No se pudo aplanar la ruta MultiLineString, usando c\xE1lculo simple.")}let u=turf.nearestPointOnLine(c,r.paraderoInicio),p=turf.nearestPointOnLine(c,r.paraderoFin),d=turf.lineSlice(u,p,c);s=turf.length(d,{units:"meters"}),xe+=s,t=r.paraderoFin,r.distanciaMetros=s,r.texto=`Toma ${r.ruta.properties.id} y baja en ${r.paraderoFin.properties.nombre} (${(s/1e3).toFixed(1)} km)`}else r.tipo==="transbordo"&&(r.texto=`En ${r.paradero.properties.nombre}, espera el siguiente cami\xF3n.`)}catch(c){console.error("Error calculando distancia del paso:",r,c)}}),console.log(`Distancia total de la ruta: ${xe} metros`);let n=E.filter(r=>r.tipo==="bus").map(r=>r.ruta.properties.id).join(" \u2192 ");U.innerHTML=`
        <p><strong>Ruta seleccionada. \xA1Listo para navegar!</strong></p>
        <p>${n}</p>
        <p><strong>Distancia total:</strong> ${(xe/1e3).toFixed(2)} km</p>
        
        <div class="panel-acciones">
            <button id="btnIniciarRuta">Iniciar Ruta</button>
            <button id="btnGuardarFavorito" class="btn-secundario">\u2B50\uFE0F Guardar Favorito</button>
        </div>
    `,U.querySelector("#btnIniciarRuta").addEventListener("click",un),U.querySelector("#btnGuardarFavorito").addEventListener("click",()=>{la()}),_e.style.display="none",Ye([E]);let a=E.filter(r=>r.tipo==="bus"),i=a.map(r=>r.ruta.properties.id);if(i.length>0){it(i);let r=a.map(s=>s.paraderoInicio);fn(i,r)}};function gt(e){return turf.nearestPoint(e,ln)}function un(){if(!E||E.length===0)return;let e=Fo(),t=qo();if(!e){confirm("Para usar la navegaci\xF3n GPS necesitas guardar tu progreso. \xBFIniciar sesi\xF3n con Google?")&&Uo();return}if(!t){_o();return}try{let o=E.filter(a=>a.tipo==="bus").map(a=>a.ruta.properties.id).join(" \u2192 "),n={inicioId:x.properties.originalIndex,inicioNombre:x.properties.nombre,finId:k.properties.originalIndex,finNombre:k.properties.nombre,rutaResumen:o,fecha:new Date().toISOString()};ca(n)}catch(o){console.error("Error al guardar en el historial:",o)}T=0,qe=!1,X.classList.add("oculto"),q.classList.remove("oculto"),w?(console.log("Iniciando modo de navegaci\xF3n GPS (Activo)..."),Me(Ve),document.getElementById("nav-estado").style.display="flex",fe(w.geometry.coordinates.slice().reverse()),To(w),Le=Ze(aa,ft),v.on("dragstart",()=>{me=!1})):(console.log("Iniciando modo de navegaci\xF3n MANUAL (Pasivo)..."),document.getElementById("nav-estado").style.display="none",Le=null,me=!0),lo(T),so(T)}function na(){console.log("Finalizando navegaci\xF3n."),q.classList.add("oculto"),X.classList.remove("oculto"),v.off("dragstart"),Ve&&Me(Ve),Ve=Ze(dn,ft),no()}function aa(e){let t=e.coords.latitude,o=e.coords.longitude,n=e.coords.speed,a=[t,o];w=turf.point([o,t]),fe(a),me&&v.panTo(a);let i=Ao(w,n);if(i){if(E&&T<E.length){let r=E[T];if(r.tipo==="caminar"||r.tipo==="transbordo"){let s=E[T+1];if(s&&s.tipo==="bus"){let c=s.ruta.properties.id,u=[];v.eachLayer(m=>{m.options&&m.options.rutaId===c&&u.push(m)});let p=null,d=1/0;if(u.forEach(m=>{let h=m.getLatLng(),g=turf.point([h.lng,h.lat]),f=turf.distance(w,g,{units:"meters"})*1e3;f<d&&(d=f,p=m)}),p&&d<20){console.log(`DETECCI\xD3N A BORDO: Distancia ${d.toFixed(2)}m. Asumiendo subida.`),Bt(!1),pt();return}}}}sa(i),ia(i)}}function ia(e){if(!E||E.length===0||T>=E.length)return;let t=E[T],o=40;if(!w)return;let n=null,a=null;if(t.tipo==="caminar"?n=t.paradero:t.tipo==="bus"&&(n=t.paraderoFin,a=t.ruta),t.tipo==="caminar"&&turf.distance(w,n,{units:"meters"})<25){console.log("Llegaste al paradero de subida, avanzando..."),pt();return}if(t.tipo==="bus"){turf.distance(w,n,{units:"meters"})<300&&!qe&&(console.log("\xA1Alerta! Bajas pronto."),qe=!0,F.vibration&&navigator.vibrate&&navigator.vibrate([200,100,200]),ro.textContent=`\xA1BAJA PRONTO! (${n.properties.nombre})`);try{let r=turf.nearestPointOnLine(a,w),s=turf.nearestPointOnLine(a,n),c=r.properties.location,u=s.properties.location;if((c-u)*1e3>o){console.log("Detecci\xF3n de Avance: El usuario pas\xF3 el punto de bajada. Avanzando..."),T===E.length-1||(console.log("Activando contador de transbordo..."),Bt(),F.vibration&&navigator.vibrate&&navigator.vibrate([200,100,200,100,200])),pt();return}}catch(r){console.error("Error en l\xF3gica de proyecci\xF3n Turf:",r)}}}function pt(){T<E.length-1&&(T++,me=!0,qe=!1,so(T),lo(T))}function ra(){T>0&&(T--,me=!0,qe=!1,so(T),lo(T))}function so(e){let t=E[e];ro.textContent=t.texto,Zt.disabled=e===0;let o=e===E.length-1;ze.disabled=o,Qt.style.display="block",o?ze.style.display="none":ze.style.display="block";let a=fo(t,w||x);me&&a&&a.isValid()?v.fitBounds(a.pad(.2)):me&&!a&&v.setView(v.getCenter(),17)}function sa(e){let t=Math.max(0,xe-e.distanciaRecorrida);t>1e3?Wt.textContent=`Faltan: ${(t/1e3).toFixed(2)} km`:Wt.textContent=`Faltan: ${t.toFixed(0)} m`;let o=5400;if(H.className="",e.enModoTransbordo&&!e.enMovimiento){let r=o-e.tiempoTotalViaje;if(r>0){let s=Math.floor(r/60),c=r%60;H.textContent=`Transbordo: ${s}:${c<10?"0":""}${c}`,H.classList.add("transbordo-timer")}else H.textContent="Tiempo Agotado",H.classList.add("advertencia")}else if(e.enMovimiento)H.textContent="En movimiento",H.classList.add("en-movimiento");else{let r=Math.floor(e.tiempoDetenido/60),s=e.tiempoDetenido%60;H.textContent=`Esperando: ${r}:${s<10?"0":""}${s}`,H.classList.add("advertencia")}let n=7200,a=Math.floor(e.tiempoTotalViaje/60),i=e.tiempoTotalViaje%60;st.textContent=`Viaje: ${a}:${i<10?"0":""}${i}`,e.tiempoTotalViaje>n?st.classList.add("advertencia"):st.classList.remove("advertencia")}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(e=>{console.log("Service Worker: Registrado exitosamente",e.scope)}).catch(e=>{console.log("Service Worker: Fall\xF3 el registro",e)})});function ca(e){let o=JSON.parse(localStorage.getItem("historialRutas"))||[];o=o.filter(a=>!(a.inicioId===e.inicioId&&a.finId===e.finId)),o.unshift(e);let n=o.slice(0,5);localStorage.setItem("historialRutas",JSON.stringify(n))}function co(){let e=JSON.parse(localStorage.getItem("historialRutas"))||[],t=JSON.parse(localStorage.getItem("favoritasRutas"))||[],o="";if(t.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px;">\u2B50\uFE0F Tus Favoritos:</p>',o+=t.map(n=>`
                <div class="opcion-ruta favorito-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir: ${n.inicioNombre} \u2192 ${n.finNombre}">
                    
                    <span class="delete-favorito" data-nombre="${n.nombre}" title="Borrar favorito">&times;</span>
                    
                    <h4 style="margin-bottom: 5px;">${n.nombre}</h4>
                    <small style="color: #555;">${n.inicioNombre} \u2192 ${n.finNombre}</small>
                </div>
            `).join("")),e.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px; margin-top: 20px;">Tu historial reciente:</p>',o+=e.map(n=>`
                <div class="opcion-ruta historial-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir esta b\xFAsqueda">
                    <h4 style="margin-bottom: 5px;">${n.inicioNombre} \u2192 ${n.finNombre}</h4>
                    <small style="color: #555;">${n.rutaResumen||"Ruta de caminata"}</small>
                </div>
            `).join("")),o===""){U.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>";return}U.innerHTML=o,document.querySelectorAll(".historial-item").forEach(n=>{n.addEventListener("click",rn)}),document.querySelectorAll(".favorito-item").forEach(n=>{n.addEventListener("click",rn)}),document.querySelectorAll(".delete-favorito").forEach(n=>{n.addEventListener("click",ua)})}async function rn(e){let t=e.currentTarget,o=t.dataset.inicioId,n=t.dataset.finId;if(!o||!n)return;console.log(`Cargando historial: Inicio ${o}, Fin ${n}`);let a=M.find(r=>r.properties.originalIndex==o);if(k=M.find(r=>r.properties.originalIndex==n),!a||!k){alert("Error: Datos de ruta no encontrados.");return}x=a,w=null,se.style.display="none",te.style.display="block",ie&&ie.setChoiceByValue(o.toString());let i={value:n.toString(),label:k.properties.nombre,selected:!0};S.setChoices([i],"value","label",!0),Y=he(x,k,M,$,pe),Ge(Y)}function la(){let e=prompt("Dale un nombre a esta ruta (ej. Casa a Oficina):","");if(!(!e||e.trim()===""))try{let t={inicioId:x.properties.originalIndex,inicioNombre:x.properties.nombre,finId:k.properties.originalIndex,finNombre:k.properties.nombre,nombre:e.trim()};da(t)}catch(t){console.error("Error al guardar en favoritos:",t),alert("Error: No se pudo guardar el favorito.")}}function da(e){let t=JSON.parse(localStorage.getItem("favoritasRutas"))||[];t=t.filter(o=>o.nombre!==e.nombre),t.unshift(e),localStorage.setItem("favoritasRutas",JSON.stringify(t)),alert(`\xA1Ruta "${e.nombre}" guardada como favorita!`)}function ua(e){e.stopPropagation();let t=e.currentTarget.dataset.nombre;if(t&&confirm(`\xBFSeguro que quieres borrar el favorito "${t}"?`)){let o=JSON.parse(localStorage.getItem("favoritasRutas"))||[];o=o.filter(n=>n.nombre!==t),localStorage.setItem("favoritasRutas",JSON.stringify(o)),co()}}function pa(){if(!w){alert("No se ha podido detectar tu ubicaci\xF3n GPS. Mu\xE9vete a un lugar con mejor se\xF1al o reinicia la app.");return}console.log("Buscando paraderos cercanos y preparando ETAs..."),ge(),C.clearLayers(),oe&&(oe.clearInput(),oe.removeActiveItems());let t=M.map(c=>{let u=turf.distance(w,c,{units:"meters"});return{paradero:c,distancia:u}}).sort((c,u)=>c.distancia-u.distancia).slice(0,5),o=[],n='<p><strong>Paraderos cercanos a ti:</strong></p><ul style="padding-left: 10px; list-style:none; font-size: 0.95em;">',a=new Set;t.forEach(c=>{let u=c.paradero.geometry.coordinates,p=[u[1],u[0]],d=c.paradero.properties.nombre,l=c.distancia.toFixed(0),m=c.paradero.properties.originalIndex;(c.paradero.properties.rutas||[]).forEach(b=>a.add(b)),n+=`
            <li style="margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                <div style="font-weight:bold; color:#0056b3;"><i class="ri-map-pin-user-line"></i> ${d}</div>
                <div style="font-size:0.85em; color:#666; margin-bottom: 4px;">A ${l} metros de ti</div>
                <div class="eta-live-badge eta-contenedor-${m}"></div>
            </li>
        `;let g=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[24,24],iconAnchor:[12,12],popupAnchor:[0,-12]}),f=L.marker(p,{icon:g}).bindPopup(J(c.paradero));f.addTo(C),o.push(f)}),n+="</ul>",He.innerHTML=n;let i=fe(w.geometry.coordinates.slice().reverse()),r=L.featureGroup([i,...o]);r.getBounds().isValid()&&v.fitBounds(r.getBounds().pad(.2)),we();let s=Array.from(a);s.length>0&&(console.log(`Desplegando radar para ${s.length} rutas cercanas:`,s),fn(s,t))}function ma(e){let t=e.target.dataset.paraderoId;if(!t)return;let o=M.find(r=>r.properties.originalIndex==t);if(!o)return;let a=(o.properties.rutas||[]).map(r=>$.find(s=>s.properties.id===r)).filter(Boolean),i=`<p>Mostrando rutas para:</p>
                <h4 style="margin-top:0;">${o.properties.nombre}</h4>`;a.length>0?(i+='<ul style="padding-left: 20px; margin-top: 10px;">',a.forEach(r=>{i+=`<li style="margin-bottom: 5px;">
                        <strong>${r.properties.id}</strong>
                        <small>(${r.properties.nombre})</small>
                    </li>`}),i+="</ul>"):i+="<p>No hay rutas registradas para este paradero.</p>",He.innerHTML=i,v.closePopup(),we()}function we(){X.classList.contains("oculto")&&X.classList.remove("oculto")}function pn(){if(E&&E.length>0&&T<E.length){let e=E[T];if(e.tipo==="bus")return e.ruta.properties.id}if(oe&&oe.getValue(!0))return oe.getValue(!0);if(x&&q.classList.contains("oculto")){let e=x.properties.rutas||[];if(e.length>0)return e[0]}return null}async function fa(e){let t=pn();if(!t){alert("Por favor, inicia una navegaci\xF3n o selecciona una ruta en 'Explorar' para poder reportar un incidente sobre ella.");return}console.log(`Enviando reporte a Firebase: ${e} en ${t}`);try{await _n.collection("reportes_pendientes").add({tipo:e,rutaId:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}),alert(`\xA1Gracias! Tu reporte para la ruta ${t} ha sido enviado.`)}catch(o){console.error("Error al enviar reporte a Firebase:",o),alert("No se pudo enviar el reporte. Revisa tu conexi\xF3n a internet.")}}function ht(){Kt&&(Kt(),Kt=null),ee&&(ee.disconnect(),ee=null),rt.length>0&&(rt.forEach(e=>e.disconnect()),rt=[]),Et(),ao(null),Xo(),Zo(),console.log("\u{1F6D1} Escucha de buses DETENIDA. Memoria liberada.")}function ao(e){let t=document.getElementById("eta-info");if(!t)return;if(!e){t.style.display="none",t.innerHTML="";return}let o=`<strong>Pr\xF3ximo bus (Unidad ${e.id}):</strong>`;e.etaMinutos?o+=`<p>Llega a tu parada en aprox. <strong>${e.etaMinutos} min</strong>.</p>`:o+=`<p>Est\xE1 a <strong>${e.distanciaMetros.toFixed(0)} m</strong> de tu parada.</p>`,t.innerHTML=o,t.style.display="block"}function mn(e,t,o=null){ht(),e&&it(e);let n=sn(e);if(!n){console.log(`\u26A0\uFE0F La ruta ${e} a\xFAn no tiene ID de Vinden configurado.`),ao(null);return}console.log(`\u{1F4E1} Iniciando conexi\xF3n directa a Vinden para ruta: ${e} (ID Vinden: ${n})`),ee?ee.emit("change-route",n):(ee=io("wss://socketio.campeche.vinden.cloud/app",{transports:["websocket"],query:{r:"977",EIO:"3",transport:"websocket"}}),ee.on("connect",()=>{console.log("\u2705 Conectado al sat\xE9lite Vinden"),ee.emit("change-route",n)}));let a=$.find(c=>c.properties.id===e),i=a;if(a&&a.geometry&&a.geometry.type==="MultiLineString")try{let c=a.geometry.coordinates.flat();i=turf.lineString(c)}catch{console.warn("No se pudo aplanar la ruta para el c\xE1lculo de ETA.")}let r=new Map,s=ee.onevent;ee.onevent=function(c){let u=c.data||[];if(u[0]==="update-location"&&u[1]&&u[1].data)try{let p=JSON.parse(u[1].data),d=p.unit_id,l=parseFloat(p.latlng[0]),m=parseFloat(p.latlng[1]),h=parseFloat(p.speed)||0,g=p.status===5?0:h/3.6,f=!0,b=turf.point([m,l]);if(i&&(f=qt(b,i)),f)vt(p,e),Ht(d,p.velocidadCalculada,e),o&&o.length>0&&zt(p,b,i,o,e);else{yt(d),s.call(this,c);return}if(t&&i){let P=turf.nearestPointOnLine(i,b),R=turf.nearestPointOnLine(i,t.geometry.coordinates),G=P.properties.location;if(R.properties.location-G>.01){let y=turf.lineSlice(P,R,i),I=turf.length(y,{units:"meters"});r.set(d,{id:p.unit_number||d,distanciaMetros:I,speed:g})}else r.delete(d);let K=Array.from(r.values());if(K.length>0){K.sort((B,j)=>B.distanciaMetros-j.distanciaMetros);let y=K[0],I=null;y.speed>1&&(I=Math.round(y.distanciaMetros/y.speed/60)),ao({id:y.id,etaMinutos:I,distanciaMetros:y.distanciaMetros})}}}catch(p){console.error("Error procesando telemetr\xEDa de Vinden:",p)}s.call(this,c)}}function fn(e,t){ht(),e&&e.length>0&&it(e);let o=t.map(n=>n.paradero?n.paradero:n);e.forEach((n,a)=>{let i=sn(n);i&&setTimeout(()=>{let r=io("wss://socketio.campeche.vinden.cloud/app",{transports:["websocket"],query:{r:"977",EIO:"3",transport:"websocket"},forceNew:!0});r.on("connect",()=>{r.emit("change-route",i)});let s=$.find(p=>p.properties.id===n),c=s;if(s&&s.geometry&&s.geometry.type==="MultiLineString")try{let p=s.geometry.coordinates.flat();c=turf.lineString(p)}catch{}let u=r.onevent;r.onevent=function(p){let d=p.data||[];if(d[0]==="update-location"&&d[1]&&d[1].data)try{let l=JSON.parse(d[1].data),m=parseFloat(l.latlng[0]),h=parseFloat(l.latlng[1]),g=l.unit_id,f=turf.point([h,m]),b=!0;c&&(b=qt(f,c)),b?(vt(l,n),Ht(g,l.velocidadCalculada,n),o.length>0&&c&&zt(l,f,c,o,n)):yt(g)}catch{}u.call(this,p)},rt.push(r)},a*300)})}function lo(e){ht();let t=E[e];if(t&&(t.tipo==="caminar"||t.tipo==="transbordo")){let o=E[e+1];if(o&&o.tipo==="bus"){let n=o.ruta.properties.id,a=o.paraderoInicio;console.log(`Buscando ETA para ${n} en ${a.properties.nombre}`),mn(n,a)}}}function ga(){let e={apiKey:"AIzaSyDcaVTGa3j1YZjbd1D52wNNc1qk7VnrorY",authDomain:"rutaskoox-gestion.firebaseapp.com",projectId:"rutaskoox-gestion",storageBucket:"rutaskoox-gestion.firebasestorage.app",messagingSenderId:"2555756265",appId:"1:2555756265:web:c6f7487ced40a4f6f87538",measurementId:"G-81656MC0ZC"};try{en=firebase.initializeApp(e,"gestionApp"),Kn=en.firestore(),console.log("Servicio de Gesti\xF3n Firebase inicializado.")}catch(t){console.error("Error inicializando Firebase Gesti\xF3n",t)}}var gn=[];async function hn(e){let t=document.getElementById("btnBuscarLugar");if(t){var o=t.innerHTML;t.innerHTML='<i class="ri-loader-4-line ri-spin"></i>',t.disabled=!0}try{let n=await Ft(e,100);n&&n.length>0?n.length===1?uo(n[0]):ha(n):alert("No encontramos lugares con ese nombre en Campeche.")}catch(n){console.error(n),alert("Error de conexi\xF3n al buscar.")}finally{t&&(t.innerHTML=o,t.disabled=!1)}}function ha(e){let t=document.getElementById("panel-instrucciones");gn=e;let o=`
        <div class="info-seccion">
            <p style="margin-bottom:10px;">Encontramos <strong>${e.length}</strong> opciones:</p>
            <div class="lista-resultados" style="max-height: 60vh; overflow-y: auto; padding-bottom: 20px;">
    `;e.forEach((n,a)=>{o+=`
            <div class="opcion-ruta" onclick="window.app.seleccionarResultado(${a})" style="cursor:pointer; padding: 15px; margin-bottom: 10px;">
                <h4 style="margin:0 0 5px 0; font-size: 1em; color: var(--primary-color);">
                    <i class="ri-map-pin-line"></i> ${n.nombre}
                </h4>
                <small style="color: var(--text-color); opacity: 0.8; line-height: 1.2; display:block;">
                    ${n.direccion}
                </small>
            </div>
        `}),o+="</div></div>",t.innerHTML=o,we()}window.app=window.app||{};window.app.seleccionarResultado=e=>{let t=gn[e];t&&uo(t)};function uo(e){let t=document.getElementById("info-lugar-buscado");console.log("Procesando lugar:",e);let o=turf.point([e.lng,e.lat]),n=gt(o);if(n){if(k=n,S&&S.setChoiceByValue(n.properties.originalIndex.toString()),x)console.log("\u{1F4CD} Inicio detectado, calculando ruta autom\xE1tica..."),U.innerHTML="",Y=he(x,k,M,$,pe),Ge(Y);else{let i=document.getElementById("panel-instrucciones");i.innerHTML=`
                <div class="alerta-verde" style="text-align:left; margin-top:0;">
                    <strong>\u2705 Destino: ${e.nombre}</strong><br>
                    <small>Paradero m\xE1s cercano: ${n.properties.nombre}</small>
                </div>
                <div style="background:#fff3e0; color:#e65100; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #ffe0b2; text-align:center;">
                    \u{1F4CD} <strong>Falta tu ubicaci\xF3n</strong><br>
                    Espera al GPS o selecciona un "Inicio Manual" arriba.
                </div>
            `}we();let a=L.marker([e.lat,e.lng],{icon:L.divIcon({className:"icono-destino-especial",html:'<i class="ri-map-pin-star-fill" style="color:#E91E63; font-size:30px; text-shadow: 0 2px 5px rgba(0,0,0,0.3);"></i>',iconSize:[30,30],iconAnchor:[15,30]})}).addTo(v).bindPopup(`<b>${e.nombre}</b>`).openPopup();v.setView([e.lat,e.lng],16),setTimeout(()=>v.removeLayer(a),5e3)}else alert("El lugar existe, pero est\xE1 muy lejos de cualquier ruta de transporte.")}function ba(){if(!S)return;let e=Vt.map(n=>({value:"turismo_"+n.query,label:`\u{1F4F8} ${n.nombre}`,customProperties:{calle:"Sitio Tur\xEDstico",colonia:"Recomendado"}})),t='<div class="info-seccion"><h5>Sitios de Inter\xE9s</h5><div class="chips-scroll" style="flex-wrap:wrap;">';Vt.forEach(n=>{t+=`<button class="chip" onclick="window.app.buscarTurismo('${n.query}')">
            <i class="${n.icono}"></i> ${n.nombre}
        </button>`}),t+="</div></div>";let o=document.getElementById("panel-instrucciones");o.innerHTML=t}window.app=window.app||{};window.app.buscarTurismo=e=>{hn(e)};window.simularBus=function(){if(!E||E.length===0){alert("\u26A0\uFE0F Primero inicia una ruta de navegaci\xF3n (Pon inicio y destino).");return}let e=E.find(u=>u.tipo==="bus");if(!e){alert("\u{1F6B6} Tu ruta es solo de caminata. Elige un destino m\xE1s lejos para usar bus.");return}let t=e.ruta.properties.id;console.log(`\u{1F68C} Iniciando simulaci\xF3n para: ${t}`);let o=e.paraderoInicio.geometry.coordinates,n=o[1]-.006,a=o[0]-.006,i=L.divIcon({className:"bus-simulado",html:`
            <div style="
                background: #d32f2f; 
                border: 2px solid white; 
                color: white; 
                width: 44px; height: 44px; 
                border-radius: 50%; 
                display: flex; align-items: center; justify-content: center; 
                font-weight: bold; font-size: 10px;
                box-shadow: 0 4px 15px rgba(211, 47, 47, 0.5);
                animation: palpitar 1s infinite;
            ">
                TEST
            </div>
            <style>@keyframes palpitar { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }</style>
        `,iconSize:[44,44]}),r=L.marker([n,a],{icon:i}).addTo(v),s=3e3;alert(`\u{1F440} \xA1Mira el mapa! Un bus de prueba (${t}) se acerca a tu paradero.`);let c=setInterval(()=>{n+=15e-5,a+=15e-5,s-=50,r.setLatLng([n,a]);let u=document.getElementById("eta-info");u&&(u.style.display="block",u.innerHTML=`
                <div style="background:#e3f2fd; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #90caf9; display:flex; align-items:center; gap:10px;">
                    <div style="font-size:20px;">\u{1F68D}</div>
                    <div>
                        <strong style="color:#1565c0;">BUS DE PRUEBA</strong>
                        <div style="font-size:1.1em; font-weight:bold;">${Math.max(1,Math.ceil(s/500))} min</div>
                        <small style="color:#555;">A ${s} metros</small>
                    </div>
                </div>
            `),s<=100&&(clearInterval(c),alert("\u2705 \xA1El bus simulado lleg\xF3 al paradero!"),v.removeLayer(r),u&&(u.style.display="none"))},800)};})();
/*! Bundled license information:

@capacitor/core/dist/index.js:
  (*! Capacitor: https://capacitorjs.com/ - MIT License *)
*/
