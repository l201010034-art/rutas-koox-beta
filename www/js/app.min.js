(()=>{var ko=Object.defineProperty;var ge=(t,e)=>()=>(t&&(e=t(t=0)),e);var Ae=(t,e)=>{for(var o in e)ko(t,o,{get:e[o],enumerable:!0})};var le,xe,To,Ao,Bo,ct,z,R,Xt,Yt,lt,Pn,No,Ro,Do,Oo,dt,Sn,Zt,Qt,ut,kn,W=ge(()=>{(function(t){t.Unimplemented="UNIMPLEMENTED",t.Unavailable="UNAVAILABLE"})(le||(le={}));xe=class extends Error{constructor(e,o,n){super(e),this.message=e,this.code=o,this.data=n}},To=t=>{var e,o;return t?.androidBridge?"android":!((o=(e=t?.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||o===void 0)&&o.bridge?"ios":"web"},Ao=t=>{let e=t.CapacitorCustomPlatform||null,o=t.Capacitor||{},n=o.Plugins=o.Plugins||{},a=()=>e!==null?e.name:To(t),i=()=>a()!=="web",r=d=>{let c=p.get(d);return!!(c?.platforms.has(a())||s(d))},s=d=>{var c;return(c=o.PluginHeaders)===null||c===void 0?void 0:c.find(m=>m.name===d)},l=d=>t.console.error(d),p=new Map,b=(d,c={})=>{let m=p.get(d);if(m)return console.warn(`Capacitor plugin "${d}" already registered. Cannot register plugins twice.`),m.proxy;let h=a(),g=s(d),u,v=async()=>(!u&&h in c?u=typeof c[h]=="function"?u=await c[h]():u=c[h]:e!==null&&!u&&"web"in c&&(u=typeof c.web=="function"?u=await c.web():u=c.web),u),C=(E,P)=>{var N,O;if(g){let J=g?.methods.find(j=>P===j.name);if(J)return J.rtype==="promise"?j=>o.nativePromise(d,P.toString(),j):(j,oe)=>o.nativeCallback(d,P.toString(),j,oe);if(E)return(N=E[P])===null||N===void 0?void 0:N.bind(E)}else{if(E)return(O=E[P])===null||O===void 0?void 0:O.bind(E);throw new xe(`"${d}" plugin is not implemented on ${h}`,le.Unimplemented)}},Y=E=>{let P,N=(...O)=>{let J=v().then(j=>{let oe=C(j,E);if(oe){let Te=oe(...O);return P=Te?.remove,Te}else throw new xe(`"${d}.${E}()" is not implemented on ${h}`,le.Unimplemented)});return E==="addListener"&&(J.remove=async()=>P()),J};return N.toString=()=>`${E.toString()}() { [capacitor code] }`,Object.defineProperty(N,"name",{value:E,writable:!1,configurable:!1}),N},fe=Y("addListener"),B=Y("removeListener"),$e=(E,P)=>{let N=fe({eventName:E},P),O=async()=>{let j=await N;B({eventName:E,callbackId:j},P)},J=new Promise(j=>N.then(()=>j({remove:O})));return J.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await O()},J},te=new Proxy({},{get(E,P){switch(P){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return g?$e:fe;case"removeListener":return B;default:return Y(P)}}});return n[d]=te,p.set(d,{name:d,proxy:te,platforms:new Set([...Object.keys(c),...g?[h]:[]])}),te};return o.convertFileSrc||(o.convertFileSrc=d=>d),o.getPlatform=a,o.handleError=l,o.isNativePlatform=i,o.isPluginAvailable=r,o.registerPlugin=b,o.Exception=xe,o.DEBUG=!!o.DEBUG,o.isLoggingEnabled=!!o.isLoggingEnabled,o},Bo=t=>t.Capacitor=Ao(t),ct=Bo(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),z=ct.registerPlugin,R=class{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,o){let n=!1;this.listeners[e]||(this.listeners[e]=[],n=!0),this.listeners[e].push(o);let i=this.windowListeners[e];i&&!i.registered&&this.addWindowListener(i),n&&this.sendRetainedArgumentsForEvent(e);let r=async()=>this.removeListener(e,o);return Promise.resolve({remove:r})}async removeAllListeners(){this.listeners={};for(let e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,o,n){let a=this.listeners[e];if(!a){if(n){let i=this.retainedEventArguments[e];i||(i=[]),i.push(o),this.retainedEventArguments[e]=i}return}a.forEach(i=>i(o))}hasListeners(e){var o;return!!(!((o=this.listeners[e])===null||o===void 0)&&o.length)}registerWindowListener(e,o){this.windowListeners[o]={registered:!1,windowEventName:e,pluginEventName:o,handler:n=>{this.notifyListeners(o,n)}}}unimplemented(e="not implemented"){return new ct.Exception(e,le.Unimplemented)}unavailable(e="not available"){return new ct.Exception(e,le.Unavailable)}async removeListener(e,o){let n=this.listeners[e];if(!n)return;let a=n.indexOf(o);this.listeners[e].splice(a,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){let o=this.retainedEventArguments[e];o&&(delete this.retainedEventArguments[e],o.forEach(n=>{this.notifyListeners(e,n)}))}},Xt=t=>encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Yt=t=>t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),lt=class extends R{async getCookies(){let e=document.cookie,o={};return e.split(";").forEach(n=>{if(n.length<=0)return;let[a,i]=n.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");a=Yt(a).trim(),i=Yt(i).trim(),o[a]=i}),o}async setCookie(e){try{let o=Xt(e.key),n=Xt(e.value),a=`; expires=${(e.expires||"").replace("expires=","")}`,i=(e.path||"/").replace("path=",""),r=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${o}=${n||""}${a}; path=${i}; ${r};`}catch(o){return Promise.reject(o)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(o){return Promise.reject(o)}}async clearCookies(){try{let e=document.cookie.split(";")||[];for(let o of e)document.cookie=o.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}},Pn=z("CapacitorCookies",{web:()=>new lt}),No=async t=>new Promise((e,o)=>{let n=new FileReader;n.onload=()=>{let a=n.result;e(a.indexOf(",")>=0?a.split(",")[1]:a)},n.onerror=a=>o(a),n.readAsDataURL(t)}),Ro=(t={})=>{let e=Object.keys(t);return Object.keys(t).map(a=>a.toLocaleLowerCase()).reduce((a,i,r)=>(a[i]=t[e[r]],a),{})},Do=(t,e=!0)=>t?Object.entries(t).reduce((n,a)=>{let[i,r]=a,s,l;return Array.isArray(r)?(l="",r.forEach(p=>{s=e?encodeURIComponent(p):p,l+=`${i}=${s}&`}),l.slice(0,-1)):(s=e?encodeURIComponent(r):r,l=`${i}=${s}`),`${n}&${l}`},"").substr(1):null,Oo=(t,e={})=>{let o=Object.assign({method:t.method||"GET",headers:t.headers},e),a=Ro(t.headers)["content-type"]||"";if(typeof t.data=="string")o.body=t.data;else if(a.includes("application/x-www-form-urlencoded")){let i=new URLSearchParams;for(let[r,s]of Object.entries(t.data||{}))i.set(r,s);o.body=i.toString()}else if(a.includes("multipart/form-data")||t.data instanceof FormData){let i=new FormData;if(t.data instanceof FormData)t.data.forEach((s,l)=>{i.append(l,s)});else for(let s of Object.keys(t.data))i.append(s,t.data[s]);o.body=i;let r=new Headers(o.headers);r.delete("content-type"),o.headers=r}else(a.includes("application/json")||typeof t.data=="object")&&(o.body=JSON.stringify(t.data));return o},dt=class extends R{async request(e){let o=Oo(e,e.webFetchExtra),n=Do(e.params,e.shouldEncodeUrlParams),a=n?`${e.url}?${n}`:e.url,i=await fetch(a,o),r=i.headers.get("content-type")||"",{responseType:s="text"}=i.ok?e:{};r.includes("application/json")&&(s="json");let l,p;switch(s){case"arraybuffer":case"blob":p=await i.blob(),l=await No(p);break;case"json":l=await i.json();break;default:l=await i.text()}let b={};return i.headers.forEach((d,c)=>{b[c]=d}),{data:l,headers:b,status:i.status,url:i.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}},Sn=z("CapacitorHttp",{web:()=>new dt});(function(t){t.Dark="DARK",t.Light="LIGHT",t.Default="DEFAULT"})(Zt||(Zt={}));(function(t){t.StatusBar="StatusBar",t.NavigationBar="NavigationBar"})(Qt||(Qt={}));ut=class extends R{async setStyle(){this.unavailable("not available for web")}async setAnimation(){this.unavailable("not available for web")}async show(){this.unavailable("not available for web")}async hide(){this.unavailable("not available for web")}},kn=z("SystemBars",{web:()=>new ut})});var eo={};Ae(eo,{KeepAwakeWeb:()=>pt});var pt,to=ge(()=>{W();pt=class extends R{constructor(){super(...arguments),this.wakeLock=null,this._isSupported=typeof navigator<"u"&&"wakeLock"in navigator,this.handleVisibilityChange=()=>{document.visibilityState==="visible"&&this.keepAwake()}}async keepAwake(){this._isSupported||this.throwUnsupportedError(),this.wakeLock&&await this.allowSleep(),this.wakeLock=await navigator.wakeLock.request("screen"),document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange)}async allowSleep(){var e;this._isSupported||this.throwUnsupportedError(),(e=this.wakeLock)===null||e===void 0||e.release(),this.wakeLock=null,document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange)}async isSupported(){return{isSupported:this._isSupported}}async isKeptAwake(){return this._isSupported||this.throwUnsupportedError(),{isKeptAwake:!!this.wakeLock}}throwUnsupportedError(){throw this.unavailable("Screen Wake Lock API not available in this browser.")}}});var no={};Ae(no,{Geolocation:()=>qo,GeolocationWeb:()=>ze});var ze,qo,ao=ge(()=>{W();ze=class extends R{async getCurrentPosition(e){return new Promise((o,n)=>{navigator.geolocation.getCurrentPosition(a=>{o(a)},a=>{n(a)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0},e))})}async watchPosition(e,o){return`${navigator.geolocation.watchPosition(a=>{o(a)},a=>{o(null,a)},Object.assign({enableHighAccuracy:!1,timeout:1e4,maximumAge:0,minimumUpdateInterval:5e3},e))}`}async clearWatch(e){navigator.geolocation.clearWatch(parseInt(e.id,10))}async checkPermissions(){if(typeof navigator>"u"||!navigator.permissions)throw this.unavailable("Permissions API not available in this browser");let e=await navigator.permissions.query({name:"geolocation"});return{location:e.state,coarseLocation:e.state}}async requestPermissions(){throw this.unimplemented("Not implemented on web.")}},qo=new ze});var ro={};Ae(ro,{LocalNotificationsWeb:()=>gt});var gt,so=ge(()=>{W();gt=class extends R{constructor(){super(...arguments),this.pending=[],this.deliveredNotifications=[],this.hasNotificationSupport=()=>{if(!("Notification"in window)||!Notification.requestPermission)return!1;if(Notification.permission!=="granted")try{new Notification("")}catch(e){if(e instanceof Error&&e.name==="TypeError")return!1}return!0}}async getDeliveredNotifications(){let e=[];for(let o of this.deliveredNotifications){let n={title:o.title,id:parseInt(o.tag),body:o.body};e.push(n)}return{notifications:e}}async removeDeliveredNotifications(e){for(let o of e.notifications){let n=this.deliveredNotifications.find(a=>a.tag===String(o.id));n?.close(),this.deliveredNotifications=this.deliveredNotifications.filter(()=>!n)}}async removeAllDeliveredNotifications(){for(let e of this.deliveredNotifications)e.close();this.deliveredNotifications=[]}async createChannel(){throw this.unimplemented("Not implemented on web.")}async deleteChannel(){throw this.unimplemented("Not implemented on web.")}async listChannels(){throw this.unimplemented("Not implemented on web.")}async schedule(e){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");for(let o of e.notifications)this.sendNotification(o);return{notifications:e.notifications.map(o=>({id:o.id}))}}async getPending(){return{notifications:this.pending}}async registerActionTypes(){throw this.unimplemented("Not implemented on web.")}async cancel(e){this.pending=this.pending.filter(o=>!e.notifications.find(n=>n.id===o.id))}async areEnabled(){let{display:e}=await this.checkPermissions();return{value:e==="granted"}}async changeExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async checkExactNotificationSetting(){throw this.unimplemented("Not implemented on web.")}async requestPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(await Notification.requestPermission())}}async checkPermissions(){if(!this.hasNotificationSupport())throw this.unavailable("Notifications not supported in this browser.");return{display:this.transformNotificationPermission(Notification.permission)}}transformNotificationPermission(e){switch(e){case"granted":return"granted";case"denied":return"denied";default:return"prompt"}}sendPending(){var e;let o=[],n=new Date().getTime();for(let a of this.pending)!((e=a.schedule)===null||e===void 0)&&e.at&&a.schedule.at.getTime()<=n&&(this.buildNotification(a),o.push(a));this.pending=this.pending.filter(a=>!o.find(i=>i===a))}sendNotification(e){var o;if(!((o=e.schedule)===null||o===void 0)&&o.at){let n=e.schedule.at.getTime()-new Date().getTime();this.pending.push(e),setTimeout(()=>{this.sendPending()},n);return}this.buildNotification(e)}buildNotification(e){let o=new Notification(e.title,{body:e.body,tag:String(e.id)});return o.addEventListener("click",this.onClick.bind(this,e),!1),o.addEventListener("show",this.onShow.bind(this,e),!1),o.addEventListener("close",()=>{this.deliveredNotifications=this.deliveredNotifications.filter(()=>!this)},!1),this.deliveredNotifications.push(o),o}onClick(e){let o={actionId:"tap",notification:e};this.notifyListeners("localNotificationActionPerformed",o)}onShow(e){this.notifyListeners("localNotificationReceived",e)}}});var co={};Ae(co,{DialogWeb:()=>bt});var bt,lo=ge(()=>{W();bt=class extends R{async alert(e){window.alert(e.message)}async prompt(e){let o=window.prompt(e.message,e.inputText||"");return{value:o!==null?o:"",cancelled:o===null}}async confirm(e){return{value:window.confirm(e.message)}}}});var H=null,be=null,he=null,S=null,f=null,Re=null,Z=new Map;function Ft(){return f=L.map("map",{zoomControl:!1}).setView([19.83,-90.528],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(f),L.control.zoom({position:"bottomright"}).addTo(f),S=L.layerGroup().addTo(f),Re=L.layerGroup().addTo(f),f}var Be=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-14]}),tt=L.divIcon({className:"icono-mapa-transbordo",html:'<i class="ri-arrow-left-right-line"></i>',iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-16]}),Ne=L.divIcon({className:"custom-div-icon",html:'<i class="ri-map-pin-flag-fill unselectable icono-mapa-destino"></i>',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),Mo=t=>L.divIcon({className:"bus-vivo-icono",html:`<span>${(t||"??").replace("koox-","")}</span>`,iconSize:[30,30],iconAnchor:[15,15]});function se(t){if(he)return he.setLatLng(t),he;let e=L.divIcon({className:"user-gps-marker",iconSize:[20,20],iconAnchor:[10,10]});return he=L.marker(t,{icon:e,zIndexOffset:1e3}).addTo(f),he}function U(t,e=null){let o=t.properties.nombre||t.properties.Name,n=t.properties.originalIndex,a=(t.properties.rutas||[]).join(", "),i=`<div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">${o}</div>`;if(e){let r="#333";(e.includes("Subir")||e.includes("Inicio"))&&(r="#007bff"),e.includes("Transbordo")&&(r="#E69500"),(e.includes("Destino")||e.includes("Bajar"))&&(r="#dc3545"),i=`
            <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${r};">${e}</div>
            <div style="font-size: 1.0em; font-weight: bold; margin-bottom: 5px;">${o}</div>`}return`
        ${i}
        <strong style="font-size: 0.9em;">Rutas:</strong>
        <p style="font-size: 0.9em; margin: 4px 0;">${a||"N/A"}</p>
        <button class="btn-popup btn-ver-rutas-paradero" data-paradero-id="${n}">
            Ver detalles
        </button>
    `}function De(t){let e=[];if(t.forEach(n=>{n.filter(i=>i.tipo==="bus").forEach(i=>{e.push(i.ruta)})}),e.length===0)return;let o=turf.featureCollection(e);H=L.geoJSON(o,{style:n=>{let a="#"+Math.floor(Math.random()*16777215).toString(16);return t.length===1&&(a="#0052FF"),{color:a,weight:5,opacity:.7}}}).addTo(f),H.getBounds().isValid()&&f.fitBounds(H.getBounds().pad(.1))}function ce(){H&&(f.removeLayer(H),H=null),be&&(f.hasLayer(be)&&f.removeLayer(be),be=null)}function qt(t,e){ce(),S.clearLayers();let o=e.geometry.coordinates,n=[o[1],o[0]],a;switch(t.tipo){case"caminar":let i=t.paradero.geometry.coordinates,r=[i[1],i[0]];be=L.polyline([n,r],{color:"#666",dashArray:"5, 10",weight:4}).addTo(f),L.marker(r,{icon:Be}).addTo(S).bindPopup(U(t.paradero,"Dir\xEDgete aqu\xED")),a=L.latLngBounds(n,r);break;case"bus":H=L.geoJSON(t.ruta,{style:{color:"#0052FF",weight:6}}).addTo(f);let s=[t.paraderoInicio.geometry.coordinates[1],t.paraderoInicio.geometry.coordinates[0]],l=[t.paraderoFin.geometry.coordinates[1],t.paraderoFin.geometry.coordinates[0]];L.marker(s,{icon:Be}).addTo(S).bindPopup(U(t.paraderoInicio,"Subir aqu\xED")),L.marker(l,{icon:Ne}).addTo(S).bindPopup(U(t.paraderoFin,"Bajar aqu\xED")),a=H.getBounds();break;case"transbordo":let p=[t.paradero.geometry.coordinates[1],t.paradero.geometry.coordinates[0]];L.marker(p,{icon:tt}).addTo(S).bindPopup(U(t.paradero,"Transbordo Aqu\xED")).openPopup(),f.setView(p,17);break;case"fin":let b=[t.paradero.geometry.coordinates[1],t.paradero.geometry.coordinates[0]];L.marker(b,{icon:Ne}).addTo(S).bindPopup(U(t.paradero,"\xA1Destino!")).openPopup(),f.setView(b,17);break}return a}function Ut(t,e){if(ce(),S.clearLayers(),ot(),!t)return;H=L.geoJSON(t,{style:{color:"#FF0000",weight:6,opacity:.8}}).addTo(f);let o=e.map(a=>{let i=a.geometry.coordinates,r=[i[1],i[0]],s=U(a),l=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-10]});return L.marker(r,{icon:l}).bindPopup(s)});o.forEach(a=>a.addTo(S));let n=L.featureGroup([H,...o]);n.getBounds().isValid()&&f.fitBounds(n.getBounds().pad(.1))}function zt(t,e,o){if(!o||o.length<2||!f)return;let n=Mo(e),a=`<b>Unidad ${t}</b><br>Ruta ${e}`,i={icon:n,zIndexOffset:1e3,rutaId:e};if(Z.has(t)){let r=Z.get(t);r.setLatLng(o),r.setIcon(n),r.getPopup().setContent(a),r.options.rutaId=e}else{let r=L.marker(o,i).addTo(Re).bindPopup(a);Z.set(t,r)}}function Vt(t){Z.has(t)&&(Re.removeLayer(Z.get(t)),Z.delete(t))}function ot(){Z.forEach(t=>Re.removeLayer(t)),Z.clear()}function Oe(t,e){let o={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};return navigator.geolocation.watchPosition(t,e,o)}function ve(t){t&&navigator.geolocation.clearWatch(t)}function Ht(t,e){let o=new Map;return t.forEach(n=>{o.set(n.properties.id,new Set)}),e.forEach(n=>{n.properties.rutas.forEach(a=>{o.has(a)&&o.get(a).add(n)})}),o}function ye(t,e,o,n,a){console.log(`Buscando rutas \xF3ptimas desde "${t.properties.nombre}" hasta "${e.properties.nombre}"`);let i=[],r=new Map,s=[],l=1/0,p=4,b=new Map;o.forEach(g=>{b.set(g.properties.originalIndex,g.properties.rutas)});let d=[{tipo:"caminar",paradero:t,texto:`Dir\xEDgete a ${t.properties.nombre}`}];for(r.set(t.properties.nombre,0),i.push(d);i.length>0;){let g=i.shift(),u=g[g.length-1],v=u.tipo==="caminar"?u.paradero:u.paraderoFin,C=g.filter(B=>B.tipo==="bus").length;if(C>=l||C>=p)continue;let Y=b.get(v.properties.originalIndex)||[],fe=new Set(g.filter(B=>B.tipo==="bus").map(B=>B.ruta.properties.id));for(let B of Y){if(fe.has(B))continue;let $e=a.get(B),te=n.find(E=>E.properties.id===B);if(!(!$e||!te))for(let E of $e){if(E.properties.nombre===v.properties.nombre)continue;let P=C+1,N=r.get(E.properties.nombre);if(N&&N<P)continue;r.set(E.properties.nombre,P);let O={tipo:"bus",ruta:te,paraderoInicio:v,paraderoFin:E,texto:`Toma ${te.properties.id} y baja en ${E.properties.nombre}`};E.properties.nombre===e.properties.nombre?(O.texto+=" (Destino)",s.push([...g,O]),l=P):(b.get(E.properties.originalIndex)||[]).some(oe=>!fe.has(oe)&&oe!==B)&&i.push([...g,O])}}}console.log(`B\xFAsqueda finalizada. Se encontraron ${s.length} soluciones (antes de filtrar).`);let c=s.filter(g=>g.filter(u=>u.tipo==="bus").length===l),m=new Map;c.forEach(g=>{let u=g.filter(v=>v.tipo==="bus").map(v=>v.ruta.properties.id).join("->");m.has(u)||m.set(u,g)});let h=Array.from(m.values());return console.log(`Se encontraron ${h.length} rutas \xF3ptimas \xFAnicas.`),h}function _t(t,e){t.forEach(n=>{n.properties.rutas=[],e.forEach(a=>{if(a.geometry)try{let i=a;turf.nearestPointOnLine(i,n).properties.dist*1e3<25&&n.properties.rutas.push(a.properties.id)}catch(i){console.warn(`Advertencia Turf: Error al proyectar ${n.properties.nombre} en la ruta ${a.properties.id}.`,i)}})})}var K=JSON.parse(localStorage.getItem("kooxSettings"))||{darkMode:!1,largeText:!1,highContrast:!1,vibration:!0},ne,ae,ie,Le;function Gt(){let t=document.body;K.darkMode?(t.classList.add("dark-mode"),ne&&(ne.checked=!0)):(t.classList.remove("dark-mode"),ne&&(ne.checked=!1)),K.largeText?(t.classList.add("large-text"),ae&&(ae.checked=!0)):(t.classList.remove("large-text"),ae&&(ae.checked=!1)),K.highContrast?(t.classList.add("high-contrast"),ie&&(ie.checked=!0)):(t.classList.remove("high-contrast"),ie&&(ie.checked=!1)),Le&&(Le.checked=K.vibration)}function je(t,e){K[t]=e,localStorage.setItem("kooxSettings",JSON.stringify(K)),Gt(),console.log(`Ajuste actualizado: ${t} = ${e}`)}function Jt(){let t=document.getElementById("btnAjustes"),e=document.getElementById("settings-modal"),o=document.getElementById("btnCloseSettings");ne=document.getElementById("checkDarkMode"),ae=document.getElementById("checkLargeText"),ie=document.getElementById("checkHighContrast"),Le=document.getElementById("checkVibration"),t&&e&&t.addEventListener("click",()=>{e.classList.remove("oculto")}),o&&e&&o.addEventListener("click",()=>{e.classList.add("oculto")}),ne&&ne.addEventListener("change",n=>je("darkMode",n.target.checked)),ae&&ae.addEventListener("change",n=>je("largeText",n.target.checked)),ie&&ie.addEventListener("change",n=>je("highContrast",n.target.checked)),Le&&Le.addEventListener("change",n=>je("vibration",n.target.checked)),Gt(),console.log("M\xF3dulo de Ajustes: Inicializado.")}var Ue=null,nt=0,Fe=0,qe=!1,Ee=null,we=null,at=0,it=null,Ie=!1,Co=1,$o=3;function Kt(t){Ue=t,nt=0,Fe=0,qe=!1,Ee=Date.now(),we=Ue,it=Date.now(),at=0,Ie=!1,console.log("NavigationService: Iniciado.")}function rt(){Ue=null,Ee=null,we=null,it=null,Ie=!1,console.log("NavigationService: Detenido.")}function st(){console.log("NavigationService: Modo Transbordo ACTIVADO."),Ie=!0}function Wt(t,e){if(!Ue||!Ee||!we)return null;let o=Date.now(),n=(o-Ee)/1e3,a=turf.distance(we,t,{units:"meters"});a>1&&(nt+=a),at=Math.floor((o-it)/1e3);let i=!1;return e!=null?e>Co&&(i=!0):a>$o&&(i=!0),i?(qe=!0,Fe=0):(qe=!1,Ie||(Fe+=n)),we=t,Ee=o,{distanciaRecorrida:nt,tiempoDetenido:Math.round(Fe),enMovimiento:qe,tiempoTotalViaje:at,enModoTransbordo:Ie}}W();var mt=z("KeepAwake",{web:()=>Promise.resolve().then(()=>(to(),eo)).then(t=>new t.KeepAwakeWeb)});W();function jo(t){t.CapacitorUtils.Synapse=new Proxy({},{get(e,o){return new Proxy({},{get(n,a){return(i,r,s)=>{let l=t.Capacitor.Plugins[o];if(l===void 0){s(new Error(`Capacitor plugin ${o} not found`));return}if(typeof l[a]!="function"){s(new Error(`Method ${a} not found in Capacitor plugin ${o}`));return}(async()=>{try{let p=await l[a](i);r(p)}catch(p){s(p)}})()}}})}})}function Fo(t){t.CapacitorUtils.Synapse=new Proxy({},{get(e,o){return t.cordova.plugins[o]}})}function oo(t=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},window.Capacitor!==void 0&&!t?jo(window):window.cordova!==void 0&&Fo(window))}var ft=z("Geolocation",{web:()=>Promise.resolve().then(()=>(ao(),no)).then(t=>new t.GeolocationWeb)});oo();W();var io;(function(t){t[t.Sunday=1]="Sunday",t[t.Monday=2]="Monday",t[t.Tuesday=3]="Tuesday",t[t.Wednesday=4]="Wednesday",t[t.Thursday=5]="Thursday",t[t.Friday=6]="Friday",t[t.Saturday=7]="Saturday"})(io||(io={}));var ht=z("LocalNotifications",{web:()=>Promise.resolve().then(()=>(so(),ro)).then(t=>new t.LocalNotificationsWeb)});W();var vt=z("Dialog",{web:()=>Promise.resolve().then(()=>(lo(),co)).then(t=>new t.DialogWeb)});var Uo="-90.65,19.75,-90.45,19.95";async function uo(t,e=20){if(!t||t.length<3)return[];let o=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&viewbox=${Uo}&bounded=1&limit=${e}`;try{return(await(await fetch(o)).json()).map(i=>({lat:parseFloat(i.lat),lng:parseFloat(i.lon),nombre:i.display_name.split(",")[0],direccion:i.display_name}))}catch(n){return console.error("Error en searchService:",n),[]}}var yt=[{nombre:"Catedral de Campeche",query:"Catedral de Campeche",icono:"ri-church-line"},{nombre:"Baluarte de San Francisco",query:"Baluarte de San Francisco",icono:"ri-ancient-gate-line"},{nombre:"Malec\xF3n de Campeche",query:"Malec\xF3n de Campeche",icono:"ri-road-map-line"},{nombre:"Fuerte de San Miguel",query:"Fuerte de San Miguel Campeche",icono:"ri-flag-line"},{nombre:"Parque Principal",query:"Parque Principal Campeche",icono:"ri-tree-line"},{nombre:"Mercado Pedro Sainz",query:"Mercado Pedro Sainz de Baranda",icono:"ri-store-2-line"}],po=[{label:"Salud",query:"Hospital",icono:"ri-hospital-line"},{label:"Escuelas",query:"Escuela",icono:"ri-school-line"},{label:"Super",query:"Supermercado",icono:"ri-shopping-cart-2-line"},{label:"Farmacias",query:"Farmacia",icono:"ri-capsule-line"},{label:"Bancos",query:"Banco",icono:"ri-bank-line"}];async function zo(){try{await mt.keepAwake(),console.log("Modo KeepAwake activado: La pantalla no se apagar\xE1.")}catch(t){console.error("Error al activar KeepAwake:",t)}}async function Vo(){try{if((await ft.checkPermissions()).location!=="granted"){let{value:o}=await vt.confirm({title:"Permiso de Ubicaci\xF3n",message:"Para mostrarte tu posici\xF3n en el mapa y avisarte cuando llegues a tu parada, Rutas Koox necesita acceder a tu ubicaci\xF3n. \xBFNos das permiso?",okButtonTitle:"Claro, activar",cancelButtonTitle:"Ahora no"});o&&(await ft.requestPermissions()).location!=="granted"&&console.warn("El usuario deneg\xF3 el GPS.")}if((await ht.checkPermissions()).display!=="granted"){let{value:o}=await vt.confirm({title:"Alertas de Viaje",message:"\xBFTe gustar\xEDa que te avisemos cuando est\xE9s cerca de bajar del autob\xFAs? Activa las notificaciones para no perder tu parada.",okButtonTitle:"Activar Alertas",cancelButtonTitle:"No gracias"});o&&await ht.requestPermissions()}await mt.keepAwake(),console.log("Modo viaje activo: Pantalla encendida.")}catch(t){console.error("Error al solicitar permisos:",t)}}var Ho={apiKey:"AIzaSyDozEdN4_g7u-D6XcJdysuns8-iLbfMS5I",authDomain:"rutaskoox-alertas.firebaseapp.com",databaseURL:"https://rutaskoox-alertas-default-rtdb.firebaseio.com/",projectId:"rutaskoox-alertas",storageBucket:"rutaskoox-alertas.firebasestorage.app",messagingSenderId:"332778953247",appId:"1:332778953247:web:4460fef290b88fb1b1932a",measurementId:"G-XH7ZKS825M"};firebase.initializeApp(Ho);var _o=firebase.firestore(),Go=firebase.database(),k=[],A=[],Lo=null,me=new Map,X=[],y=[],x=0,ke=!1,pe=null,re=!0,I=null,w=null,M=null,T=null,ue=0,wt,F,Ve,G=null,mo,Lt=null;var Jo,It,He=null,xt=null,Pt=null,fo=null,_e=null,Pe=null,Q=null,Et=!1,St,$,q,Me,Ke,V,D,Nt,kt,Se,Mt,Ct,$t,Tt,Ce,go,ho,de,bo,Ge,ee,_;function Ko(t){let e=A.find(o=>o.properties.id===t);return e?`${e.properties.id} (${e.properties.nombre})`:t}function vo(t){t?(He.textContent=t,He.classList.remove("oculto")):He.classList.add("oculto")}function Xe(){if(!xt)return;let t=xt.val(),e=Io(),o=Date.now();if(e&&t&&t[e]){let n=t[e],a=Ko(e);if(o<n.expiraEn){vo(`\u26A0\uFE0F ALERTA: ${n.mensaje} en ${a}`);return}}vo(null)}document.addEventListener("DOMContentLoaded",async()=>{let t=document.getElementById("btnTestSimulador");t&&t.addEventListener("click",()=>{typeof window.simularBus=="function"?window.simularBus():alert("\u26A0\uFE0F Error: La funci\xF3n simularBus no se ha cargado. Revisa el final de tu archivo app.js")});let e=document.getElementById("btnBuscarLugar"),o=document.getElementById("info-lugar-buscado"),n=document.getElementById("contenedor-chips"),a=document.getElementById("btnModoTurista"),i=document.getElementById("btnMinimizarPanel"),r=document.getElementById("btnMinimizarNav");St=document.getElementById("selectDestino"),$=document.getElementById("inputInicio"),q=document.getElementById("panel-instrucciones"),Me=document.getElementById("btnIniciarRuta"),Ke=document.getElementById("btnLimpiar"),V=document.getElementById("panel-control"),D=document.getElementById("panel-navegacion"),Nt=document.getElementById("instruccion-actual"),kt=document.getElementById("btnAnterior"),Se=document.getElementById("btnSiguiente"),Mt=document.getElementById("btnFinalizar"),wt=document.getElementById("distancia-restante"),F=document.getElementById("tiempo-espera"),Ct=document.getElementById("panel-viaje"),$t=document.getElementById("panel-explorar"),Tt=document.getElementById("selectRuta"),Ce=document.getElementById("instrucciones-explorar"),go=document.getElementById("btnLimpiarExplorar"),ho=document.getElementById("btnInfo"),de=document.getElementById("info-modal"),bo=document.getElementById("btnCloseModal"),Ve=document.getElementById("tiempo-viaje"),mo=document.getElementById("btnParaderosCercanos"),He=document.getElementById("alert-indicator"),Jo=document.getElementById("btnModoReporte"),It=document.getElementById("panel-reporte"),Vo(),Jt();let s=document.querySelectorAll(".nav-item"),l=document.getElementById("pantalla-saldo"),p=document.getElementById("pantalla-recargas");s.forEach(c=>{c.addEventListener("click",m=>{let h=m.currentTarget,g=h.dataset.target;if(h.classList.contains("activo")&&(g==="viaje"||g==="explorar"||g==="reporte")){d();return}s.forEach(v=>v.classList.remove("activo")),h.classList.add("activo"),Qo(g)})}),zo(),Lt=document.getElementById("offline-indicator");let b=()=>{navigator.onLine?Lt.classList.add("oculto"):Lt.classList.remove("oculto")};window.addEventListener("offline",b),window.addEventListener("online",b),b();try{Go.ref("alertas").on("value",m=>{xt=m,Xe()})}catch(c){console.error("No se pudo conectar a Firebase Realtime Database",c)}hn(),Ge=document.getElementById("selectInicioManual"),ee=document.getElementById("control-input-inicio"),_=document.getElementById("control-select-inicio"),mo.addEventListener("click",mn),Ke.addEventListener("click",At),Me.addEventListener("click",wo),Se.addEventListener("click",We),kt.addEventListener("click",sn),Mt.addEventListener("click",nn),go.addEventListener("click",At),document.querySelectorAll(".btn-reporte").forEach(c=>{c.addEventListener("click",m=>{let h=m.target.dataset.tipo;gn(h)})}),ho.addEventListener("click",()=>de.classList.remove("oculto")),bo.addEventListener("click",()=>de.classList.add("oculto")),de.addEventListener("click",c=>{c.target===de&&de.classList.add("oculto")}),V.classList.add("oculto"),D.classList.add("oculto"),_&&(_.style.display="none"),Ft(),n&&po.forEach(c=>{let m=document.createElement("button");m.className="chip",m.innerHTML=`<i class="${c.icono}"></i> ${c.label}`,m.addEventListener("click",()=>{Bt(`${c.query} en Campeche`)}),n.appendChild(m)}),e&&e.addEventListener("click",()=>{let c=prompt(`\u{1F50D} \xBFA d\xF3nde quieres ir?
(Ej: Walmart, IMSS, Secundaria 7)`);c&&c.trim().length>2&&Bt(c)}),a&&a.addEventListener("click",()=>{vn()});function d(){V.classList.add("oculto"),D.classList.add("oculto"),document.querySelectorAll(".nav-item").forEach(c=>c.classList.remove("activo"))}i&&i.addEventListener("click",d),r&&r.addEventListener("click",d),f.on("click",()=>{d()}),f.on("popupopen",c=>{let h=c.popup.getElement().querySelector(".btn-ver-rutas-paradero");h&&h.addEventListener("click",fn)}),f.on("contextmenu",c=>{if(c.originalEvent.preventDefault(),!w){alert("Por favor, selecciona un punto de inicio o espera a que tu GPS se active antes de fijar un destino.");return}console.log("Clic largo detectado. Buscando paradero m\xE1s cercano...");let m=turf.point([c.latlng.lng,c.latlng.lat]),h=Qe(m);if(!h){alert("No se encontraron paraderos cercanos a ese punto.");return}M=h,T.setChoiceByValue(h.properties.originalIndex),console.log(`Destino fijado en: ${M.properties.nombre}`),X=ye(w,M,k,A,me),Ze(X),et()});try{let[c,m]=await Promise.all([fetch("data/paraderos.geojson"),fetch("data/rutas.geojson")]),h=await c.json(),g=await m.json();k=h.features.map((u,v)=>(u.properties.originalIndex=v,u)).filter(u=>!u||!u.geometry||!u.geometry.coordinates||u.geometry.coordinates.length<2||typeof u.geometry.coordinates[0]!="number"||typeof u.geometry.coordinates[1]!="number"?(console.warn(`Paradero inv\xE1lido/sin coordenadas en \xEDndice ${u.properties.originalIndex} (${u.properties.name}). Omitiendo.`),!1):!0),k.forEach(u=>{let v=u.properties;u.properties.nombre=v.nombre||v.Name||v.Paradero||v.NOMVIAL||"Paradero sin nombre"}),k.sort((u,v)=>u.properties.nombre.localeCompare(v.properties.nombre)),A=g.features,A.forEach(u=>{let v=u.properties,C=v.name||v.Name||v.Ruta||"Ruta desconocida";u.properties.id=C.split(" ").slice(0,2).join("-").toLowerCase(),u.properties.nombre=C.split(" ").slice(2).join(" ")}),console.log("Enlazando paraderos a rutas..."),_t(k,A),console.log("Creando mapa de b\xFAsqueda de rutas..."),me=Ht(A,k),console.log("\xA1Enlace completado!"),Lo=turf.featureCollection(k),Yo(),Zo(),en(),Pe=Oe(Eo,Ye),Dt()}catch(c){console.error("Error cargando o procesando los datos GeoJSON:",c)}});function Eo(t){let e=t.coords.latitude,o=t.coords.longitude;if(e===0&&o===0){console.error("Posici\xF3n GPS inv\xE1lida (0,0) detectada."),Et||(Ye({code:0,message:"Posici\xF3n GPS inv\xE1lida (0,0)"}),$.value="Error de GPS (0,0)");return}I=turf.point([o,e]),w=Qe(I),$.value=`Cerca de "${w.properties.nombre}"`,$.style.fontStyle="normal",$.style.color="black",$.style.fontWeight="normal",Et||(Et=!0,f.setView([e,o],16),se([e,o]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup())}function Ye(t){console.warn(`ERROR DE UBICACI\xD3N (${t.code}): ${t.message}`),$.value="Ubicaci\xF3n bloqueada",$.style.color="red",$.style.fontWeight="bold";let e="GPS bloqueado o desactivado",o="Parece que tu navegador (como el de Facebook) bloquea la geolocalizaci\xF3n o el permiso fue denegado.";t.code===2?(e="GPS no disponible",o="No pudimos obtener una se\xF1al de GPS. Revisa que tu ubicaci\xF3n est\xE9 encendida."):(t.code===0||t.message==="Posici\xF3n GPS inv\xE1lida (0,0)")&&(e="Error de GPS",o="Tu GPS report\xF3 una ubicaci\xF3n inv\xE1lida (0,0). Intenta moverte a un \xE1rea con mejor se\xF1al."),q.innerHTML=`
        <div class="alerta-manual">
            <h5 style="margin-top:0;">${e}</h5>
            <p>${o}</p>
            <p><strong>Soluciones:</strong></p>
            <div class="alerta-manual-botones">
                <button id="btnModoManual" class="btn-alerta btn-primario">
                    \u{1F4CD} Usar Modo Manual
                </button>
                <button id="btnCopiarLink" class="btn-alerta btn-secundario">
                    \u{1F4CB} Copiar Link
                </button>
            </div>
            <small style="display: block; margin-top: 10px; text-align: center;">
                (Puedes copiar el link y pegarlo en Chrome o Safari)
            </small>
        </div>
    `,document.getElementById("btnModoManual").addEventListener("click",Wo),document.getElementById("btnCopiarLink").addEventListener("click",Xo)}function Wo(){console.log("Activando modo manual"),ee&&(ee.style.display="none"),_&&(_.style.display="block"),q.innerHTML=`
        <p>Has activado el modo manual.</p>
        <p>1. Selecciona tu <strong>paradero de inicio</strong>.</p>
        <p>2. Selecciona tu <strong>paradero de destino</strong>.</p>
    `,w=null,I=null}function Xo(){try{navigator.clipboard.writeText(window.location.href),alert(`\xA1Link copiado al portapapeles!

P\xE9galo en un navegador como Chrome, Safari o Firefox para un mejor funcionamiento.`)}catch(t){console.error("Error al copiar link:",t),alert("No se pudo copiar el link. Por favor, hazlo manualmente desde la barra de direcciones.")}}function Yo(){let t=k.map(e=>{let o=e.properties,n=o.NOMVIAL||o.calle_cercana||"",a=o.NOM_COL||o.colonia_cercana||"";return{value:o.originalIndex,label:o.nombre,customProperties:{calle:n,colonia:a}}});T=new Choices(St,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe paradero, calle o colonia...",shouldSort:!1,removeItemButton:!0,searchFields:["label","customProperties.calle","customProperties.colonia"],callbackOnCreateTemplates:function(e){return{item:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return e(`<div class="${o.item} ${n.highlighted?o.highlightedState:o.itemSelectable}" data-item data-value="${n.value}" ${n.active?'aria-selected="true"':""} ${n.disabled?'aria-disabled="true"':""}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)},choice:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return e(`<div class="${o.item} ${o.itemChoice} ${n.disabled?o.itemDisabled:o.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${n.disabled?'data-choice-disabled aria-disabled="true"':"data-choice-selectable"}" data-id="${n.id}" data-value="${n.value}" ${n.groupId>0?'role="treeitem"':'role="option"'}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)}}}}),St.addEventListener("change",e=>{if(!w){alert("Espera a que se detecte tu ubicaci\xF3n o selecciona un inicio manual."),T.clearInput(),T.removeActiveItems();return}let o=e.detail.value;o&&(M=k.find(a=>a.properties.originalIndex==o),X=ye(w,M,k,A,me),Ze(X))})}function Zo(){if(!Ge)return;let t=k.map(e=>{let o=e.properties,n=o.NOMVIAL||o.calle_cercana||"",a=o.NOM_COL||o.colonia_cercana||"";return{value:o.originalIndex,label:o.nombre,customProperties:{calle:n,colonia:a}}});Q=new Choices(Ge,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe paradero, calle o colonia...",shouldSort:!1,removeItemButton:!0,searchFields:["label","customProperties.calle","customProperties.colonia"],callbackOnCreateTemplates:function(e){return{item:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return e(`<div class="${o.item} ${n.highlighted?o.highlightedState:o.itemSelectable}" data-item data-value="${n.value}" ${n.active?'aria-selected="true"':""} ${n.disabled?'aria-disabled="true"':""}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)},choice:({classNames:o},n)=>{let a=n.customProperties||{},i=a.calle||a.colonia||"";return e(`<div class="${o.item} ${o.itemChoice} ${n.disabled?o.itemDisabled:o.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${n.disabled?'data-choice-disabled aria-disabled="true"':"data-choice-selectable"}" data-id="${n.id}" data-value="${n.value}" ${n.groupId>0?'role="treeitem"':'role="option"'}>
                            <span>${n.label}</span>
                            <small>${i}</small> </div>`)}}}}),Ge.addEventListener("change",e=>{let o=e.detail.value;o&&(w=k.find(n=>n.properties.originalIndex==o),console.log("Inicio manual fijado:",w.properties.nombre),M&&(X=ye(w,M,k,A,me),Ze(X)))})}function Qo(t){console.log("Cambiando a modo:",t);let e=document.getElementById("pantalla-saldo"),o=document.getElementById("pantalla-recargas");e&&e.classList.add("oculto"),o&&o.classList.add("oculto"),Ct.classList.add("oculto"),$t.classList.add("oculto"),It.classList.add("oculto"),t==="saldo"?(V.classList.add("oculto"),D.classList.add("oculto"),e&&e.classList.remove("oculto")):t==="recargas"?(V.classList.add("oculto"),D.classList.add("oculto"),o&&o.classList.remove("oculto")):(pe!==null&&t==="viaje"?(V.classList.add("oculto"),D.classList.remove("oculto")):(V.classList.remove("oculto"),D&&D.classList.add("oculto")),t==="viaje"?Ct.classList.remove("oculto"):t==="explorar"?$t.classList.remove("oculto"):t==="reporte"&&It.classList.remove("oculto")),document.querySelectorAll(".nav-item").forEach(n=>{let a=n.querySelector("i");n.dataset.target===t?(n.classList.add("activo"),a&&a.className.includes("-line")&&(a.className=a.className.replace("-line","-fill"))):(n.classList.remove("activo"),a&&a.className.includes("-fill")&&(a.className=a.className.replace("-fill","-line")))}),Xe()}function en(){A.sort((e,o)=>e.properties.id.localeCompare(o.properties.id,void 0,{numeric:!0}));let t=A.map(e=>({value:e.properties.id,label:`${e.properties.id} (${e.properties.nombre})`}));G=new Choices(Tt,{choices:t,itemSelectText:"Seleccionar",searchPlaceholderValue:"Escribe para filtrar...",shouldSort:!1}),Tt.addEventListener("change",e=>{e.detail.value&&tn(e.detail.value)})}function tn(t){let e=A.find(a=>a.properties.id===t);if(!e)return;let o=me.get(t),n=o?[...o]:[];Ut(e,n),Xe(),xo(t,null),Ce.innerHTML=`
        <p>Mostrando <strong>${e.properties.id}</strong>.</p>
        <p>Esta ruta tiene aproximadamente <strong>${n.length}</strong> paraderos.</p>
    `}function At(){if(De([]),ce(),Xe(),S.clearLayers(),Ot(),q.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>",Dt(),D.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",F.className="",rt(),ve(pe),T&&(T.clearInput(),T.removeActiveItems()),_&&(_.style.display="none"),ee&&(ee.style.display="block"),Q&&(Q.clearInput(),Q.removeActiveItems()),T&&(T.clearInput(),T.removeActiveItems()),Q&&(Q.clearInput(),Q.removeActiveItems()),G&&(G.clearInput(),G.removeActiveItems()),_&&(_.style.display="none"),ee&&(ee.style.display="block"),Me.style.display="none",Ke.style.display="none",Ce.innerHTML="Selecciona una ruta para ver su trayecto y paraderos.",D.classList.add("oculto"),document.getElementById("nav-estado").style.display="flex",F.className="",rt(),ve(pe),pe=null,I){w=Qe(I),$.value=`Cerca de "${w.properties.nombre}"`,$.style.color="black",$.style.fontWeight="normal";let t=I.geometry.coordinates;f.setView([t[1],t[0]],16),se([t[1],t[0]]).bindPopup("<b>Est\xE1s aqu\xED</b>").openPopup()}else w=null,$.value="Detectando ubicaci\xF3n...",$.style.color="black",$.style.fontWeight="normal"}function Ze(t){q.innerHTML="",S.clearLayers(),ce();let e=I||w;if(!e){q.innerHTML="<p><strong>Error:</strong> No se ha fijado un punto de inicio.</p>";return}let o=e.geometry.coordinates;L.marker([o[1],o[0]]).addTo(S).bindPopup(I?"<b>Est\xE1s aqu\xED</b>":`<b>Inicio (Manual):</b><br>${w.properties.nombre}`);let n=M.geometry.coordinates,a=[n[1],n[0]],i=U(M,"Destino Final");if(L.marker(a,{icon:Ne}).addTo(S).bindPopup(i),!t||t.length===0)return;let r=t[0],s=r.filter(d=>d.tipo==="bus"),l=r.find(d=>d.tipo==="caminar");if(l){let d=l.paradero,c=d.geometry.coordinates,m=[c[1],c[0]],h=U(d,"Subir aqu\xED");L.marker(m,{icon:Be}).addTo(S).bindPopup(h)}for(let d=0;d<s.length-1;d++){let c=s[d].paraderoFin,m=c.geometry.coordinates,h=[m[1],m[0]],g=U(c,"Transbordo Aqu\xED");L.marker(h,{icon:tt}).addTo(S).bindPopup(g)}let p=document.createDocumentFragment(),b=document.createElement("p");b.innerHTML=`<strong>Se encontraron ${t.length} opciones:</strong>`,p.appendChild(b),t.forEach((d,c)=>{let m=document.createElement("div");m.className="opcion-ruta";let h=d.filter(C=>C.tipo==="bus").map(C=>C.ruta.properties.id),g=document.createElement("h4");g.innerHTML=`Opci\xF3n ${c+1} <span style="font-weight:normal; font-size: 0.8em;">(${h.join(" &rarr; ")})</span>`,m.appendChild(g);let u=document.createElement("ol");d.forEach(C=>{if(C.tipo==="caminar"||C.tipo==="bus"){let Y=document.createElement("li");Y.textContent=C.texto,u.appendChild(Y)}}),m.appendChild(u);let v=document.createElement("button");v.className="btn-seleccionar",v.innerHTML='Seleccionar <i class="ri-arrow-right-line"></i>',v.addEventListener("click",()=>{on(c)}),m.appendChild(v),p.appendChild(m)}),q.appendChild(p),De(t),Ke.style.display="block",Me.style.display="none"}var on=t=>{y=X[t],ue=0;let e=I||w;y.forEach(a=>{let i=0;try{if(a.tipo==="caminar"){i=turf.distance(e,a.paradero,{units:"meters"}),ue+=i,e=a.paradero;let r=Math.max(1,Math.round(i/80));a.distanciaMetros=i,a.tiempoEstimadoMin=r,a.texto=`Dir\xEDgete a ${a.paradero.properties.nombre} (${i.toFixed(0)} m - ${r} min \u{1F6B6}\u200D\u2642\uFE0F)`}else if(a.tipo==="bus"){let r=a.ruta;if(a.ruta.geometry.type==="MultiLineString")try{let b=a.ruta.geometry.coordinates.flat();r=turf.lineString(b)}catch{console.warn("No se pudo aplanar la ruta MultiLineString, usando c\xE1lculo simple.")}let s=turf.nearestPointOnLine(r,a.paraderoInicio),l=turf.nearestPointOnLine(r,a.paraderoFin),p=turf.lineSlice(s,l,r);i=turf.length(p,{units:"meters"}),ue+=i,e=a.paraderoFin,a.distanciaMetros=i,a.texto=`Toma ${a.ruta.properties.id} y baja en ${a.paraderoFin.properties.nombre} (${(i/1e3).toFixed(1)} km)`}else a.tipo==="transbordo"&&(a.texto=`En ${a.paradero.properties.nombre}, espera el siguiente cami\xF3n.`)}catch(r){console.error("Error calculando distancia del paso:",a,r)}}),console.log(`Distancia total de la ruta: ${ue} metros`);let n=y.filter(a=>a.tipo==="bus").map(a=>a.ruta.properties.id).join(" \u2192 ");q.innerHTML=`
        <p><strong>Ruta seleccionada. \xA1Listo para navegar!</strong></p>
        <p>${n}</p>
        <p><strong>Distancia total:</strong> ${(ue/1e3).toFixed(2)} km</p>
        
        <div class="panel-acciones">
            <button id="btnIniciarRuta">Iniciar Ruta</button>
            <button id="btnGuardarFavorito" class="btn-secundario">\u2B50\uFE0F Guardar Favorito</button>
        </div>
    `,q.querySelector("#btnIniciarRuta").addEventListener("click",wo),q.querySelector("#btnGuardarFavorito").addEventListener("click",()=>{dn()}),Me.style.display="none",De([y])};function Qe(t){return turf.nearestPoint(t,Lo)}function wo(){if(!(!y||y.length===0)){try{let t=y.filter(o=>o.tipo==="bus").map(o=>o.ruta.properties.id).join(" \u2192 "),e={inicioId:w.properties.originalIndex,inicioNombre:w.properties.nombre,finId:M.properties.originalIndex,finNombre:M.properties.nombre,rutaResumen:t,fecha:new Date().toISOString()};ln(e)}catch(t){console.error("Error al guardar en el historial:",t)}x=0,ke=!1,V.classList.add("oculto"),D.classList.remove("oculto"),I?(console.log("Iniciando modo de navegaci\xF3n GPS (Activo)..."),ve(Pe),document.getElementById("nav-estado").style.display="flex",se(I.geometry.coordinates.slice().reverse()),Kt(I),pe=Oe(an,Ye),f.on("dragstart",()=>{re=!1})):(console.log("Iniciando modo de navegaci\xF3n MANUAL (Pasivo)..."),document.getElementById("nav-estado").style.display="none",pe=null,re=!0),jt(x),Rt(x)}}function nn(){console.log("Finalizando navegaci\xF3n."),D.classList.add("oculto"),V.classList.remove("oculto"),f.off("dragstart"),Pe&&ve(Pe),Pe=Oe(Eo,Ye),At()}function an(t){let e=t.coords.latitude,o=t.coords.longitude,n=t.coords.speed,a=[e,o];I=turf.point([o,e]),se(a),re&&f.panTo(a);let i=Wt(I,n);if(i){if(y&&x<y.length){let r=y[x];if(r.tipo==="caminar"||r.tipo==="transbordo"){let s=y[x+1];if(s&&s.tipo==="bus"){let l=s.ruta.properties.id,p=[];f.eachLayer(m=>{m.options&&m.options.rutaId===l&&p.push(m)});let b=null,d=1/0;if(p.forEach(m=>{let h=m.getLatLng(),g=turf.point([h.lng,h.lat]),u=turf.distance(I,g,{units:"meters"})*1e3;u<d&&(d=u,b=m)}),b&&d<20){console.log(`DETECCI\xD3N A BORDO: Distancia ${d.toFixed(2)}m. Asumiendo subida.`),st(!1),We();return}}}}cn(i),rn(i)}}function rn(t){if(!y||y.length===0||x>=y.length)return;let e=y[x],o=40;if(!I)return;let n=null,a=null;if(e.tipo==="caminar"?n=e.paradero:e.tipo==="bus"&&(n=e.paraderoFin,a=e.ruta),e.tipo==="caminar"&&turf.distance(I,n,{units:"meters"})<25){console.log("Llegaste al paradero de subida, avanzando..."),We();return}if(e.tipo==="bus"){turf.distance(I,n,{units:"meters"})<300&&!ke&&(console.log("\xA1Alerta! Bajas pronto."),ke=!0,K.vibration&&navigator.vibrate&&navigator.vibrate([200,100,200]),Nt.textContent=`\xA1BAJA PRONTO! (${n.properties.nombre})`);try{let r=turf.nearestPointOnLine(a,I),s=turf.nearestPointOnLine(a,n),l=r.properties.location,p=s.properties.location;if((l-p)*1e3>o){console.log("Detecci\xF3n de Avance: El usuario pas\xF3 el punto de bajada. Avanzando..."),x===y.length-1||(console.log("Activando contador de transbordo..."),st(),K.vibration&&navigator.vibrate&&navigator.vibrate([200,100,200,100,200])),We();return}}catch(r){console.error("Error en l\xF3gica de proyecci\xF3n Turf:",r)}}}function We(){x<y.length-1&&(x++,re=!0,ke=!1,Rt(x),jt(x))}function sn(){x>0&&(x--,re=!0,ke=!1,Rt(x),jt(x))}function Rt(t){let e=y[t];Nt.textContent=e.texto,kt.disabled=t===0;let o=t===y.length-1;Se.disabled=o,Mt.style.display="block",o?Se.style.display="none":Se.style.display="block";let a=qt(e,I||w);re&&a&&a.isValid()?f.fitBounds(a.pad(.2)):re&&!a&&f.setView(f.getCenter(),17)}function cn(t){let e=Math.max(0,ue-t.distanciaRecorrida);e>1e3?wt.textContent=`Faltan: ${(e/1e3).toFixed(2)} km`:wt.textContent=`Faltan: ${e.toFixed(0)} m`;let o=5400;if(F.className="",t.enModoTransbordo&&!t.enMovimiento){let r=o-t.tiempoTotalViaje;if(r>0){let s=Math.floor(r/60),l=r%60;F.textContent=`Transbordo: ${s}:${l<10?"0":""}${l}`,F.classList.add("transbordo-timer")}else F.textContent="Tiempo Agotado",F.classList.add("advertencia")}else if(t.enMovimiento)F.textContent="En movimiento",F.classList.add("en-movimiento");else{let r=Math.floor(t.tiempoDetenido/60),s=t.tiempoDetenido%60;F.textContent=`Esperando: ${r}:${s<10?"0":""}${s}`,F.classList.add("advertencia")}let n=7200,a=Math.floor(t.tiempoTotalViaje/60),i=t.tiempoTotalViaje%60;Ve.textContent=`Viaje: ${a}:${i<10?"0":""}${i}`,t.tiempoTotalViaje>n?Ve.classList.add("advertencia"):Ve.classList.remove("advertencia")}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(t=>{console.log("Service Worker: Registrado exitosamente",t.scope)}).catch(t=>{console.log("Service Worker: Fall\xF3 el registro",t)})});function ln(t){let o=JSON.parse(localStorage.getItem("historialRutas"))||[];o=o.filter(a=>!(a.inicioId===t.inicioId&&a.finId===t.finId)),o.unshift(t);let n=o.slice(0,5);localStorage.setItem("historialRutas",JSON.stringify(n))}function Dt(){let t=JSON.parse(localStorage.getItem("historialRutas"))||[],e=JSON.parse(localStorage.getItem("favoritasRutas"))||[],o="";if(e.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px;">\u2B50\uFE0F Tus Favoritos:</p>',o+=e.map(n=>`
                <div class="opcion-ruta favorito-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir: ${n.inicioNombre} \u2192 ${n.finNombre}">
                    
                    <span class="delete-favorito" data-nombre="${n.nombre}" title="Borrar favorito">&times;</span>
                    
                    <h4 style="margin-bottom: 5px;">${n.nombre}</h4>
                    <small style="color: #555;">${n.inicioNombre} \u2192 ${n.finNombre}</small>
                </div>
            `).join("")),t.length>0&&(o+='<p style="font-weight: bold; margin-bottom: 10px; margin-top: 20px;">Tu historial reciente:</p>',o+=t.map(n=>`
                <div class="opcion-ruta historial-item" 
                     data-inicio-id="${n.inicioId}" 
                     data-fin-id="${n.finId}"
                     title="Repetir esta b\xFAsqueda">
                    <h4 style="margin-bottom: 5px;">${n.inicioNombre} \u2192 ${n.finNombre}</h4>
                    <small style="color: #555;">${n.rutaResumen||"Ruta de caminata"}</small>
                </div>
            `).join("")),o===""){q.innerHTML="<p>Selecciona tu destino para ver la ruta.</p>";return}q.innerHTML=o,document.querySelectorAll(".historial-item").forEach(n=>{n.addEventListener("click",yo)}),document.querySelectorAll(".favorito-item").forEach(n=>{n.addEventListener("click",yo)}),document.querySelectorAll(".delete-favorito").forEach(n=>{n.addEventListener("click",pn)})}async function yo(t){let e=t.currentTarget,o=e.dataset.inicioId,n=e.dataset.finId;if(!o||!n)return;console.log(`Cargando historial: Inicio ${o}, Fin ${n}`);let a=k.find(i=>i.properties.originalIndex==o);if(M=k.find(i=>i.properties.originalIndex==n),!a||!M){alert("Error: No se pudieron encontrar los paraderos de esta ruta guardada.");return}w=a,I=null,ee.style.display="none",_.style.display="block",Q.setChoiceByValue(o.toString()),T.setChoiceByValue(n.toString()),X=ye(w,M,k,A,me),Ze(X)}function dn(){let t=prompt("Dale un nombre a esta ruta (ej. Casa a Oficina):","");if(!(!t||t.trim()===""))try{let e={inicioId:w.properties.originalIndex,inicioNombre:w.properties.nombre,finId:M.properties.originalIndex,finNombre:M.properties.nombre,nombre:t.trim()};un(e)}catch(e){console.error("Error al guardar en favoritos:",e),alert("Error: No se pudo guardar el favorito.")}}function un(t){let e=JSON.parse(localStorage.getItem("favoritasRutas"))||[];e=e.filter(o=>o.nombre!==t.nombre),e.unshift(t),localStorage.setItem("favoritasRutas",JSON.stringify(e)),alert(`\xA1Ruta "${t.nombre}" guardada como favorita!`)}function pn(t){t.stopPropagation();let e=t.currentTarget.dataset.nombre;if(e&&confirm(`\xBFSeguro que quieres borrar el favorito "${e}"?`)){let o=JSON.parse(localStorage.getItem("favoritasRutas"))||[];o=o.filter(n=>n.nombre!==e),localStorage.setItem("favoritasRutas",JSON.stringify(o)),Dt()}}function mn(){if(!I){alert("No se ha podido detectar tu ubicaci\xF3n GPS. Mu\xE9vete a un lugar con mejor se\xF1al o reinicia la app.");return}console.log("Buscando paraderos cercanos..."),ce(),S.clearLayers(),G&&(G.clearInput(),G.removeActiveItems());let e=k.map(r=>{let s=turf.distance(I,r,{units:"meters"});return{paradero:r,distancia:s}}).sort((r,s)=>r.distancia-s.distancia).slice(0,5),o=[],n='<p><strong>Paraderos m\xE1s cercanos a ti:</strong></p><ol style="padding-left: 20px;">';e.forEach(r=>{let s=r.paradero.geometry.coordinates,l=[s[1],s[0]],p=r.paradero.properties.nombre,b=r.distancia.toFixed(0);n+=`<li style="margin-bottom: 5px;">${p} (aprox. ${b} m)</li>`;let d=L.divIcon({className:"icono-mapa-bus",html:'<i class="ri-bus-fill"></i>',iconSize:[24,24],iconAnchor:[12,12],popupAnchor:[0,-12]}),c=U(r.paradero),m=L.marker(l,{icon:d}).bindPopup(c);m.addTo(S),o.push(m)}),n+="</ol>",Ce.innerHTML=n;let a=se(I.geometry.coordinates.slice().reverse()),i=L.featureGroup([a,...o]);i.getBounds().isValid()&&f.fitBounds(i.getBounds().pad(.2)),et()}function fn(t){let e=t.target.dataset.paraderoId;if(!e)return;let o=k.find(r=>r.properties.originalIndex==e);if(!o)return;let a=(o.properties.rutas||[]).map(r=>A.find(s=>s.properties.id===r)).filter(Boolean),i=`<p>Mostrando rutas para:</p>
                <h4 style="margin-top:0;">${o.properties.nombre}</h4>`;a.length>0?(i+='<ul style="padding-left: 20px; margin-top: 10px;">',a.forEach(r=>{i+=`<li style="margin-bottom: 5px;">
                        <strong>${r.properties.id}</strong>
                        <small>(${r.properties.nombre})</small>
                    </li>`}),i+="</ul>"):i+="<p>No hay rutas registradas para este paradero.</p>",Ce.innerHTML=i,f.closePopup(),et()}function et(){V.classList.contains("oculto")&&V.classList.remove("oculto")}function Io(){if(y&&y.length>0&&x<y.length){let t=y[x];if(t.tipo==="bus")return t.ruta.properties.id}if(G&&G.getValue(!0))return G.getValue(!0);if(w&&D.classList.contains("oculto")){let t=w.properties.rutas||[];if(t.length>0)return t[0]}return null}async function gn(t){let e=Io();if(!e){alert("Por favor, inicia una navegaci\xF3n o selecciona una ruta en 'Explorar' para poder reportar un incidente sobre ella.");return}console.log(`Enviando reporte a Firebase: ${t} en ${e}`);try{await _o.collection("reportes_pendientes").add({tipo:t,rutaId:e,timestamp:firebase.firestore.FieldValue.serverTimestamp()}),alert(`\xA1Gracias! Tu reporte para la ruta ${e} ha sido enviado.`)}catch(o){console.error("Error al enviar reporte a Firebase:",o),alert("No se pudo enviar el reporte. Revisa tu conexi\xF3n a internet.")}}function Ot(){_e&&(_e(),_e=null,console.log("Escucha de buses en vivo DETENIDA.")),ot(),Je(null)}function Je(t){let e=document.getElementById("eta-info");if(!e)return;if(!t){e.style.display="none",e.innerHTML="";return}let o=`<strong>Pr\xF3ximo bus (Unidad ${t.id}):</strong>`;t.etaMinutos?o+=`<p>Llega a tu parada en aprox. <strong>${t.etaMinutos} min</strong>.</p>`:o+=`<p>Est\xE1 a <strong>${t.distanciaMetros.toFixed(0)} m</strong> de tu parada.</p>`,e.innerHTML=o,e.style.display="block"}function xo(t,e){if(!Pt){console.error("Firebase (Gesti\xF3n) no est\xE1 inicializado.");return}Ot();let o=Pt.collection("live_locations");t?(o=o.where("routeId","==",t),console.log(`Iniciando escucha de buses SOLO para la ruta: ${t}`)):console.log("Iniciando escucha de TODOS los buses (modo global)"),_e=o.onSnapshot(n=>{let a=[],i=A.find(r=>r.properties.id===t);if(n.docChanges().forEach(r=>{let s=r.doc.id,l=r.doc.data();if(r.type==="added"||r.type==="modified"){if(!l.lat||!l.lng||!l.routeId)return;if(zt(s,l.routeId,[l.lat,l.lng]),e&&i)try{let p=turf.point([l.lng,l.lat]),b=turf.nearestPointOnLine(i,p),d=turf.nearestPointOnLine(i,e.geometry.coordinates),c=b.properties.location;if(d.properties.location-c>.01){let g=turf.lineSlice(b,d,i),u=turf.length(g,{units:"meters"});a.push({id:s,distanciaMetros:u,speed:l.speed||0})}}catch(p){console.error("Error calculando ETA con Turf:",p)}}else r.type==="removed"&&Vt(s)}),a.length>0){a.sort((l,p)=>l.distanciaMetros-p.distanciaMetros);let r=a[0],s=null;r.speed>1&&(s=Math.round(r.distanciaMetros/r.speed/60)),Je({id:r.id,etaMinutos:s,distanciaMetros:r.distanciaMetros})}else e?(Je({id:"N/A",etaMinutos:null,distanciaMetros:999999}),document.getElementById("eta-info").innerHTML="<p>No hay buses de esta ruta aproxim\xE1ndose a tu parada.</p>"):Je(null)},n=>{console.error("Error en escucha de Firestore:",n)})}function jt(t){Ot();let e=y[t];if(e&&(e.tipo==="caminar"||e.tipo==="transbordo")){let o=y[t+1];if(o&&o.tipo==="bus"){let n=o.ruta.properties.id,a=o.paraderoInicio;console.log(`Buscando ETA para ${n} en ${a.properties.nombre}`),xo(n,a)}}}function hn(){let t={apiKey:"AIzaSyDcaVTGa3j1YZjbd1D52wNNc1qk7VnrorY",authDomain:"rutaskoox-gestion.firebaseapp.com",projectId:"rutaskoox-gestion",storageBucket:"rutaskoox-gestion.firebasestorage.app",messagingSenderId:"2555756265",appId:"1:2555756265:web:c6f7487ced40a4f6f87538",measurementId:"G-81656MC0ZC"};try{fo=firebase.initializeApp(t,"gestionApp"),Pt=fo.firestore(),console.log("Servicio de Gesti\xF3n Firebase inicializado.")}catch(e){console.error("Error inicializando Firebase Gesti\xF3n",e)}}var Po=[];async function Bt(t){let e=document.getElementById("btnBuscarLugar");if(e){var o=e.innerHTML;e.innerHTML='<i class="ri-loader-4-line ri-spin"></i>',e.disabled=!0}try{let n=await uo(t,100);n&&n.length>0?n.length===1?So(n[0]):bn(n):alert("No encontramos lugares con ese nombre en Campeche.")}catch(n){console.error(n),alert("Error de conexi\xF3n al buscar.")}finally{e&&(e.innerHTML=o,e.disabled=!1)}}function bn(t){let e=document.getElementById("panel-instrucciones");Po=t;let o=`
        <div class="info-seccion">
            <p style="margin-bottom:10px;">Encontramos <strong>${t.length}</strong> opciones:</p>
            <div class="lista-resultados" style="max-height: 60vh; overflow-y: auto; padding-bottom: 20px;">
    `;t.forEach((n,a)=>{o+=`
            <div class="opcion-ruta" onclick="window.app.seleccionarResultado(${a})" style="cursor:pointer; padding: 15px; margin-bottom: 10px;">
                <h4 style="margin:0 0 5px 0; font-size: 1em; color: var(--primary-color);">
                    <i class="ri-map-pin-line"></i> ${n.nombre}
                </h4>
                <small style="color: var(--text-color); opacity: 0.8; line-height: 1.2; display:block;">
                    ${n.direccion}
                </small>
            </div>
        `}),o+="</div></div>",e.innerHTML=o,et()}window.app=window.app||{};window.app.seleccionarResultado=t=>{let e=Po[t];e&&So(e)};function So(t){let e=document.getElementById("info-lugar-buscado");console.log("Procesando lugar:",t);let o=turf.point([t.lng,t.lat]),n=Qe(o);if(n){M=n,T&&T.setChoiceByValue(n.properties.originalIndex.toString());let a=document.getElementById("panel-instrucciones");a.innerHTML=`
            <div class="alerta-verde" style="text-align:left; margin-top:0;">
                <strong>\u2705 Destino Fijado:</strong><br>
                ${t.nombre}
                <hr style="margin:5px 0; border:0; border-top:1px solid rgba(0,0,0,0.1);">
                <small>Baja en paradero: <strong>${n.properties.nombre}</strong></small>
            </div>
            <p style="margin-top:10px; text-align:center;">Ahora selecciona tu punto de inicio o usa el GPS.</p>
        `;let i=L.marker([t.lat,t.lng],{icon:L.divIcon({className:"icono-destino-especial",html:'<i class="ri-map-pin-star-fill" style="color:#E91E63; font-size:30px; text-shadow: 0 2px 5px rgba(0,0,0,0.3);"></i>',iconSize:[30,30],iconAnchor:[15,30]})}).addTo(f).bindPopup(`<b>${t.nombre}</b>`).openPopup();f.setView([t.lat,t.lng],16),setTimeout(()=>f.removeLayer(i),8e3)}else alert("El lugar existe, pero est\xE1 muy lejos de cualquier ruta de transporte.")}function vn(){if(!T)return;let t=yt.map(n=>({value:"turismo_"+n.query,label:`\u{1F4F8} ${n.nombre}`,customProperties:{calle:"Sitio Tur\xEDstico",colonia:"Recomendado"}})),e='<div class="info-seccion"><h5>Sitios de Inter\xE9s</h5><div class="chips-scroll" style="flex-wrap:wrap;">';yt.forEach(n=>{e+=`<button class="chip" onclick="window.app.buscarTurismo('${n.query}')">
            <i class="${n.icono}"></i> ${n.nombre}
        </button>`}),e+="</div></div>";let o=document.getElementById("panel-instrucciones");o.innerHTML=e}window.app=window.app||{};window.app.buscarTurismo=t=>{Bt(t)};window.simularBus=function(){if(!y||y.length===0){alert("\u26A0\uFE0F Primero inicia una ruta de navegaci\xF3n (Pon inicio y destino).");return}let t=y.find(p=>p.tipo==="bus");if(!t){alert("\u{1F6B6} Tu ruta es solo de caminata. Elige un destino m\xE1s lejos para usar bus.");return}let e=t.ruta.properties.id;console.log(`\u{1F68C} Iniciando simulaci\xF3n para: ${e}`);let o=t.paraderoInicio.geometry.coordinates,n=o[1]-.006,a=o[0]-.006,i=L.divIcon({className:"bus-simulado",html:`
            <div style="
                background: #d32f2f; 
                border: 2px solid white; 
                color: white; 
                width: 44px; height: 44px; 
                border-radius: 50%; 
                display: flex; align-items: center; justify-content: center; 
                font-weight: bold; font-size: 10px;
                box-shadow: 0 4px 15px rgba(211, 47, 47, 0.5);
                animation: palpitar 1s infinite;
            ">
                TEST
            </div>
            <style>@keyframes palpitar { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }</style>
        `,iconSize:[44,44]}),r=L.marker([n,a],{icon:i}).addTo(f),s=3e3;alert(`\u{1F440} \xA1Mira el mapa! Un bus de prueba (${e}) se acerca a tu paradero.`);let l=setInterval(()=>{n+=15e-5,a+=15e-5,s-=50,r.setLatLng([n,a]);let p=document.getElementById("eta-info");p&&(p.style.display="block",p.innerHTML=`
                <div style="background:#e3f2fd; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #90caf9; display:flex; align-items:center; gap:10px;">
                    <div style="font-size:20px;">\u{1F68D}</div>
                    <div>
                        <strong style="color:#1565c0;">BUS DE PRUEBA</strong>
                        <div style="font-size:1.1em; font-weight:bold;">${Math.max(1,Math.ceil(s/500))} min</div>
                        <small style="color:#555;">A ${s} metros</small>
                    </div>
                </div>
            `),s<=100&&(clearInterval(l),alert("\u2705 \xA1El bus simulado lleg\xF3 al paradero!"),f.removeLayer(r),p&&(p.style.display="none"))},800)};})();
/*! Bundled license information:

@capacitor/core/dist/index.js:
  (*! Capacitor: https://capacitorjs.com/ - MIT License *)
*/
